(function(){var a={extend:function(c){for(var b in c){if(!c.hasOwnProperty(b)){continue}this[b]=c[b]}},localStorageKey:"QSTAGE_VF710",localStorageSubKey:"AUTO_SAVE",group:null,canvas:null,shapes:null,fps:20,sceneId:null};a.extend({play:function(e){var k=this;var b=document.body;var c=document.createElement("div");b.appendChild(c);if(e==null){var d=this.getQueryStringByName("id");if(d!=null){var h=document.createElement("div");h.setAttribute("style","font-size: 16px; color: #ff3300; ");h.textContent="Loading... Please Wait...";c.appendChild(h);this.loadFromServer(d,function(p){if(p!=null){console.log("loaded from server");k.sceneId=d;k.play(p)}else{console.log("nothing loaded from server")}c.removeChild(c.firstChild);h=null})}else{return;var i=this.loadFromCache();if(i!=null){console.log("loaded from cache");this.play(i)}}return}this.canvas=e.canvas;this.shapes=e.shapes;var m=this.getEnhancedBoundary(this.canvas.boundary);var j=c.createChildNS("svg",{width:m.width,height:m.height,style:"background-color: #EEEEEE"});var f=-this.canvas.position.x-m.left;var g=-this.canvas.position.y-m.top;this.group=j.createChildNS("g",{transform:" translate({0}, {1})".format(f,g)});if(this.shapes.length>0){this.renderShape(0)}if(this.sceneId!=null){var o=document.createElement("div");o.setAttribute("style","margin: 10px 0px");c.appendChild(o);var l="../";if(this.isLocal()){l+="index.html"}l+="#id="+this.sceneId;var n=document.createElement("a");n.setAttribute("href",l);n.setAttribute("target","_blank");n.textContent="[Modify This Scene]";o.appendChild(n)}},loadFromServer:function(g,f){var d=this;var c=new XMLHttpRequest();var b="http://stage.qlike.com/repository/?action=pull";var e="id="+g;c.onreadystatechange=function(){if(c.readyState==4){if(typeof f=="function"){if(c.status==200){try{var j=JSON.parse(c.responseText);if(j.payload.length>0){var i=j.payload[0].json_string;f(JSON.parse(i))}else{f(null)}}catch(h){console.log(c.responseText);f(null)}}else{f(null)}}}};c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.send(e)},loadFromCache:function(){if(!localStorage){console.log("local storage not supported");return null}var c=localStorage.getItem(this.localStorageKey);if(c!=null){try{var b=JSON.parse(c);if(!b.hasOwnProperty(this.localStorageSubKey)){return null}else{return b[this.localStorageSubKey]}}catch(d){console.log("error to parse json string");return null}}else{console.log("no content in local storage");return null}},renderShape:function(k){var j=this;var m=this.shapes[k];var o=this.group.createChildNS("g",{transform:this.getTransForm(m.position,m.rotation)});var l=this.getEnhancedBoundary(m.boundary);var p=m.properties;var i=null;switch(m.type){case ShapeTypes.Line:i=o.createChildNS("path",{d:this.getPathData(m.points,p.getByKey("closePath")),fill:"none",stroke:this.brushToRgba(p.getByKey("stroke")),"stroke-width":p.getByKey("stroke").width});break;case ShapeTypes.Rectangle:var n="";n+=this.buildPathCommand("M",[l.left,l.top]);n+=this.buildPathCommand("H",[l.right]);n+=this.buildPathCommand("V",[l.bottom]);n+=this.buildPathCommand("H",[l.left]);n+=this.buildPathCommand("Z");i=o.createChildNS("path",{fill:this.brushToRgba(p.getByKey("fill")),stroke:this.brushToRgba(p.getByKey("stroke")),"stroke-width":p.getByKey("stroke").width,d:n});break;case ShapeTypes.Ellipse:var h=l.cx;var g=l.cy;var e=l.rx;var b=l.ry;var f=0.5*e;var c=0.6*b;var n="";n+=this.buildPathCommand("M",[0+h,b+g]);n+=this.buildPathCommand("C",[f+h,b+g,e+h,c+g,e+h,0+g]);n+=this.buildPathCommand("C",[e+h,-c+g,f+h,-b+g,0+h,-b+g]);n+=this.buildPathCommand("C",[-f+h,-b+g,-e+h,-c+g,-e+h,0+g]);n+=this.buildPathCommand("C",[-e+h,c+g,-f+h,b+g,0+h,b+g]);n+=this.buildPathCommand("Z");i=o.createChildNS("path",{fill:this.brushToRgba(p.getByKey("fill")),stroke:this.brushToRgba(p.getByKey("stroke")),"stroke-width":p.getByKey("stroke").width,d:n});break;case ShapeTypes.Polygon:case ShapeTypes.Polyline:case ShapeTypes.Freeline:i=o.createChildNS("path",{d:this.getPathData(m.points,p.getByKey("closePath")),fill:p.getByKey("applyFill")?this.brushToRgba(p.getByKey("fill")):"none",stroke:this.brushToRgba(p.getByKey("stroke")),"stroke-width":p.getByKey("stroke").width});break;break;case ShapeTypes.Label:i=o.createChildNS("text",{fill:this.brushToRgba(p.getByKey("fill")),"class":"no-select",x:l.left,y:l.bottom,"font-size":l.height,textLength:l.width,lengthAdjust:p.getByKey("lengthAdjust")},p.getByKey("text"));break}i.setAttribute("stroke-linecap",p.getByKey("strokeLinecap"));i.setAttribute("stroke-linejoin",p.getByKey("strokeLinejoin"));i.setAttribute("fill","none");this.playStrokeAnimation(i,p.getByKey("strokeAnimation"),function(){var r=p.getByKey("applyFill");var q=p.getByKey("fillAnimation");var d=p.getByKey("fill");j.playFillAnimation(i,r,q,d,function(){k++;if(k<j.shapes.length){j.renderShape(k)}})})},playStrokeAnimation:function(c,g,h){var f=this;if(c.getTotalLength){var b=1;var d=c.getTotalLength();var e=function(){c.updateStyle("stroke-dasharray",d);c.updateStyle("stroke-dashoffset",d*b);if(b>0){b-=1/f.fps/g;setTimeout(e,1000/f.fps)}else{c.updateStyle("stroke-dasharray",null);c.updateStyle("stroke-dashoffset",null);if(typeof h=="function"){h()}}};e()}else{if(typeof h=="function"){h()}}},playFillAnimation:function(b,h,g,f,i){var d=this;if(h){var e=1;var c=function(){var j=f.opacity*(1-e);b.setAttribute("fill",d.brushToRgba({color:f.color,opacity:j}));if(e>0){e-=1/d.fps/g;setTimeout(c,1000/d.fps)}else{if(typeof i=="function"){i()}}};c()}else{if(typeof i=="function"){i()}}},getQueryStringByName:function(d,c){if(c==null){c=location.search}var b=c.match(new RegExp("[?&]"+d+"=([^&]+)","i"));if(b==null||b.length<1){return null}else{return b[1]}},getTransForm:function(b,c){var d="";d+=" translate({0}, {1})".format(b.x,b.y);if(c!=null&&c%360!=0){d+=" rotate({0}, {1}, {2})".format(c.angle,c.cx,c.cy)}return d},buildPathCommand:function(e,d){var f=e;if(d==null||d.length==0){f+=" "}else{if(d.length==1){f+="{0} ".format(d[0])}else{for(var c=0;c<d.length;c+=2){var b=d[c];var g=d[c+1];f+="{0},{1} ".format(b,g)}}}return f},getPathCommand:function(h,d){var g=null;var g=d==-1?h[0]:h[d];var f=g[0];var e=g[1];var j="";if(d==0){j+="M{0} {1}".format(f,e)}else{var c=null,i=null;if(g.length==4){i={x:g[2]+f,y:g[3]+e}}var b=d>0?d-1:h.length-1;if(h[b].length==4){c={x:-h[b][2]+h[b][0],y:-h[b][3]+h[b][1]}}if(i!=null){if(c!=null){j+=" C{0} {1}, {2} {3}, {4} {5}".format(c.x,c.y,i.x,i.y,f,e)}else{j+=" Q{0} {1}, {2} {3}".format(i.x,i.y,f,e)}}else{if(c!=null){j+=" Q{0} {1}, {2} {3}".format(c.x,c.y,f,e)}else{j+=" L{0} {1}".format(f,e)}}}return j},getPathData:function(c,e){var d="";for(var b=0;b<c.length;b++){d+=this.getPathCommand(c,b)}if(e){d+=this.getPathCommand(c,-1);d+=" Z"}return d},brushToRgba:function(c){var f=c.color.toLowerCase();var e=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(f&&e.test(f)){if(f.length===4){var g="#";for(var d=1;d<4;d+=1){g+=f.slice(d,d+1).concat(f.slice(d,d+1))}f=g}var b=[];for(var d=1;d<7;d+=2){b.push(parseInt("0x"+f.slice(d,d+2)))}return"RGBA("+b.join(",")+","+c.opacity+")"}else{return f}},getEnhancedBoundary:function(h){var g=h.left;var f=h.top;var d=h.right;var c=h.bottom;var e=d-g;var b=c-f;if(e<0){e*=-1;g=d;d=g+e}if(b<0){b*=-1;f=c;c=f+b}return{left:g,top:f,right:d,bottom:c,width:e,height:b,cx:g+e/2,cy:f+b/2,rx:e/2,ry:b/2}},isLocal:function(){var b=document.location.protocol;return b!="https:"&&b!="http:"}});window.Player=a}());var ShapeTypes={Other:0,Line:1,Rectangle:2,Ellipse:4,Polygon:8,Polyline:16,Freeline:32,Label:64};Array.prototype.getByKey=function(b){for(var a=0;a<this.length;a++){var c=this[a];if(c[0]==b){return c[1]}}return null};Element.prototype.createChildNS=function(a,g,e,f){var d="http://www.w3.org/2000/svg";var c=document.createElementNS(d,a);if(f&&this.hasChildNodes()){this.insertBefore(c,this.firstChild)}else{this.appendChild(c)}if(g){for(var b in g){c.setAttribute(b,g[b])}}if(e){c.textContent=e}return c};Element.prototype.updateStyle=function(c,f){var a=this.getAttribute("style");var h=false;var e="";if(a!=null&&a.trim().length>0){var g=a.split(";");for(var b=0;b<g.length&&g[b].trim().length>0;b++){var d=g[b].split(":");if(d.length!=2){continue}if(c==d[0].trim()){h=true;if(f!=null){e+=c+": "+f+"; "}else{}}else{e+=d[0].trim()+": "+d[1].trim()+"; "}}}if(!h){e+=c+": "+f+"; "}this.setAttribute("style",e)};String.prototype.format=function(){var a=arguments;return this.replace(/\{(\d+)\}/g,function(b,c){return a[c]})};