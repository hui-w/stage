function AnchorPoint(b,a,d,c){this.parent=b;this.svgGroup=null;this.x=a;this.y=d;this.selected=false;this.captured=false;this.highlighted=false;this.savedPosition={x:a,y:d};this.shapeSize=Config.AnchorPoint.width;this.shapeElement=null;this.ghostSize=Config.AnchorPoint.width*4;this.ghostElement=null;this.bezierFirstCtrl=null;this.bezierLastCtrl=null;if(c!=null){this.bezierFirstCtrl=null;this.bezierLastCtrl=null;this.addBezierCtrl(c.x,c.y,false)}this.onAnchorChanged=null;this.selectingCtrl=null}AnchorPoint.prototype={render:function(){if(!this.hasUI()){return}var b=this;var a="translate({0},{1})".format(this.x,this.y);this.svgGroup=this.parent.svgGroup.createChildNS("g",{"data-label":"Anchor Point Group",transform:a});this.shapeElement=this.svgGroup.createChildNS("circle",{x:-this.shapeSize/2,y:-this.shapeSize/2,r:this.shapeSize/2,fill:Config.AnchorPoint.fill,stroke:Config.AnchorPoint.stroke,"stroke-width":Config.AnchorPoint.strokeWidth});this.ghostElement=this.svgGroup.createChildNS("rect",{x:-this.ghostSize/2,y:-this.ghostSize/2,width:this.ghostSize,height:this.ghostSize,fill:"RGBA(255, 255, 255, 0)",stroke:"none"});workspace.getEventManager(this.ghostElement).addListener("capture",function(d,c){b.savedPosition={x:b.x,y:b.y};if(workspace.painting.toolType==ToolTypes.Picker){b.setCaptured(true)}else{if(workspace.painting.toolType==ToolTypes.Pen){b.parent.selectingPoint=b}}}).addListener("release",function(d,c){if(workspace.painting.toolType==ToolTypes.Picker){b.setCaptured(false)}else{if(workspace.painting.toolType==ToolTypes.Pen){}}}).addListener("drag",function(g,c){var i=b.parent.transFrame;var d=i.getMappedOffset(c.begin,c.current);if(workspace.painting.toolType==ToolTypes.Picker){var h=QStage.alignToGrid(b.savedPosition.x+d.x);var f=QStage.alignToGrid(b.savedPosition.y+d.y);b.movePointTo(h,f,true,true)}else{if(workspace.painting.toolType==ToolTypes.Pen){}}}).addListener("doubleTap",function(d,c){b.captureOnSelected(d)});if(this.bezierFirstCtrl!=null){this.bezierFirstCtrl.render();this.bezierFirstCtrl.setDisplay(false)}if(this.bezierLastCtrl!=null){this.bezierLastCtrl.render();this.bezierLastCtrl.setDisplay(false)}},hasUI:function(){return this.parent.getType()!=ShapeTypes.Freeline&&this.parent.getType()!=ShapeTypes.Rectangle&&this.parent.getType()!=ShapeTypes.Ellipse},getIndex:function(){for(var a=0;a<this.parent.anchorPoints.length;a++){if(this.parent.anchorPoints[a]==this){return a}}return -1},getBezierCtrl:function(a){var b=a?this.bezierFirstCtrl:this.bezierLastCtrl;if(b!=null){return{x:b.x+this.x,y:b.y+this.y,}}else{return null}},hasBezierCtrl:function(){var a=this.bezierFirstCtrl!=null||this.bezierLastCtrl!=null;return a},addBezierCtrl:function(b,d,a){var c=this;this.bezierFirstCtrl=new BezierController(this,b,d);this.bezierFirstCtrl.onControllerChanged=function(){if(typeof c.onAnchorChanged=="function"){c.onAnchorChanged(false)}};this.bezierLastCtrl=new BezierController(c,-b,-d);this.bezierLastCtrl.onControllerChanged=function(){if(typeof c.onAnchorChanged=="function"){c.onAnchorChanged(false)}};if(a){this.bezierFirstCtrl.render();this.bezierLastCtrl.render()}},deleteBezierCtrl:function(){this.bezierFirstCtrl.destroy();this.bezierLastCtrl.destroy();this.bezierFirstCtrl=null;this.bezierLastCtrl=null;if(typeof this.onAnchorChanged=="function"){this.onAnchorChanged(false)}},prepareBezierCtrl:function(a){if(this.bezierFirstCtrl==null){this.addBezierCtrl(0,0,true);this.bezierLastCtrl.setCaptured(true)}else{if(this.bezierLastCtrl.captured){var c=QStage.alignToGrid(a.x);var b=QStage.alignToGrid(a.y);this.bezierLastCtrl.moveControllerTo(c,b,false)}}},isFirst:function(){return this.parent.anchorPoints[0]==this},isLast:function(){return this.parent.anchorPoints[this.parent.anchorPoints.length-1]==this},getNext:function(){if(this.parent.anchorPoints.length<2){return null}if(this.isLast()){return this.parent.anchorPoints[0]}else{return this.parent.anchorPoints[this.getIndex()+1]}},getPrevious:function(){if(this.parent.anchorPoints.length<2){return null}if(this.isFirst()){return this.parent.anchorPoints[this.parent.anchorPoints.length-1]}else{return this.parent.anchorPoints[this.getIndex()-1]}},tipPointCapture:function(d){if(!Config.General.anchorTipNofified){Config.General.anchorTipNofified=true;var f=[];f.push("Double tapping on a point will:");f.push("a) delete the Bezier control points if it has");f.push("b) delete itself if it has no Bezier control points");var a=workspace.drawingBoard.transformPoint({x:d.pageX+50,y:d.pageY+50});var c=workspace.drawingBoard.upperGroup.createChildNS("g",{"class":"no-select"});for(var b=0;b<f.length;b++){c.createChildNS("text",{x:a.x,y:a.y+b*14,fill:"#666666","font-size":"12px"},f[b])}setTimeout(function(){c.parentNode.removeChild(c);c=null},10000)}return true},destroy:function(){this.svgGroup.parentNode.removeChild(this.svgGroup);this.svgGroup=null},movePoint:function(c,a,b,d){this.x+=c;this.y+=a;this.movePointTo(this.x,this.y,b,d)},movePointTo:function(a,d,b,c){this.x=a;this.y=d;if(this.hasUI()){this.svgGroup.setAttribute("transform","translate({0},{1})".format(this.x,this.y))}if(c&&typeof this.onAnchorChanged=="function"){this.onAnchorChanged(b)}},setDisplay:function(a){if(!this.hasUI()){return}this.svgGroup.updateStyle("display",a?"block":"none")},showBezierControllers:function(a){if(this.bezierFirstCtrl!=null){this.bezierFirstCtrl.setDisplay(a);this.bezierLastCtrl.setDisplay(a)}},setCaptured:function(a){if(!this.hasUI()){return}if(a&&!this.captured){workspace.painting.selectingShape=this.parent;this.shapeElement.setAttribute("fill",Config.AnchorPoint.capturedFill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.capturedStroke);this.highlightOthers(true)}else{if(!a&&this.captured){this.shapeElement.setAttribute("fill",Config.AnchorPoint.fill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.stroke);this.highlightOthers(false)}}this.ghostElement.updateStyle("cursor",a?"crosshair":"default");this.captured=a},setHighlighted:function(a){if(!this.hasUI()){return}if(a&&!this.highlighted){this.shapeElement.setAttribute("fill",Config.AnchorPoint.highlightedFill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.highlightedStroke)}else{if(!a&&this.highlighted){this.shapeElement.setAttribute("fill",Config.AnchorPoint.fill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.stroke)}}this.highlighted=a},highlightOthers:function(c){if(!this.hasUI()){return}for(var b=0;b<this.parent.anchorPoints.length;b++){var a=this.parent.anchorPoints[b];if(a!=this){a.setHighlighted(c)}}},setSelected:function(a){if(!this.selected&&a){this.shapeElement.setAttribute("fill",Config.AnchorPoint.selectedFill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.selectedStroke);if(this.hasBezierCtrl()){this.bezierFirstCtrl.setDisplay(true);this.bezierLastCtrl.setDisplay(true)}var b=this.getNext();if(b!=null){b.shapeElement.setAttribute("fill",Config.AnchorPoint.followingFill);b.shapeElement.setAttribute("stroke",Config.AnchorPoint.followingStroke)}}else{if(this.selected&&!a){this.shapeElement.setAttribute("fill",Config.AnchorPoint.fill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.stroke);if(this.hasBezierCtrl()){this.bezierFirstCtrl.setDisplay(false);this.bezierLastCtrl.setDisplay(false)}var b=this.getNext();if(b!=null){b.shapeElement.setAttribute("fill",Config.AnchorPoint.fill);b.shapeElement.setAttribute("stroke",Config.AnchorPoint.stroke)}}}this.selected=a},captureOnSelected:function(a){if(this.hasBezierCtrl()){this.tipPointCapture(a);this.deleteBezierCtrl()}else{this.tipPointCapture(a);this.parent.deletePoint(this)}}};function BezierController(b,a,c){this.parent=b;this.svgGroup=null;this.x=a;this.y=c;this.captured=false;this.savedPosition={x:a,y:c};this.shapeSize=Config.BezierController.size;this.shapeElement=null;this.ghostSize=Config.BezierController.size*4;this.ghostElement=null;this.line=null;this.onControllerChanged=null}BezierController.prototype={render:function(){var b=this;var a="translate({0},{1})".format(this.x,this.y);this.svgGroup=this.parent.svgGroup.createChildNS("g",{"data-label":"Bezier Control Point Group",transform:a},null,true);this.shapeElement=this.svgGroup.createChildNS("circle",{cx:0,cy:0,r:this.shapeSize/2,fill:Config.BezierController.fill,stroke:Config.BezierController.stroke,"stroke-width":Config.BezierController.strokeWidth});this.ghostElement=this.svgGroup.createChildNS("rect",{x:-this.ghostSize/2,y:-this.ghostSize/2,width:this.ghostSize,height:this.ghostSize,fill:"RGBA(255, 255, 255, 0)",stroke:"none"});this.line=this.svgGroup.createChildNS("line",{x1:0,y1:0,x2:-this.x,y2:-this.y,fill:"none",stroke:"RGBA(127,127,127,0.5)","stroke-width":1,"stroke-dasharray":"4,4"});workspace.getEventManager(this.ghostElement).addListener("capture",function(g,f){if(workspace.painting.toolType==ToolTypes.Pen){b.setCaptured(true);b.savedPosition={x:b.x,y:b.y};var c=b.parent;var d=c.parent;d.selectingPoint=c;c.selectingCtrl=b}}).addListener("release",function(d,c){if(workspace.painting.toolType==ToolTypes.Pen){b.setCaptured(false)}}).addListener("drag",function(g,f){if(workspace.painting.toolType==ToolTypes.Pen){var i=b.parent.parent.transFrame;var h=i.getMappedOffset(f.begin,f.current);var c=QStage.alignToGrid(b.savedPosition.x+h.x);var j=QStage.alignToGrid(b.savedPosition.y+h.y);b.moveControllerTo(c,j,false)}})},moveControllerTo:function(a,d,b){this.x=a;this.y=d;this.svgGroup.setAttribute("transform","translate({0},{1})".format(this.x,this.y));this.line.setAttribute("x1",0);this.line.setAttribute("y1",0);this.line.setAttribute("x2",-this.x);this.line.setAttribute("y2",-this.y);if(!b){var c=this.getPeer();if(c!=null){c.moveControllerTo(-a,-d,true)}}if(typeof this.onControllerChanged=="function"){this.onControllerChanged()}},setDisplay:function(a){this.svgGroup.updateStyle("display",a?"block":"none")},setCaptured:function(a){this.captured=a;if(a){this.shapeElement.setAttribute("fill",Config.BezierController.capturedFill);this.shapeElement.setAttribute("stroke",Config.BezierController.capturedStroke);this.getPeer().setHighlighted(true)}else{this.shapeElement.setAttribute("fill",Config.BezierController.fill);this.shapeElement.setAttribute("stroke",Config.BezierController.stroke);this.getPeer().setHighlighted(false)}this.ghostElement.updateStyle("cursor",a?"crosshair":"default")},setHighlighted:function(a){if(a){this.shapeElement.setAttribute("fill",Config.BezierController.highlightedFill);this.shapeElement.setAttribute("stroke",Config.BezierController.highlightedStroke)}else{this.shapeElement.setAttribute("fill",Config.BezierController.fill);this.shapeElement.setAttribute("stroke",Config.BezierController.stroke)}},getPeer:function(){if(this.parent.bezierFirstCtrl==this){return this.parent.bezierLastCtrl}else{return this.parent.bezierFirstCtrl}},destroy:function(){this.svgGroup.parentNode.removeChild(this.svgGroup);this.svgGroup=null},};function CanvasFrame(a){this.parent=a;this.svgGroup=null;this.transFrame=null;this.renderred=false}CanvasFrame.prototype={resize:function(b,a){if(!this.renderred){this.render(b,a);this.renderred=true}},render:function(b,e){var d=this;var g=Config.CanvasFrame.marginLeft;var f=Config.CanvasFrame.marginTop;var c=b-Config.CanvasFrame.marginLeft-Config.CanvasFrame.marginRight;var a=e-Config.CanvasFrame.marginTop-Config.CanvasFrame.marginBottom;this.svgGroup=this.parent.createChildNS("g",{"data-label":"Group of CanvasFrame"});var h={position:{x:g,y:f},boundary:{left:0,top:0,right:c,bottom:a},rotation:{cx:0,cy:0,angle:0}};this.transFrame=new TransformableFrame(this.svgGroup,h,true);this.transFrame.setProperty("rotatable",false);this.shapeElement=this.svgGroup.createChildNS("rect",{"data-label":"CanvasFrame",x:g,y:f,width:c,height:a,fill:Config.General.drawingBackground,stroke:Config.CanvasFrame.borderColor,"stroke-width":1,"stroke-dasharray":Config.CanvasFrame.borderDashArray});this.transFrame.addEventListener("boundarychange",function(i){var j=QStage.enhanceBoundary(i.newBoundary,true);d.shapeElement.setAttribute("x",j.left-0.5);d.shapeElement.setAttribute("y",j.top-0.5);d.shapeElement.setAttribute("width",j.width+1);d.shapeElement.setAttribute("height",j.height+1);workspace.autoSave()});this.transFrame.addEventListener("positionchange",function(i){workspace.autoSave()});this.transFrame.render();workspace.getEventManager(this.shapeElement).addListener("capture",function(j,i){if(d.transFrame.enabled){d.transFrame.captureHandle(2,0,true)}}).addListener("release",function(j,i){if(d.transFrame.enabled){d.transFrame.captureHandle(2,0,false)}}).addListener("drag",function(k,j){if(d.transFrame.enabled){var i=QStage.alignToGrid(d.transFrame.savedStatus.position.x+j.begin.dx);var l=QStage.alignToGrid(d.transFrame.savedStatus.position.y+j.begin.dy);d.transFrame.moveTo(i,l,true)}});this.setEnabled(false)},reset:function(b,d){var f=Config.CanvasFrame.marginLeft;var e=Config.CanvasFrame.marginTop;var c=b-Config.CanvasFrame.marginLeft-Config.CanvasFrame.marginRight;var a=d-Config.CanvasFrame.marginTop-Config.CanvasFrame.marginBottom;this.transFrame.moveTo(f,e,true);this.transFrame.transformTo(0,0,c,a,true)},setEnabled:function(a){this.transFrame.setEnabled(a)}};var ShapeTypes={Other:0,Line:1,Rectangle:2,Ellipse:4,Polygon:8,Polyline:16,Freeline:32,Label:64};var ToolTypes={None:0,Picker:1,Move:2,Crop:4,Line:8,Rectangle:16,Ellipse:32,Polygon:64,Pencil:128,Pen:256,Label:512,Map:1024,Poi:2048,Block:4096,Eraser:8192};var SerializeType={TypeOnly:1,Abstract:2,JSON:4,SVG:8,Canvas:16};function clone(c){if(typeof c=="function"||Object(c)!==c){return c}var b=new c.constructor;for(var a in c){if(c.hasOwnProperty(a)){b[a]=clone(c[a])}}return b}function getType(a){if(a==null){return"null"}var b=typeof a;if(b!="object"){return b}var d=Object.prototype.toString.apply(a);d=d.substring(8,d.length-1);if(d!="Object"){return d}if(a.constructor==Object){return d}if("classname" in a.prototype.constructor&&typeof a.prototype.constructor.classname=="string"){return a.constructor.prototype.classname}return"<unknown type>"}function isRefType(b){var a=getType(b);return a=="Object"||a=="Array"}(function(){var a={extend:function(c){for(var b in c){if(!c.hasOwnProperty(b)){continue}this[b]=c[b]}}};a.extend({$:function(){var d=new Array();for(var c=0;c<arguments.length;c++){var b=arguments[c];if(typeof b=="string"){b=document.getElementById(b)}if(arguments.length==1){return b}d.push(b)}return d},rand:function(b,c){return Math.floor(Math.random()*(c-b+1))+b},round:function(b){return b},buildPathCommand:function(e,d){var f=e;if(d==null||d.length==0){f+=" "}else{if(d.length==1){f+="{0} ".format(d[0])}else{for(var c=0;c<d.length;c+=2){var b=d[c];var g=d[c+1];f+="{0},{1} ".format(b,g)}}}return f},getQueryStringByName:function(d,c){if(c==null){c=location.search}var b=c.match(new RegExp("[?&]"+d+"=([^&]+)","i"));if(b==null||b.length<1){return null}else{return b[1]}},setUrlHash:function(c,e){var f=window.location.hash;if(f.length<=0){window.location.hash=c+"="+e}else{var d=c+"=([^&]+)";if(e==null){window.location.hash=f.replace(new RegExp(d,"i"),"");return}var b=f.match(new RegExp(d,"i"));if(b==null||b.length<1){window.location.hash+="&"+c+"="+e}else{window.location.hash=f.replace(new RegExp(d,"i"),c+"="+e)}}},getUrlHash:function(d,c){if(c==null){c=window.location.hash}var b=c.match(new RegExp("[#&]"+d+"=([^&]+)","i"));if(b==null||b.length<1){return null}else{return b[1]}},alignToGrid:function(b){if(Config.General.snapToGrid){return Math.round(b/Config.General.gridSize)*Config.General.gridSize}else{return b}},brushToRgba:function(b){return b.color.toColorRgba(b.opacity)},enhanceBoundary:function(i,f){var h=i.left;var g=i.top;var d=i.right;var c=i.bottom;var e=d-h;var b=c-g;if(f&&e<0){e*=-1;h=d;d=h+e}if(f&&b<0){b*=-1;g=c;c=g+b}return{left:h,top:g,right:d,bottom:c,width:e,height:b,cx:h+e/2,cy:g+b/2,rx:e/2,ry:b/2}},supportsTransitions:function(){var c=document.body||document.documentElement,g=c.style,j="transition",h={Webkit:"webkitTransitionEnd",Moz:"transitionend",O:"oTransitionEnd otransitionend",ms:"MSTransitionEnd","default":"transitionend"},d=["Moz","Webkit","O","ms"];if(typeof g[j]=="string"){return{prefixedProperty:j,prefixedEventName:h["default"]}}j=j.charAt(0).toUpperCase()+j.substr(1);for(var f=0;f<d.length;f++){if(typeof g[d[f]+j]=="string"){return{prefixedProperty:"-"+d[f].toLowerCase()+"-"+j.toLowerCase(),prefixedEventName:h[d[f]]}}}return false},isLocal:function(){var b=document.location.protocol;return b!="https:"&&b!="http:"},getAppUrl:function(){var b="./";if(a.isLocal()){b+="index.html"}return b},isValidId:function(b){return b!=null&&b.length==32},sendPostRequest:function(c,f,e,b){var d=new XMLHttpRequest();d.onreadystatechange=function(){if(d.readyState==4){if(d.status==200){if(typeof e=="function"){e(d.responseText)}}else{if(typeof b=="function"){b(d.status)}}}};d.open("POST",c,true);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.send(f)}});window.QStage=a}());String.prototype.format=function(){var a=arguments;return this.replace(/\{(\d+)\}/g,function(b,c){return a[c]})};String.prototype.trim=function(){return this.replace(/^(\s|\u00A0)+/,"").replace(/(\s|\u00A0)+$/,"")};Array.prototype.forEach=function(c){for(var a=0;a<this.length;a++){var b=this[a];if(typeof c=="function"){c.call(this,b)}}};Date.prototype.Format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)))}}return a};Element.prototype.attr=function(h,g){if(!h){if(this.nodeType!=1){return{text:this.nodeValue}}var a=this.attributes,c={};for(var e=0,f=a.length;e<f;e++){c[a[e].nodeName]=a[e].nodeValue}return c}if(Util.is(h,"string")){if(arguments.length>1){var d={};d[h]=g;h=d}else{return this.getAttribute(h)}}for(var b in h){if(h.hasOwnProperty(b)){this.setAttribute(b,h[b])}}return this};Element.prototype.createChildNS=function(a,g,e,f){var d="http://www.w3.org/2000/svg";var c=document.createElementNS(d,a);if(f&&this.hasChildNodes()){this.insertBefore(c,this.firstChild)}else{this.appendChild(c)}if(g){for(var b in g){c.setAttribute(b,g[b])}}if(e){c.textContent=e}return c};Element.prototype.createChild=function(a,f,d,e){var c=document.createElement(a);if(e&&this.hasChildNodes()){this.insertBefore(c,this.firstChild)}else{this.appendChild(c)}if(f){for(var b in f){c.setAttribute(b,f[b])}}if(d){c.textContent=d}return c};Element.prototype.hasClassName=function(b){return new RegExp("(?:^|\\s+)"+b+"(?:\\s+|$)").test(this.className)};Element.prototype.addClassName=function(b){if(!this.hasClassName(b)){this.className=[this.className,b].join(" ")}};Element.prototype.removeClassName=function(c){if(this.hasClassName(c)){var d=this.className;this.className=d.replace(new RegExp("(?:^|\\s+)"+c+"(?:\\s+|$)","g")," ")}};Element.prototype.getStyle=function(b){var c=this.getAttribute("style");if(c!=null&&c.trim().length>0){var e=c.split(";");for(var a=0;a<e.length&&e[a].trim().length>0;a++){var d=e[a].split(":");if(d.length!=2){continue}if(b==d[0].trim()){return d[1].trim()}}}return null};Element.prototype.updateStyle=function(c,f){var a=this.getAttribute("style");var h=false;var e="";if(a!=null&&a.trim().length>0){var g=a.split(";");for(var b=0;b<g.length&&g[b].trim().length>0;b++){var d=g[b].split(":");if(d.length!=2){continue}if(c==d[0].trim()){h=true;if(f!=null){e+=c+": "+f+"; "}else{}}else{e+=d[0].trim()+": "+d[1].trim()+"; "}}}if(!h){e+=c+": "+f+"; "}this.setAttribute("style",e)};String.prototype.isRGBCode=function(c){var b=this.toLowerCase();var a=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;return(b&&a.test(b))};String.prototype.toColorRgba=function(e){var d=this.toLowerCase();var c=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(d&&c.test(d)){if(d.length===4){var f="#";for(var b=1;b<4;b+=1){f+=d.slice(b,b+1).concat(d.slice(b,b+1))}d=f}var a=[];for(var b=1;b<7;b+=2){a.push(parseInt("0x"+d.slice(b,b+2)))}return"RGBA("+a.join(",")+","+e+")"}else{return d}};String.prototype.toColorHex=function(){var b=this.replace(/rgba|RGBA|\(|\)/g,"").split(",");if(b.length!=4){return{color:"#000000",opacity:0}}else{var a="#";for(var d=0;d<3;d++){var e=Number(b[d]).toString(16);if(Number(b[d])<16){e="0"+e}a+=e}var c=b[3];return{color:a,opacity:c}}};var canvasPrototype=window.CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype;canvasPrototype.antiFuzzyLine=function(b,d,a,c){if(this.lineWidth==1){b+=0.5;d+=0.5;a+=0.5;c+=0.5}this.moveTo(b,d);this.lineTo(a,c)};canvasPrototype.fillTextWithRotate=function(d,a,f,c,b,e){this.save();this.translate(a,f);this.rotate(c);this.fillTextEx(d,0,0,b,e);this.restore()};canvasPrototype.fillTextEx=function(e,b,g,c,f){this.save();var a=b;if(c!="left"){var d=this.measureText(e).width;if(c=="center"){a-=d/2}else{if(c=="right"){a-=d}}}this.textBaseline=f;this.fillText(e,a,g);this.restore()};(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.prototype.constructor=c;c.extend=arguments.callee;return c}})();function Icon(a,b){this.stage=a;this.id=b;this.size=a.width+a.height;this.stageManaged=false;this.position={x:a.width/2,y:a.height/2,angle:0};console.log(this.position.x);this.samplePosition={x:0,y:0};this.speed={x:0,y:0,angle:0};this.angle=0;this.group=null;this.ghost=null;this.blocks=[];this.config={finalSize:60,fadeInDelay:20,sampleSpeedDelay:20,airRate:0.99,otherCollisionRate:0.9,boundaryCollisionRate:0.9,gravityIncrease:1};this.interval=null;this.timer=null;this.render();this.fadeIn()}Icon.prototype={render:function(){this.group=this.stage.group.createChildNS("g",{"data-label":"Animation Icon",transform:"translate({0},{1})".format(this.position.x-this.size/2,this.position.y-this.size/2)});var b=this.getBlockPath();var a=this.getBlockPadding();this.blocks[0]=this.group.createChildNS("path",{fill:"#22CB20",stroke:"#22CB20","stroke-width":a,"stroke-linejoin":"round",d:b});this.blocks[1]=this.group.createChildNS("path",{fill:"#06ACD4",stroke:"#06ACD4","stroke-width":a,"stroke-linejoin":"round",d:b,transform:this.getBlockTransform(1)});this.blocks[2]=this.group.createChildNS("path",{fill:"#FFCC00",stroke:"#FFCC00","stroke-width":a,"stroke-linejoin":"round",d:b,transform:this.getBlockTransform(2)});this.blocks[3]=this.group.createChildNS("path",{fill:"#FA5151",stroke:"#FA5151","stroke-width":a,"stroke-linejoin":"round",d:b,transform:this.getBlockTransform(3)});this.ghost=this.group.createChildNS("rect",{x:0,y:0,width:this.size,height:this.size,fill:"RGBA(255,255,255,0)",stroke:"none",style:"cursor: pointer"});this.attachEventHandlers()},attachEventHandlers:function(){var a=this;workspace.getEventManager(this.ghost).addListener("capture",function(c,b){a.stageManaged=false;a.samplePosition={x:a.position.x,y:a.position.y};a.startInterval(function(){console.log("Sampling Speed Interval");a.speed={x:(a.position.x-a.samplePosition.x)*a.stage.config.intervalDelay/a.config.sampleSpeedDelay,y:(a.position.y-a.samplePosition.y)*a.stage.config.intervalDelay/a.config.sampleSpeedDelay,angle:0};a.samplePosition={x:a.position.x,y:a.position.y}},a.config.sampleSpeedDelay)}).addListener("drag",function(c,b){a.moveIcon(b.previous.dx,b.previous.dy,0,null,true)}).addListener("release",function(c,b){a.stageManaged=true;a.stopInterval();a.ensurePositionAvailablity()})},startInterval:function(b,a){this.stopInterval();this.interval=setInterval(b,a)},stopInterval:function(){if(this.interval!=null){clearInterval(this.interval);this.interval=null}},ensurePositionAvailablity:function(){var d=this.position.x;var c=this.position.y;var b=0;while(!this.isAvailablePosition(d,c)){b++;var a=Math.ceil(b/4)*this.size;switch(b%4){case 0:d=this.position.x+a;c=this.position.y;break;case 1:d=this.position.x;c=this.position.y+a;break;case 2:d=this.position.x-a;c=this.position.y;break;case 3:d=this.position.x;c=this.position.y-a;break}}if(this.position.x!=d||this.position.y!=c){this.position.x=d;this.position.y=c;this.updateGroupTransform()}},getThreateningIcons:function(){var c=[];for(var b=0;b<this.stage.icons.length;b++){var a=this.stage.icons[b];if(this==a||!a.stageManaged){continue}c.push(a)}return c},isOverlappedWith:function(a,d,b){var c=Math.sqrt(Math.pow(a-b.position.x,2)+Math.pow(d-b.position.y,2));return c<this.size},isAvailablePosition:function(b,e){if(b-this.size/2<this.stage.boundary.left||b+this.size/2>this.stage.boundary.right||e-this.size/2<this.stage.boundary.top||e+this.size/2>this.stage.boundary.bottom){return}var d=this.getThreateningIcons();for(var c=0;c<d.length;c++){var a=d[c];if(this.isOverlappedWith(b,e,a)){return false}}return true},getBlockPath:function(){var a=this.size;var c=this.getBlockPadding();var b="M{0},{1} H{2} L {3},{4} H {0} Z".format(a/3+c,c,a*2/3,a-c,a/3-c);return b},getBlockPadding:function(){return this.size*10/300},getBlockTransform:function(a){var b=this.size;return"translate(0,0), rotate({1},{0},{0})".format(b/2,a*90)},fadeIn:function(){var b=this;function a(){console.log("Fade In Timer");if(b.size<=b.config.finalSize){b.size=b.config.finalSize;b.stageManaged=true;b.ensurePositionAvailablity()}else{b.resizeTo(b.size*0.95);b.timer=setTimeout(a,b.config.fadeInDelay)}}this.timer=setTimeout(a,this.config.fadeInDelay)},resizeTo:function(b){this.size=b;for(var a=0;a<this.blocks.length;a++){this.blocks[a].setAttribute("d",this.getBlockPath());this.blocks[a].setAttribute("stroke-width",this.getBlockPadding());this.blocks[a].setAttribute("transform",this.getBlockTransform(a))}this.updateGroupTransform();this.ghost.setAttribute("width",this.size);this.ghost.setAttribute("height",this.size)},updateGroupTransform:function(){this.group.setAttribute("transform","translate({0},{1}) rotate({2},{3},{3})".format(this.position.x-this.size/2,this.position.y-this.size/2,this.position.angle,this.size/2))},landed:function(){return this.speed.x==0&&this.speed.y==0&&this.speed.angle==0&&this.position.y==this.stage.boundary.bottom-this.size/2},moveIcon:function(l,k,j,e,a){if(e==null){e=this.getNextStepStatus(l,k)}var d={dx:l,dy:k,dAngle:j};var g=this.size/2;if(e.collideTop){this.position.y=this.stage.boundary.top+g;d.dy=this.stage.boundary.top+g-this.position.y}else{if(e.collideBottom){this.position.y=this.stage.boundary.bottom-g;d.dy=this.stage.boundary.bottom-g-this.position.y}}if(e.collideLeft){this.position.x=this.stage.boundary.left+g;d.dx=this.stage.boundary.left+g-this.position.x}else{if(e.collideRight){this.position.x=this.stage.boundary.right-g;d.dx=this.stage.boundary.right-g-this.position.x}}if(e.collideObjects.length>0&&this.stageManaged&&!a){for(var f=0;f<e.collideObjects.length;f++){var h=e.collideObjects[f];var c=Math.abs(this.speed.x)+Math.abs(h.speed.x)*this.config.otherCollisionRate;var b=Math.abs(this.speed.y)+Math.abs(h.speed.y)*this.config.otherCollisionRate;this.speed.x=(this.speed.x>0?-1:1)*c/2;this.speed.y=(this.speed.y>0?-1:1)*b/2;h.speed.x=-this.speed.x;h.speed.y=-this.speed.y;d.dx=0;d.dy=0}}this.position.x+=d.dx;this.position.y+=d.dy;this.position.angle+=d.dAngle;this.updateGroupTransform();return d},getNextStepStatus:function(j,h){var d={collideTop:false,collideLeft:false,collideRight:false,collideBottom:false,collideObjects:[]};var f=this.size/2;var c=this.position.x+this.speed.x;var b=this.position.y+this.speed.y;if(c-f<this.stage.boundary.left){d.collideLeft=true}else{if(c+f>this.stage.boundary.right){d.collideRight=true}}if(b-f<this.stage.boundary.top){d.collideTop=true}else{if(b+f>this.stage.boundary.bottom){d.collideBottom=true}}var a=this.getThreateningIcons();for(var e=0;e<a.length;e++){var g=a[e];if(this.isOverlappedWith(c,b,g)){d.collideObjects.push(g)}}return d},handleStageInterval:function(){if(!this.stageManaged){return}if(!this.landed()){this.speed.y+=this.config.gravityIncrease}if(Math.abs(this.speed.x)<1){this.speed.x=0}if(Math.abs(this.speed.y)<1){this.speed.y=0}if(Math.abs(this.speed.angle)<1){this.speed.angle=0}if(this.speed.x==0&&this.speed.y==0&&this.speed.angle==0){return}var a=this.getNextStepStatus(this.speed.x,this.speed.y);this.moveIcon(this.speed.x,this.speed.y,this.speed.angle,a,false);this.changeSpeedByAir();this.handleBoundaryCollision(a)},handleBoundaryCollision:function(a){if(a.collideTop){this.speed.y*=-this.config.boundaryCollisionRate;this.speed.angle=-this.speed.x;this.position.y=this.stage.boundary.top+this.size/2}else{if(a.collideBottom){this.speed.y*=-this.config.boundaryCollisionRate;this.speed.angle=this.speed.x;this.position.y=this.stage.boundary.bottom-this.size/2}}if(a.collideLeft){this.speed.x*=-this.config.boundaryCollisionRate;this.speed.angle=this.speed.y;this.position.x=this.stage.boundary.left+this.size/2}else{if(a.collideRight){this.speed.x*=-this.config.boundaryCollisionRate;this.speed.angle=-this.speed.y;this.position.x=this.stage.boundary.right-this.size/2}}},changeSpeedByAir:function(){this.speed.x*=this.config.airRate;this.speed.y*=this.config.airRate;this.speed.angle*=this.config.airRate}};function Stage(c,b,a){this.parent=c;this.width=b;this.height=a;this.boundary={left:0,top:0,right:b,bottom:a};this.group=null;this.icons=[];this.config={timerDelayNormal:25,timerDelayLazy:200,intervalDelay:20};this.interval=null;this.destroied=false;this.timerCounter=0;this.maxTimerCounter=-1;this.render()}Stage.prototype={render:function(){this.group=this.parent.createChildNS("g",{"data-label":"Animation Stage"});this.initTimer()},initTimer:function(){var a=this;var b=function(){this.timerCounter++;console.log("Stage Timer");var d=true;for(var c=0;c<a.icons.length;c++){a.icons[c].handleStageInterval();if(!a.icons[c].landed()){d=false}}var e=(a.maxTimerCounter!=-1&&a.timerCount>=a.maxTimerCounter);if(!a.destroied&&!e){setTimeout(b,d?a.config.timerDelayLazy:a.config.timerDelayNormal)}};setTimeout(b,this.config.timerDelayNormal)},initInterval:function(){var a=this;this.interval=setInterval(function(){console.log("Stage Interval");for(var b=0;b<a.icons.length;b++){a.icons[b].handleStageInterval()}},this.config.intervalDelay)},addIcon:function(){var a=this.icons.length;var b=new Icon(this,a);this.icons.push(b)},destroy:function(){if(this.interval!=null){clearInterval(this.interval);this.interval=null}this.parent.removeChild(this.group);this.group=null;this.destroied=true}};var Config={General:{developerMode:false,keyboardScrollSpeed:50,lockTool:false,snapToGrid:false,showScale:false,showObjectManager:false,gridSize:20,canvasBackground:"#CCCCCC",drawingBackground:"#FFFFFF",anchorTipNofified:false},LocalStorage:{mainKey:"QSTAGE_VF710",autoSaveKey:"AUTO_SAVE"},Workspace:{margin:0},SlidePane:{left:0,top:24},Scaleplate:{size:16,indicatorSize:5,indicatorColor:"RGBA(67, 74, 77, 0.5)"},ObjectManager:{width:240,marginTop:66,marginRight:20},DrawingBoard:{fillColor:"#3F51B5",strokeColor:"#333333",fillOpacity:0.8,strokeOpacity:1,strokeWidth:4},CanvasFrame:{marginLeft:8,marginTop:8,marginRight:8,marginBottom:12,borderDashArray:"1,0",borderColor:"#333333"},AnchorPoint:{width:10,height:10,fill:"RGBA(255, 255, 255, 0.2)",stroke:"RGBA(33, 33, 33, 1)",capturedFill:"#FE5722",capturedStroke:"#FE5722",highlightedFill:"#FFFFFF",highlightedStroke:"#FE5722",strokeWidth:1,selectedFill:"#ff0000",selectedStroke:"#FE5722",followingFill:"#FFFFFF",followingStroke:"#FE5722"},BezierController:{size:6,fill:"RGBA(127, 127, 127, 1)",stroke:"RGBA(127, 127, 127, 1)",strokeWidth:1,capturedFill:"#ff0000",capturedStroke:"#FE5722",highlightedFill:"#FFFFFF",highlightedStroke:"#FE5722"},FrameHandle:{weight:4,length:16,borderSize:1,borderDashArray:"4,2",fill:"RGBA(255, 255, 255, 1)",stroke:"RGBA(33, 33, 33, 1)",capturedFill:"#FE5722",capturedStroke:"#FE5722",highlightedFill:"#FFFFFF",highlightedStroke:"#FE5722",ghostFill:"RGBA(0, 0, 0, 0)",ghostStroke:"RGBA(0, 0, 0, 0)"},Shape:{ghostWidth:40,ghostStroke:"RGBA(255, 0, 0, 0)",ghostFill:"RGBA(255, 0, 0, 0)"}};function GET_SAMPLE_OBJ(){var a={canvas:{position:{x:8,y:8},boundary:{left:0,top:0,right:1091,bottom:735}},shapes:[{id:0,type:16,position:{x:176,y:328},boundary:{left:0,top:-187,right:387,bottom:4},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[53,-149,-73,72],[280,-187,-23,-9],[382,-87,-15,-53],[387,4,4,-25]],properties:[["fill",{color:"#FFFFFF",opacity:"1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",true],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:1,type:16,position:{x:821,y:491},boundary:{left:-670,top:-278,right:-233,bottom:-88},rotation:{cx:0,cy:0,angle:0},points:[[-670,-93,-41,187],[-446,-278,0,0],[-233,-88,-42,-201]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:2,type:4,position:{x:120,y:396},boundary:{left:0,top:0,right:75,bottom:80},rotation:{cx:0,cy:0,angle:0},points:[],properties:[["fill",{color:"#FE5722",opacity:"0.8"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",true],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:3,type:4,position:{x:535,y:399},boundary:{left:0,top:0,right:83,bottom:82},rotation:{cx:0,cy:0,angle:0},points:[],properties:[["fill",{color:"#FE5722",opacity:"0.8"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",true],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:4,type:16,position:{x:177,y:523},boundary:{left:-6,top:-310,right:387,bottom:19},rotation:{cx:0,cy:0,angle:0},points:[[0,0,1,3],[-6,-86,-8,53],[39,-245,-57,60],[196,-310],[362,-236,-57,-72],[387,-72],[382,8,13,-22],[226,11,9,19],[210,-17],[182,-20,13,-10],[161,9,6,-14],[64,19,27,1]],properties:[["fill",{color:"#FFFFFF",opacity:"1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",true],["closePath",true],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:5,type:4,position:{x:335,y:188},boundary:{left:0,top:0,right:67,bottom:70},rotation:{cx:0,cy:0,angle:0},points:[],properties:[["fill",{color:"#FE5722",opacity:"1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",true],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:6,type:16,position:{x:802,y:336},boundary:{left:-431,top:-78,right:-430,bottom:-37},rotation:{cx:0,cy:0,angle:0},points:[[-431,-78],[-431,-37]],properties:[["fill",{color:"#FFFFFF",opacity:"0.1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:7,type:16,position:{x:407,y:532},boundary:{left:-62,top:-31,right:-3,bottom:-29},rotation:{cx:0,cy:0,angle:0},points:[[-62,-29,-8,7],[-3,-31,-27,-6]],properties:[["fill",{color:"#FFFFFF",opacity:"0.1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:8,type:16,position:{x:179,y:523},boundary:{left:-15,top:0,right:162,bottom:58},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[-15,53,-24,-31],[162,58,-11,13],[159,12,2,1]],properties:[["fill",{color:"#FE5722",opacity:"0.8"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:9,type:16,position:{x:401,y:533},boundary:{left:0,top:-2,right:160,bottom:66},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[37,66,-63,-16],[160,-2,88,57]],properties:[["fill",{color:"#FE5722",opacity:"0.8"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:10,type:32,position:{x:633,y:471},boundary:{left:0,top:-11,right:39,bottom:20},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,5],[0,8],[1,10],[1,11],[1,14],[2,15],[2,16],[3,17],[4,17],[5,18],[5,19],[6,19],[8,19],[8,20],[9,20],[9,19],[11,16],[15,9],[16,5],[18,2],[18,1],[19,-1],[19,-2],[20,-3],[20,-4],[20,-5],[20,-7],[20,-9],[20,-8],[20,-7],[21,-3],[22,1],[23,5],[25,7],[25,8],[26,9],[26,12],[27,13],[27,14],[28,15],[28,16],[28,17],[29,17],[30,17],[31,17],[33,17],[33,16],[34,15],[35,14],[35,13],[36,10],[37,8],[37,6],[37,5],[37,4],[37,2],[37,1],[39,-2],[39,-5],[39,-6],[39,-7],[39,-8],[39,-9],[39,-10],[37,-10],[37,-11],[36,-11]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:11,type:32,position:{x:681,y:455},boundary:{left:0,top:0,right:2,bottom:27},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[2,1],[2,3],[2,6],[2,10],[2,11],[2,13],[2,17],[2,20],[2,21],[2,22],[2,24],[2,25],[2,26],[2,27]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:12,type:32,position:{x:701,y:448},boundary:{left:0,top:0,right:5,bottom:28},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[1,2],[1,8],[1,12],[3,15],[3,19],[4,21],[4,23],[5,26],[5,27],[5,28]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:13,type:32,position:{x:687,y:466},boundary:{left:0,top:-1,right:14,bottom:0},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[3,0],[5,-1],[6,-1],[8,-1],[9,-1],[11,-1],[12,-1],[13,-1],[14,-1]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:14,type:32,position:{x:637,y:522},boundary:{left:0,top:-6,right:15,bottom:19},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[1,-1],[5,-2],[7,-4],[9,-5],[11,-6],[14,-6],[15,-6],[15,-3],[15,-2],[14,7],[14,12],[13,16],[13,17],[13,18],[13,19]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:15,type:32,position:{x:672,y:506},boundary:{left:-14,top:0,right:0,bottom:45},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,2],[-1,7],[-3,11],[-3,14],[-4,17],[-5,19],[-8,25],[-9,30],[-11,34],[-12,37],[-13,40],[-13,42],[-13,44],[-14,45]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:16,type:32,position:{x:687,y:506},boundary:{left:0,top:0,right:16,bottom:30},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,3],[0,4],[0,5],[0,6],[0,7],[0,8],[0,9],[0,11],[1,12],[2,12],[2,13],[3,13],[5,14],[6,15],[9,17],[13,20],[15,20],[16,21],[16,22],[16,23],[16,24],[16,26],[15,27],[14,28],[13,29],[12,29],[9,29],[8,30],[6,30],[5,30],[3,30],[2,30],[2,29],[2,28],[2,27],[2,25],[4,24],[5,23],[5,22],[7,19],[7,18],[9,17],[9,16],[9,13],[10,12],[10,11],[10,10],[10,9],[10,8],[10,7],[10,6],[10,4],[10,3],[10,2],[8,2],[7,1],[6,0],[5,0],[4,0]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:17,type:32,position:{x:725,y:497},boundary:{left:-17,top:0,right:0,bottom:42},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,5],[-2,7],[-4,13],[-7,18],[-9,21],[-10,24],[-11,26],[-13,29],[-14,30],[-15,34],[-16,35],[-16,37],[-16,39],[-17,40],[-17,41],[-17,42]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:18,type:32,position:{x:735,y:499},boundary:{left:0,top:0,right:3,bottom:22},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[1,1],[1,5],[1,15],[1,19],[2,21],[2,22],[3,22]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:19,type:32,position:{x:754,y:492},boundary:{left:-8,top:0,right:21,bottom:35},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,3],[0,5],[0,9],[0,11],[0,12],[0,13],[1,13],[2,13],[3,13],[7,12],[9,12],[12,10],[13,10],[15,10],[16,10],[17,10],[17,11],[18,11],[18,13],[20,13],[20,14],[20,15],[20,16],[21,16],[21,18],[21,19],[21,20],[21,21],[21,22],[19,23],[17,27],[16,27],[13,28],[8,31],[1,34],[-2,34],[-3,35],[-5,35],[-7,35],[-7,34],[-8,33],[-8,32],[-8,30],[-8,29]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:20,type:32,position:{x:757,y:495},boundary:{left:0,top:-6,right:17,bottom:0},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[1,-1],[3,-1],[4,-2],[5,-2],[7,-2],[8,-2],[9,-2],[10,-2],[11,-2],[11,-3],[12,-3],[13,-3],[15,-4],[16,-4],[17,-4],[17,-6]],properties:[["fill",{color:"#3F51B5",opacity:0.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]}]};return a}function EventManager(a){this.workspace=a;this.registrations=[];this.arrowKeyStatus=0;this.keyboardTimer=null;this.keyboardTimerDelay=50;this.doubleTapThreshold=300;this.init()}EventManager.prototype={init:function(a){var b=this;this.handleMouseEvent=function(c){b.handleMT(c,this)};this.handleTouchEvent=function(c){c.preventDefault();b.handleMT(c,this)};this.handleKeyEvent=function(c){b.handleKey(c)};if(a==null){document.addEventListener("mousemove",this.handleMouseEvent,false);document.addEventListener("mouseup",this.handleMouseEvent,false);document.addEventListener("keydown",this.handleMouseEvent,false);document.addEventListener("keyup",this.handleMouseEvent,false)}else{a.addEventListener("mousedown",this.handleMouseEvent,false);a.addEventListener("touchstart",this.handleTouchEvent,false);a.addEventListener("touchend",this.handleTouchEvent,false);a.addEventListener("touchmove",this.handleTouchEvent,false)}},getRegistration:function(b){for(var c=0;c<this.registrations.length;c++){if(this.registrations[c].object==b){return this.registrations[c]}}var a={object:b,events:[],beginPosition:null,previousPosition:null,previousTime:null,addListener:function(d,e){this.events.push({key:d,handler:e});return this}};this.registrations.push(a);this.init(b);return a},fireEvent:function(c,b,g,a){if(c!=null){for(var d=0;d<c.events.length;d++){var f=c.events[d];if(f.key==b){f.handler(g,a)}}}else{for(var d=0;d<this.registrations.length;d++){this.fireEvent(this.registrations[d],b,g,a)}}},isAppleDevice:function(){var a=navigator.userAgent;var b=false;b|=!!a.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);b|=a.indexOf("iPhone")>-1;b|=a.indexOf("iPad")>-1;return b},handleMT:function(b,a){switch(b.type){case"mousedown":this.touchstartAndMousedown(b,a);break;case"mousemove":this.touchmoveAndMousemove(b);break;case"mouseup":this.touchcancelAndMouseup(b);break;case"touchstart":if(b.touches.length==1){this.touchstartAndMousedown(b.targetTouches[0],a)}else{if(b.touches.length==2){}}break;case"touchend":if(b.changedTouches.length==1){this.touchcancelAndMouseup(b.changedTouches[0],a)}break;case"touchmove":if(b.changedTouches.length==1){this.touchmoveAndMousemove(b.changedTouches[0],a)}else{if(b.touches.length==2){}}break}},touchstartAndMousedown:function(d,c){var b=this.getRegistration(c);b.beginPosition={x:d.pageX,y:d.pageY};b.previousPosition={x:d.pageX,y:d.pageY};var a="capture";if(b.previousTime!=null&&new Date().getTime()-b.previousTime<this.doubleTapThreshold){a="doubleTap"}this.fireEvent(b,a,d,{sender:c,current:{x:d.pageX,y:d.pageY}});b.previousTime=new Date().getTime()},touchmoveAndMousemove:function(d,b){for(var c=0;c<this.registrations.length;c++){var a=this.registrations[c];if(a.beginPosition==null){continue}this.fireEvent(a,"drag",d,{sender:a.object,captured:true,begin:{x:a.beginPosition.x,y:a.beginPosition.y,dx:d.pageX-a.beginPosition.x,dy:d.pageY-a.beginPosition.y},previous:{x:a.previousPosition.x,y:a.previousPosition.y,dx:d.pageX-a.previousPosition.x,dy:d.pageY-a.previousPosition.y},current:{x:d.pageX,y:d.pageY}});a.previousPosition.x=d.pageX;a.previousPosition.y=d.pageY}},touchcancelAndMouseup:function(d,b){for(var c=0;c<this.registrations.length;c++){var a=this.registrations[c];if(a.beginPosition==null){continue}a.beginPosition=null;this.fireEvent(a,"release",d,{sender:a.object,current:{x:d.pageX,y:d.pageY}})}},handleKey:function(d){var a=this;switch(d.type){case"keydown":var c=event.keyCode;switch(c){case 37:this.arrowKeyStatus|=1;break;case 38:this.arrowKeyStatus|=1<<1;break;case 39:this.arrowKeyStatus|=1<<2;break;case 40:this.arrowKeyStatus|=1<<3;break}if(this.arrowKeyStatus>0&&this.keyboardTimer==null){b()}function b(){var f=0;var e=0;if((a.arrowKeyStatus&1)>0){f=-1}if((a.arrowKeyStatus&(1<<1))>0){e=-1}if((a.arrowKeyStatus&(1<<2))>0){f=1}if((a.arrowKeyStatus&(1<<3))>0){e=1}if(a.arrowKeyStatus>0){a.fireEvent(null,"arrowkey",d,{dx:f,dy:e});a.keyboardTimer=setTimeout(b,a.keyboardTimerDelay)}else{a.keyboardTimer=null}}break;case"keyup":var c=event.keyCode;switch(c){case 37:a.arrowKeyStatus&=~1;break;case 38:a.arrowKeyStatus&=~(1<<1);break;case 39:a.arrowKeyStatus&=~(1<<2);break;case 40:a.arrowKeyStatus&=~(1<<3);break}if(a.arrowKeyStatus==0){if(a.keyboardTimer!=null){clearTimeout(a.keyboardTimer);a.keyboardTimer=null}}break}}};function AppMenu(a){this.pane=a;this.width=200;this.title="Application"}AppMenu.prototype={renderInto:function(g){var e=this;var d=g.createChild("div",{"class":"menu-item app-menu",title:this.title});var c=d.createChild("div",{});this.pane.render32pxSvgIcon(c,"ICON32_MENU_App");var f=d.createChild("div",{"class":"sub-container",style:"width: {0}px;".format(this.width)});f.createChild("div",{"class":"sub-title no-select"},this.title);var b=f.createChild("div",{"class":"sub-body"});var a=b.createChild("div",{"class":"sub-items"});this.renderSubMenus(a);c.addEventListener("click",function(){e.pane.selectMenuItem(this.parentNode)},false);return d},getWorkspace:function(){return this.pane.workspace},getPainting:function(){return this.pane.workspace.painting},renderSubMenus:function(a){var b=this;this.pane.renderIconButton(a,"Home","ICON24_HOME",true,function(){QStage.setUrlHash("id",null);b.getWorkspace().showStartPage(true)});this.pane.renderIconButton(a,"New","ICON24_NEW",true,function(){QStage.setUrlHash("id","N");b.getWorkspace().reset()});this.pane.renderIconButton(a,"Save","ICON24_SAVE",false,function(){if(!b.getWorkspace().needToBeSaved()){return}b.getWorkspace().sendToServer(function(d){if(d==null){b.getWorkspace().drawingBoard.showMessage("Error: Not Saved")}else{var c=QStage.getUrlHash("id");if(c==d){b.getWorkspace().drawingBoard.showMessage("Saved")}else{QStage.setUrlHash("id",d)}}})});this.pane.renderIconButton(a,"Play","ICON24_PLAY",true,function(){var c="http://stage.qlike.com/player/?id=";if(b.getWorkspace().needToBeSaved()){b.getWorkspace().sendToServer(function(g){QStage.setUrlHash("id",g);c+=g;var f=window.open(c,"wndPlay","");if(f){f.focus()}else{b.getWorkspace().drawingBoard.showMessage("Failed to open new window")}})}else{var e=QStage.getUrlHash("id");c+=e;var d=window.open(c,"wndPlay","");if(d){d.focus()}else{b.getWorkspace().drawingBoard.showMessage("Failed to open new window")}}});this.pane.renderIconButton(a,"Share","ICON24_SHARE",true,function(){var c=b.getWorkspace().promptDialog;c.setShowing(true);var d="http://stage.qlike.com/player/?id=";if(b.getWorkspace().needToBeSaved()){c.setEnabled(false);c.setText("Getting sharing URL...");b.getWorkspace().sendToServer(function(e){QStage.setUrlHash("id",e);d+=e;c.setText(d);c.setEnabled(true);c.selectAll()})}else{d+=QStage.getUrlHash("id");c.setText(d);c.selectAll()}});this.pane.renderIconButton(a,"Download","ICON24_DOWNLOAD",true,function(){var c="http://stage.qlike.com/repository/?action=down&id=";if(b.getWorkspace().needToBeSaved()){b.getWorkspace().sendToServer(function(d){QStage.setUrlHash("id",d);c+=d;location.href=c})}else{c+=QStage.getUrlHash("id");location.href=c}})},getWorkspace:function(){return this.pane.workspace},getPainting:function(){return this.pane.workspace},getDrawingBoard:function(){return this.pane.workspace.drawingBoard}};function ColorMenu(b,a){this.pane=b;this.isStroke=a;this.title=a?"Stroke":"Fill";this.screenStatus=null;this.width=[392,228,338];this.colors=[["#333333","#E51C24","#EA1E63","#9C27B3","#673BB7","#00BCD5","#03A9F5","#5677FC","#3F51B5","#039488","#259B23","#8BC24A","#CDDC39","#FE5722","#FF9700","#FEC107","#FFEB3C","#795547","#9E9E9E","#607D8B","#FFFFFF"],["#333333","#E51C24","#FF9700","#FFEB3C","#259B23","#00BCD5","#3F51B5","#9C27B3","#795547","#9E9E9E","#EA1E63","#FFFFFF"]];this.icon=null;this.subContainer=null;this.titleBackground=null;this.opacityLabel=null;this.widthLabel=null;this.colorsPanel=null;this.widthPanel=null;this.codeInput=null;this.widthSelect=null;this.opacSelect=null;this.onColorChanged=null}ColorMenu.prototype={renderInto:function(b){var f=this;var a=b.createChild("div",{"class":"menu-item color-menu",title:this.title});this.button=a.createChild("div",{});this.icon=this.button.createChild("div",{"class":"icon-color"});this.opacityLabel=this.icon.createChild("div",{"class":"label no-select"},"[Opacity]");if(this.isStroke){this.widthLabel=this.icon.createChild("div",{"class":"label no-select"},"[Width]")}this.subContainer=a.createChild("div",{"class":"sub-container",style:"width: 0px;"});var e=this.subContainer.createChild("div",{"class":"sub-title no-select"});this.titleBackground=e.createChild("div",{"class":"color-background"});this.titleBackground.createChild("span",{"class":"color-label"},this.title);var g=this.titleBackground.createChild("div",{"class":"buttons"});var j=g.createChild("span",{"class":"button button-ok"},"OK");j.addEventListener("click",function(){var k=f.codeInput.value;f.changeColor(k.isRGBCode()?k:f.color)},false);var h=this.subContainer.createChild("div",{"class":"sub-body"});this.renderPalette(h);this.button.addEventListener("click",function(){f.pane.selectMenuItem(this.parentNode)},false);if(this.isStroke){var c=this.getPainting().stroke.color;var d=this.getPainting().stroke.opacity;var i=this.getPainting().stroke.width;this.setData(c,d,i)}else{var c=this.getPainting().fill.color;var d=this.getPainting().fill.opacity;var i=null;this.setData(c,d,i)}return a},resize:function(g,a){var f=this.getWorkspace().isSmallScreen();var c=this.getWorkspace().isLandscape();var e=0;if(f){if(c){e=2}else{e=1}}if(this.screenStatus!=e){this.screenStatus=e;while(this.colorsPanel.childNodes.length>0){this.colorsPanel.removeChild(this.colorsPanel.firstChild)}var b=f?this.colors[1]:this.colors[0];for(var d=0;d<b.length;d++){this.renderColorButton(this.colorsPanel,b[d],false)}var g=this.width[0];if(f){if(c){g=this.width[2]}else{g=this.width[1]}}this.subContainer.updateStyle("width",g+"px")}},getWorkspace:function(){return this.pane.workspace},getPainting:function(){return this.pane.workspace.painting},renderPalette:function(c){var e=this;this.colorsPanel=c.createChild("div",{"class":"colors"});c.createChild("div",{"class":"clear"});var a=c.createChild("div",{"class":"attributes"});var d=a.createChild("div",{"class":"field"});d.createChild("div",{"class":"label"},"RGB Code:");this.codeInput=d.createChild("input",{type:"text","class":"form-control",id:"code-input",maxlength:7});a.createChild("div",{"class":"clear"});var d=a.createChild("div",{"class":"field"});d.createChild("div",{"class":"label"},"Color Opacity:");this.opacSelect=d.createChild("select",{"class":"form-control",id:"opacity-select"});for(var b=0;b<=10;b++){this.opacSelect.createChild("option",{value:b/10},b*10+"%")}a.createChild("div",{"class":"clear"});if(this.isStroke){this.widthPanel=a.createChild("div",{"class":"field"});this.widthPanel.createChild("div",{"class":"label"},"Stroke Width:");this.widthSelect=this.widthPanel.createChild("select",{"class":"form-control",id:"width-select"});for(var b=0;b<=20;b++){this.widthSelect.createChild("option",{value:b}," "+b)}a.createChild("div",{"class":"clear"})}},renderColorButton:function(a,b){var c=this;var d=a.createChild("div",{style:"background-color: "+b,title:b,"data-color":b});d.addEventListener("click",function(){var e=this.getAttribute("data-color");c.changeColor(e)},false)},changeColor:function(a){if(a==null){this.pane.selectMenuItem(null);return}if(typeof this.onColorChanged=="function"){var b=this.getSelectValue(this.opacSelect);var c=null;if(this.isStroke){c=this.getSelectValue(this.widthSelect)}this.onColorChanged(a,b,c)}this.pane.selectMenuItem(null)},selectByValue:function(a,c){for(var b=0;b<a.options.length;b++){if(a.options[b].value==c){a.options[b].selected=true}}},getSelectValue:function(a){return a.options[a.selectedIndex].value},setData:function(a,b,c){this.icon.updateStyle("background-color",a);this.titleBackground.updateStyle("background-color",a);this.opacityLabel.textContent="{0}%".format(b*100);if(c){this.widthLabel.textContent="{0}px".format(c)}this.codeInput.value=a;this.selectByValue(this.opacSelect,b);if(c){this.selectByValue(this.widthSelect,c)}}};function PropertyMenu(a){this.pane=a;this.menuItem=null;this.width=260;this.title="Properties";this.shape=null;this.buttonFront=null;this.buttonBack=null;this.lblPosition=null;this.lblSize=null;this.lvlRotation=null;this.dynamicProperties=null;this.fieldIndex=0}PropertyMenu.prototype={renderInto:function(h){var e=this;this.menuItem=h.createChild("div",{"class":"menu-item property-menu hidden",title:this.title});var d=this.menuItem.createChild("div",{});this.pane.render32pxSvgIcon(d,"ICON32_MENU_Property");var g=this.menuItem.createChild("div",{"class":"sub-container",style:"width: {0}px;".format(this.width)});g.createChild("div",{"class":"sub-title no-select"},this.title);var c=g.createChild("div",{"class":"sub-body"});var b=c.createChild("div",{"class":"button-list"});var f=b.createChild("div",{"class":"icon-item",title:"Delete"});this.render32pxSvgIcon(f,0);f.addEventListener("click",function(i){e.getPainting().selectedShape.remove()},false);this.buttonFront=b.createChild("div",{"class":"icon-item",title:"Bring to Front"});this.render32pxSvgIcon(this.buttonFront,1);this.buttonFront.addEventListener("click",function(i){e.getPainting().selectedShape.bringToFront();e.updateButtonStatus(e.getPainting().selectedShape)},false);this.buttonBack=b.createChild("div",{"class":"icon-item",title:"Send to Back"});this.render32pxSvgIcon(this.buttonBack,2);this.buttonBack.addEventListener("click",function(i){e.getPainting().selectedShape.sendToBack();e.updateButtonStatus(e.getPainting().selectedShape)},false);this.pane.addSeperator(c,"Properties");var a=c.createChild("div",{"class":"property-list"});this.lblPosition=this.addLabelField(a,"Position (X,Y)","");this.lblSize=this.addLabelField(a,"Size (W*H)","");this.lblRotation=this.addLabelField(a,"Rotation","");this.dynamicProperties=c.createChild("div",{"class":"property-list dynamic-list"});d.addEventListener("click",function(){e.pane.selectMenuItem(this.parentNode);e.updateStaticFields(e.shape)},false);return this.menuItem},getPainting:function(){return this.pane.workspace.painting},showProperty:function(a){this.shape=a;if(a==null){this.menuItem.addClassName("hidden");this.pane.selectMenuItem(null)}else{this.menuItem.removeClassName("hidden");this.updateButtonStatus(a);this.updateStaticFields(a);this.updateDynamicFields(a)}},updateButtonStatus:function(a){this.buttonFront.updateStyle("display",a.canBringFront()?"block":"none");this.buttonBack.updateStyle("display",a.canSendBack()?"block":"none")},updateStaticFields:function(b){var a=b.getAbsoluteInfo();this.lblPosition.textContent="{0},{1}".format(Math.round(a.left),Math.round(a.top));this.lblSize.textContent="{0}*{1}".format(Math.round(a.width),Math.round(a.height));this.lblRotation.textContent="{0} degree".format(Math.round(a.rotation))},updateDynamicFields:function(c){while(this.dynamicProperties.hasChildNodes()){this.dynamicProperties.removeChild(this.dynamicProperties.firstChild)}var a=this.addSelectField(this.dynamicProperties,"Animation (Stroke)",c.prop("strokeAnimation")>0?65:85,c.getOptions("strokeAnimation"),c.prop("strokeAnimation"),function(g){if(g==0){a.updateStyle("width","85px");a.nextSibling.updateStyle("display","none")}else{a.updateStyle("width","65px");a.nextSibling.updateStyle("display",null)}c.prop("strokeAnimation",g)});var f="float: right; margin: 4px 0px 0px 4px;"+(c.prop("strokeAnimation")>0?" ":"display:none;");var b=a.parentNode.createChild("div",{style:f,title:"Preview Stroke Animation"});var e=b.createChildNS("svg",{width:16,height:16});var h=e.createChildNS("g");h.createChildNS("path",{fill:"#06ACD4",stroke:"none",d:"M0,0 L16,8 L0,16 Z"});e.addEventListener("click",function(g){c.playAnimation("STROKE",1)},false);var a=this.addSelectField(this.dynamicProperties,"Animation (Fill)",c.prop("fillAnimation")>0?65:85,c.getOptions("fillAnimation"),c.prop("fillAnimation"),function(g){if(g==0){a.updateStyle("width","85px");a.nextSibling.updateStyle("display","none")}else{a.updateStyle("width","65px");a.nextSibling.updateStyle("display",null)}c.prop("fillAnimation",g)});var f="float: right; margin: 4px 0px 0px 4px;"+(c.prop("fillAnimation")>0?" ":"display:none;");var b=a.parentNode.createChild("div",{style:f,title:"Preview Fill Animation"});var e=b.createChildNS("svg",{width:16,height:16});var h=e.createChildNS("g");h.createChildNS("path",{fill:"#06ACD4",stroke:"none",d:"M0,0 L16,8 L0,16 Z"});e.addEventListener("click",function(g){c.playAnimation("FILL",1)},false);this.addSelectField(this.dynamicProperties,"Stroke Linecap",85,c.getOptions("strokeLinecap"),c.prop("strokeLinecap"),function(g){c.prop("strokeLinecap",g)});this.addSelectField(this.dynamicProperties,"Stroke Linejoin",85,c.getOptions("strokeLinejoin"),c.prop("strokeLinejoin"),function(g){c.prop("strokeLinejoin",g)});switch(c.getType()){case (ShapeTypes.Polygon):var d=c.anchorPoints.length;this.addSelectField(this.dynamicProperties,"Vertex Number",50,c.getOptions("vertexNumber"),d,function(g){c.setVertexNumber(g)});break;case (ShapeTypes.Polyline):var d=c.prop("closePath")?1:0;this.addSelectField(this.dynamicProperties,"Close Path",85,c.getOptions("GENERIC_BOOL"),d,function(g){c.prop("closePath",g==1)});var d=c.prop("applyFill")?1:0;this.addSelectField(this.dynamicProperties,"Apply Fill",85,c.getOptions("GENERIC_BOOL"),d,function(g){c.prop("applyFill",g==1)});break;case (ShapeTypes.Label):var d=c.prop("lengthAdjust");this.addSelectField(this.dynamicProperties,"Length Adjust",140,c.getOptions("lengthAdjust"),d,function(g){c.prop("lengthAdjust",g)});this.addTextField(this.dynamicProperties,"Text",180,c.prop("text"),function(g){c.prop("text",g)});break}},addSelectField:function(a,j,b,n,e,m){this.fieldIndex++;var h=a.createChild("div",{"class":this.fieldIndex%2!=0?"field no-select":"field alt-field no-select"});var c=h.createChild("div",{"class":"left"},j+":");var f=h.createChild("div",{"class":"right"});var g=f.createChild("select",{style:"width: {0}px;".format(b)});for(var d=0;d<n.length;d++){var k=n[d][0];var l=n[d][1];if(k==e){g.createChild("option",{value:k,selected:"true"},l)}else{g.createChild("option",{value:k},l)}}g.addEventListener("change",function(o){var i=g.options[g.selectedIndex].value;m(i)},false);return g},addTextField:function(a,g,b,e,i){this.fieldIndex++;var f=a.createChild("div",{"class":this.fieldIndex%2!=0?"field no-select":"field alt-field no-select"});var c=f.createChild("div",{"class":"left"},g+":");var d=f.createChild("div",{"class":"right"});var h=d.createChild("input",{type:"text",style:"width: {0}px;".format(b),value:e});h.addEventListener("change",function(k){var j=h.value;i(j)},false);return h},addLabelField:function(f,c,d){this.fieldIndex++;var e=f.createChild("div",{"class":this.fieldIndex%2!=0?"field no-select":"field alt-field no-select"});var b=e.createChild("div",{"class":"left"},c+":");var a=e.createChild("div",{"class":"right"},d);return a},render32pxSvgIcon:function(f,c){var a=32;var b=f.createChildNS("svg",{width:a,height:a});var e=b.createChildNS("g");switch(c){case 0:var h="";h+="M22.153,28c0.68,0,1.232-0.448,1.232-1V15c0-0.553-0.553-1-1.232-1c-0.678,0-1.229,0.447-1.229,1v12";h+="C20.925,27.552,21.476,28,22.153,28z M29.539,4h-7.386V2c0-1.105-1.102-2-2.461-2h-7.384c-1.36,0-2.461,0.895-2.461,2v2H2.462";h+="C1.102,4,0,4.895,0,6v2c0,1.104,1.103,2,2.462,2v18c0,2.209,2.205,4,4.923,4h17.229c2.72,0,4.925-1.791,4.925-4V10";h+="C30.898,10,32,9.104,32,8V6C32.002,4.895,30.9,4,29.539,4z M12.308,3c0-0.552,0.551-1,1.231-1h4.923c0.68,0,1.23,0.448,1.23,1v1";h+="c-1.193,0-7.385,0-7.385,0L12.308,3L12.308,3z M27.078,28c0,1.104-1.103,2-2.462,2H7.386c-1.36,0-2.462-0.896-2.462-2V10h22.154";h+="V28z M28.309,8H3.693c-0.68,0-1.231-0.448-1.231-1c0-0.552,0.551-1,1.231-1h24.616c0.68,0,1.23,0.448,1.23,1";h+="C29.539,7.552,28.988,8,28.309,8z M9.847,28c0.679,0,1.231-0.448,1.231-1V15c0-0.553-0.552-1-1.231-1";h+="c-0.68,0-1.231,0.447-1.231,1v12C8.616,27.552,9.167,28,9.847,28z M16.001,28c0.68,0,1.23-0.448,1.23-1V15";h+="c0-0.553-0.551-1-1.23-1c-0.679,0-1.231,0.447-1.231,1v12C14.77,27.552,15.322,28,16.001,28z";e.createChildNS("path",{d:h,fill:"#FE5722",stroke:"none","stroke-width":1,});break;case 1:e.createChildNS("rect",{x:0.5,y:0.5,width:a/2,height:a/2,stroke:"#333333","stroke-width":1,fill:"#ffffff"});e.createChildNS("rect",{x:a/2+0.5,y:a/2+0.5,width:a/2-1,height:a/2-1,stroke:"#333333","stroke-width":1,fill:"#ffffff"});e.createChildNS("rect",{x:a/4,y:a/4,width:a/2,height:a/2,stroke:"none",fill:"#FF9700"});break;case 2:e.createChildNS("rect",{x:a/4,y:a/4,width:a/2,height:a/2,stroke:"none",fill:"#FF9700"});e.createChildNS("rect",{x:0.5,y:0.5,width:a/2,height:a/2,stroke:"#333333","stroke-width":1,fill:"#ffffff"});e.createChildNS("rect",{x:a/2+0.5,y:a/2+0.5,width:a/2-1,height:a/2-1,stroke:"#333333","stroke-width":1,fill:"#ffffff"});break}}};function SampleMenu(a){this.pane=a;this.width=200;this.title="Developer Mode"}SampleMenu.prototype={renderInto:function(g){var e=this;var d=g.createChild("div",{"class":"menu-item sample-menu",title:this.title,id:"hidden_sample_menu",style:"display: none"});var c=d.createChild("div",{});this.pane.render32pxSvgIcon(c,"ICON32_MENU_NONE");var f=d.createChild("div",{"class":"sub-container",style:"width: {0}px;".format(this.width)});f.createChild("div",{"class":"sub-title no-select"},this.title);var b=f.createChild("div",{"class":"sub-body"});var a=b.createChild("div",{"class":"sub-items"});this.renderSubMenus(a);c.addEventListener("click",function(){e.pane.selectMenuItem(this.parentNode)},false);return d},getWorkspace:function(){return this.pane.workspace},getPainting:function(){return this.pane.workspace.painting},renderSubMenus:function(j){var e=this;var r=null;var l=null;var m=null;var n=null;var d=null;var t={x:200,y:150};var o={left:100,top:80,right:500,bottom:250};o=QStage.enhanceBoundary(o);var q=40;var h=90;var g=120;function k(z,w,x,u,v){var y=v/180*Math.PI;var D=x-z;var C=u-w;var B=D*(1-Math.cos(y))-C*Math.sin(y);var A=D*Math.sin(y)+C*(1-Math.cos(y));return{x:B,y:A}}var c=j.createChild("div",{"class":"text-item no-select"},"Rotate Sample");var b=j.createChild("div",{"class":"text-item no-select"},"Move Blue Rect");c.addEventListener("click",function(){var u=e.getWorkspace().drawingBoard.underGroup;if(r==null){r=u.createChildNS("rect",{x:o.left,y:o.top,width:o.width,height:o.height,fill:"none",stroke:"RGBA(0, 0, 0, 0.5)","stroke-width":1})}if(l==null){l=u.createChildNS("rect",{x:o.left,y:o.top,width:o.width,height:o.height,fill:"RGBA(255, 0, 0, 0.5)",stroke:"none"});n=u.createChildNS("circle",{cx:o.cx,cy:o.cy,r:10,fill:"none",stroke:"RGBA(255, 0, 0, 1)","stroke-width":1})}if(m==null){m=u.createChildNS("rect",{x:o.left,y:o.top,width:o.width,height:o.height,fill:"RGBA(0, 0, 255, 0.5)",stroke:"none"});d=u.createChildNS("circle",{cx:o.cx+h,cy:o.cy+g,r:10,fill:"none",stroke:"RGBA(0, 0, 255, 1)","stroke-width":1})}var v="translate({0}, {1})".format(t.x,t.y);r.setAttribute("transform",v);var x="translate({3}, {4}) rotate({0}, {1}, {2})".format(q,o.cx,o.cy,t.x,t.y);l.setAttribute("transform",x);n.setAttribute("transform","translate({0}, {1})".format(t.x,t.y));var w="translate({3}, {4}) rotate({0}, {1}, {2})".format(q,o.cx+h,o.cy+g,t.x,t.y);m.setAttribute("transform",w);d.setAttribute("transform","translate({0}, {1})".format(t.x,t.y));b.updateStyle("display","block")},false);b.addEventListener("click",function(){var v=e.getRotationOffset(o.cx,o.cy,o.cx+h,o.cy+g,q);var u="translate({3}, {4}) rotate({0}, {1}, {2})".format(q,o.cx+h,o.cy+g,t.x+v.x,t.y+v.y);m.setAttribute("transform",u)},false);var a=j.createChild("div",{"class":"text-item no-select"},"Animation Stage");var p=null;a.addEventListener("click",function(){if(p==null){var x=e.getWorkspace().drawingBoard.underGroup;var v=e.getWorkspace().drawingBoard.svgSize.width;var u=e.getWorkspace().drawingBoard.svgSize.height;function w(){p.addIcon();if(p.icons.length<3){setTimeout(w,1000)}}p=new Stage(x,v,u);w()}else{p.destroy();p=null}},false);var i=j.createChild("div",{"class":"text-item no-select"},"Server - List All");i.addEventListener("click",function(u){e.request("http://stage.qlike.com/repository/?action=pull",null,function(v){var w=JSON.parse(v);console.log(w.payload.length+" Record(s):");for(var x=0;x<w.payload.length;x++){console.log("- "+x+" "+w.payload[x].id)}});e.pane.selectMenuItem(null)},false);var s=j.createChild("div",{"class":"text-item no-select"},"Server - Clear");s.addEventListener("click",function(u){e.request("http://stage.qlike.com/repository/?action=del",null,function(v){console.log(v)});e.pane.selectMenuItem(null)},false);var f=j.createChild("div",{"class":"text-item no-select"},"Server - Prepare");f.addEventListener("click",function(u){var v="payload="+JSON.stringify(GET_SAMPLE_OBJ());e.request("http://stage.qlike.com/repository/?action=push",v,function(w){console.log(w)});e.pane.selectMenuItem(null)},false);var f=j.createChild("div",{"class":"text-item no-select"},"Render Sample PNG");f.addEventListener("click",function(u){e.renderSample(e.getDrawingBoard().shapeGroup);e.pane.selectMenuItem(null)},false);var f=j.createChild("div",{"class":"text-item no-select"},"Get Sample JSON");f.addEventListener("click",function(u){var v=e.getWorkspace().painting.serialize("STRING");console.log(v);e.pane.selectMenuItem(null)},false)},getWorkspace:function(){return this.pane.workspace},getDrawingBoard:function(){return this.pane.workspace.drawingBoard},getDeltaAngle:function(e,d,c){var b=Math.atan2(d.x-e.x,d.y-e.y);var a=Math.atan2(c.x-e.x,c.y-e.y);return b-a},getRotationOffset:function(l,v,k,s,n){var o=n/180*Math.PI;var e=Math.cos(o);var j=k-l;var i=s-v;var m=Math.sqrt(Math.pow(j,2)+Math.pow(i,2));var w=Math.pow(m,2);var u,q,t,p,g,f;if(l==k){u=-2*Math.pow(m,2)*(l*e-k*e+k);q=-Math.pow(m*(v-s),2)+Math.pow(m,4)*Math.pow(e,2)+2*Math.pow(m,2)*e*(l-k)*k+Math.pow(m*k,2);t=(-u+Math.sqrt(Math.pow(u,2)-4*w*q))/(2*w);p=(-u-Math.sqrt(Math.pow(u,2)-4*w*q))/(2*w);g=(Math.pow(m,2)*e+(l-k)*(k-t))/(v-s)+s;f=(Math.pow(m,2)*e+(l-k)*(k-p))/(v-s)+s}else{u=-2*Math.pow(m,2)*(v*e-s*e+s);q=-Math.pow(m*(l-k),2)+Math.pow(m,4)*Math.pow(e,2)+2*Math.pow(m,2)*e*(v-s)*s+Math.pow(m*s,2);g=(-u+Math.sqrt(Math.pow(u,2)-4*w*q))/(2*w);f=(-u-Math.sqrt(Math.pow(u,2)-4*w*q))/(2*w);t=(Math.pow(m,2)*e+(v-s)*(s-g))/(l-k)+k;p=(Math.pow(m,2)*e+(v-s)*(s-f))/(l-k)+k}var x=this.getDeltaAngle({x:k,y:s},{x:l,y:v},{x:t,y:g})*Math.sin(o);var h=null;if(x>0){h={x:l-t,y:v-g}}else{h={x:l-p,y:v-f}}return h},request:function(a,d,e){var c=this;var b=new XMLHttpRequest();b.onreadystatechange=function(){if(b.readyState==4){if(typeof e=="function"){if(b.status==200){e(b.responseText)}else{e(null)}}}};b.open("POST",a,true);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send(d)},renderSample:function(c){var a=c.createChildNS("g",{transform:"translate(100.000000,967.000000) scale(0.100000,-0.100000)"});var b="";b+="M2569.316,8420.336c-399.541-31.997-747.573-145.933-1050.356-344.917c-458.848-302.002-738.218-738.218-795.962-1242.329 ";b+="c-11.704-101.45-5.459-313.711,12.485-410.469l12.485-70.229l-51.499-101.45c-56.191-110.806-124.858-280.151-175.581-436.22 ";b+="l-33.56-101.44l-53.848-25.752c-67.891-32.778-149.038-110.811-184.16-177.92c-70.234-134.224-63.208-301.226,18.73-429.199 ";b+="c74.917-118.608,203.672-190.405,342.578-190.405h63.989l6.24-87.402c6.24-108.477,21.074-198.213,48.384-294.199l20.283-73.35 ";b+="l-22.627-15.605c-56.182-39.014-127.197-122.515-159.971-188.843c-28.096-56.973-33.555-74.922-36.675-127.207 ";b+="c-2.349-48.379,0-68.672,14.043-104.57c43.701-116.27,177.144-202.891,401.885-259.844 ";b+="c173.242-43.711,273.906-53.848,534.541-53.848c255.181,0,369.888,10.137,570.44,49.941 ";b+="c305.127,60.859,402.666,125.645,428.418,282.48c13.262,85.059-11.704,216.172-56.187,295.762 ";b+="c-15.605,27.31-15.605,30.425-3.12,67.114c33.555,101.445,130.313,216.934,219.277,260.635 ";b+="c43.696,21.855,56.187,24.189,99.888,21.064c40.581-2.334,55.405-7.793,83.496-27.305c57.749-42.92,124.858-147.49,167.778-262.197 ";b+="l14.043-36.689l-28.872-62.427c-40.576-88.965-53.843-152.949-49.941-241.914c3.906-91.289,27.314-144.355,88.179-202.109 ";b+="c99.106-93.633,231.772-130.313,581.367-159.961c391.738-34.336,726.513-19.512,963.74,42.129 ";b+="c92.08,24.199,210.693,84.277,258.291,131.094c60.879,59.316,77.266,99.883,77.266,184.961c0,64.746-2.344,74.902-27.314,124.844 ";b+="c-32.773,66.348-124.082,160.762-187.285,194.321c-23.418,12.48-43.701,23.408-45.264,24.189 ";b+="c-0.781,0.771,3.906,24.971,10.137,53.838c18.74,80.381,34.346,204.453,39.814,314.492l5.449,99.873l90.537,0.791 ";b+="c107.676,0,154.502,14.043,237.998,71.006c268.447,183.389,234.111,600.093-60.879,736.655l-56.953,26.533l-53.066,136.563 ";b+="c-28.877,74.917-82.715,205.239-118.613,288.735c-97.539,223.96-91.309,201.328-73.35,276.25 ";b+="c43.701,179.473,55.4,427.632,28.086,609.453c-64.766,437.783-309.805,813.911-702.314,1076.108 ";b+="c-280.146,188.066-613.359,305.122-991.055,348.042C2915.019,8417.992,2633.315,8425.019,2569.316,8420.336z M3025.053,8367.27 ";b+="c246.587-32.778,527.515-114.712,718.696-211.479c234.893-118.613,460.41-297.314,601.65-479.922 ";b+="c230.996-295.752,342.588-661.733,312.939-1024.6c-9.365-120.957-31.221-252.056-40.586-241.914 ";b+="c-3.115,3.125-13.271,28.877-23.418,56.968c-51.494,147.485-166.201,336.333-283.262,468.213 ";b+="c-278.584,312.144-710.117,526.738-1191.601,593.071l-67.109,8.584l-24.199,52.28c-60.864,130.322-177.139,204.453-321.509,204.453 ";b+="c-156.846,0-280.918-85.84-333.208-229.419l-16.382-46.826l-69.458-13.267C1700.005,7390.258,1209.165,7065.634,932.915,6606 ";b+="c-26.533-44.473-53.843-85.054-60.869-89.736c-6.24-5.459-28.872-32.773-50.723-60.869c-24.976-32.773-40.581-47.598-43.701-41.362 ";b+="c-14.824,26.538-24.189,172.461-20.288,309.023c3.125,113.149,8.584,166.221,24.971,242.695 ";b+="c53.062,254.395,165.439,490.059,333.989,698.418c63.994,79.6,216.943,227.861,298.1,290.293 ";b+="c322.285,245.029,714.024,392.515,1131.514,426.851C2629.409,8387.563,2932.182,8378.979,3025.053,8367.27z M2803.427,7740.644 ";b+="c145.142-45.259,241.133-200.552,214.595-347.261c-25.747-139.688-125.63-239.57-266.094-264.541 ";b+="c-105.347-18.726-227.871,30.43-294.976,120.171c-132.666,174.805-54.624,426.079,151.387,491.631 ";b+="C2679.35,7763.275,2730.854,7763.275,2803.427,7740.644z M3149.121,7483.905c703.887-112.373,1236.084-513.472,1421.816-1070.649 ";b+="c65.547-196.646,82.715-353.5,74.902-688.276c-3.105-122.515-8.574-274.683-12.471-339.448 ";b+="c-5.469-91.309-4.688-142.808,4.668-234.111c9.365-85.84,11.709-169.336,8.594-316.045c-3.125-199.766-12.49-291.074-42.93-421.396 ";b+="l-13.252-58.525l-44.492-17.168c-56.182-22.622-236.436-58.521-427.637-85.825c-138.115-19.512-173.232-21.074-386.269-21.855 ";b+="c-189.629,0-251.279,3.125-323.848,14.043c-109.253,17.949-245.034,52.285-313.706,79.59l-49.937,20.298l-29.658,71.006 ";b+="c-38.237,94.424-82.72,168.564-128.76,216.172l-38.232,39.014l78.813,2.344c73.359,2.324,79.6,3.115,79.6,17.939 ";b+="c0,15.605-4.683,15.605-245.82,13.271c-280.923-1.563-323.843-5.469-323.843-28.887c0-14.824,4.683-15.596,78.032-13.262 ";b+="l78.042,2.344l-23.418-17.949c-80.371-60.869-142.021-144.365-179.478-239.57c-20.293-50.723-24.194-56.172-49.941-63.213 ";b+="c-372.231-99.097-817.031-112.358-1200.967-34.331c-193.535,39.019-326.191,94.419-351.157,145.923 ";b+="c-19.517,40.586-54.629,195.879-63.999,285.625c-13.267,117.051-6.235,250.488,20.293,384.707l21.064,106.914l-16.382,88.955 ";b+="c-28.091,148.267-35.117,240.347-30.435,395.645c5.459,152.944,17.168,251.274,48.384,378.471 ";b+="c162.314,678.13,702.319,1180.674,1455.361,1354.697c139.687,31.997,130.322,35.112,134.228-41.357 ";b+="c3.115-53.066,8.574-74.917,29.648-119.399c51.504-107.686,161.538-188.062,268.442-196.65l51.499-4.678v-168.555 ";b+="c0-92.866,3.125-173.247,7.031-179.487c3.901-6.24,12.48-8.584,19.512-6.24c10.918,4.683,12.48,26.533,12.48,180.264v174.795 ";b+="l34.336,4.683c92.856,14.048,199.771,98.33,246.592,195.088c24.185,48.389,27.31,63.213,29.653,131.104 ";b+="c2.339,42.139,6.24,76.475,10.142,76.475C3069.521,7496.391,3106.987,7490.927,3149.121,7483.905z M790.107,6310.248 ";b+="c-53.843-137.339-89.741-309.018-109.248-523.613l-4.683-52.29l-67.891-3.12c-37.456-2.339-69.453-3.12-71.016-1.563 ";b+="c-3.896,3.901,53.066,172.461,98.33,287.954c53.843,137.338,161.533,354.282,170.898,344.917 ";b+="C808.057,6360.976,801.03,6337.558,790.107,6310.248z M4773.056,5893.535c42.91-109.248,78.809-199.771,78.809-201.328 ";b+="c0-1.563-39.014-3.12-86.621-3.901l-87.402-0.776l4.688,98.32c2.344,54.624,2.344,150.61-0.781,214.6 ";b+="c-3.906,85.84-3.125,112.373,3.125,103.007C4690.322,6096.43,4729.345,6002.006,4773.056,5893.535z M679.297,5581.391 ";b+="c3.12-61.641,14.829-165.43,25.752-230.977l19.512-119.399l-16.387-82.72c-8.589-45.259-18.73-112.368-21.851-149.043 ";b+="l-5.464-66.328l-28.872-7.031c-38.242-9.355-135.781,9.365-196.65,38.242c-126.421,59.307-215.376,202.114-215.376,343.354 ";b+="c0,109.253,35.894,195.869,113.149,273.13c74.131,74.131,162.314,110.811,266.099,112.368l55.41,0.776L679.297,5581.391z ";b+=" M4854.208,5643.046c251.27-53.062,382.373-330.093,266.094-559.517c-44.482-87.402-150.615-172.461-248.154-198.203 ";b+="c-42.139-11.709-158.408-14.834-173.232-4.688c-5.469,3.115-10.928,53.848-14.043,130.313 ";b+="c-3.125,68.677-8.594,149.834-12.49,179.492c-7.031,48.379,3.115,418.267,11.699,446.362 ";b+="C4689.55,5654.75,4782.412,5658.652,4854.208,5643.046z M821.323,4371.069c169.336-101.44,623.501-167.788,995.737-145.933 ";b+="c171.675,10.918,312.925,29.648,444.023,60.078c49.155,11.719,96.763,21.855,105.347,22.656 ";b+="c33.55,2.324,78.032-138.125,77.251-241.152c-1.553-167.773-91.299-231.758-412.807-296.543 ";b+="c-195.874-39.004-287.173-46.816-550.151-46.816c-269.224,0-341.792,7.031-515.81,50.742 ";b+="c-165.439,41.348-278.589,96.758-341.802,169.336c-80.381,91.289-71.792,220.059,24.976,344.121 ";b+="c30.435,39.805,108.472,110.815,122.515,110.815C773.726,4398.374,796.348,4385.893,821.323,4371.069z M4685.644,4296.152 ";b+="c95.986-62.422,166.221-164.648,172.451-251.27c5.479-67.891-10.137-109.258-57.734-161.543 ";b+="c-94.434-101.445-290.293-163.086-600.088-188.066c-248.164-20.293-771.777,12.5-959.848,60.078 ";b+="c-71.006,18.75-154.507,60.098-195.088,97.559c-88.179,81.152-107.686,197.422-57.744,344.922 ";b+="c25.752,77.246,45.264,109.238,60.083,102.227c78.037-35.117,217.725-71.016,360.527-92.871 ";b+="c113.926-17.168,384.707-24.18,523.613-12.48c262.207,21.855,581.377,79.59,654.726,117.832 ";b+="C4624.775,4333.608,4631.025,4332.055,4685.644,4296.152z ";a.createChildNS("path",{d:b,fill:"RGBA(0,0,0,0.2)"})}};function SettingMenu(a){this.pane=a;this.width=200;this.title="Settings"}SettingMenu.prototype={renderInto:function(c){var i=this;var a=c.createChild("div",{"class":"menu-item setting-menu",title:this.title});var g=a.createChild("div",{});this.pane.render32pxSvgIcon(g,"ICON32_MENU_Option");var k=a.createChild("div",{"class":"sub-container",style:"width: {0}px;".format(this.width)});k.createChild("div",{"class":"sub-title no-select"},this.title);var l=k.createChild("div",{"class":"sub-body"});var e=l.createChild("div",{"class":"sub-items"});var h=this.renderCheckBox(e,"Lock Selected Tool","Config.General.lockTool",null);var j=null;var f=0;var b=6;var d=3;h.addEventListener("click",function(){f++;console.log(f);if(f>=b+d){if(j!=null){i.getWorkspace().switchDeveloperMode(false);i.getWorkspace().drawingBoard.showMessage("Cancel developer mode");j.destroy();j=null}f=0;i.pane.selectMenuItem(null)}if(f==b-1){i.getWorkspace().switchDeveloperMode(true);i.getWorkspace().drawingBoard.showMessage("Start developer mode")}if(f>=b){if(j==null){var p=i.getWorkspace().drawingBoard.underGroup;var n=i.getWorkspace().drawingBoard.svgSize.width;var m=i.getWorkspace().drawingBoard.svgSize.height;j=new Stage(p,n,m)}function o(){j.addIcon();if(j.icons.length<2){setTimeout(o,1000)}}o()}},false);this.renderCheckBox(e,"Snap to Grids","Config.General.snapToGrid",null);this.renderCheckBox(e,"Show Scale Rulers","Config.General.showScale",function(){i.getWorkspace().showScalePlate(Config.General.showScale)});this.renderCheckBox(e,"Objects Manager","Config.General.showObjectManager",function(){i.getWorkspace().objectManager.show(Config.General.showObjectManager)});g.addEventListener("click",function(){i.pane.selectMenuItem(this.parentNode)},false);return a},getWorkspace:function(){return this.pane.workspace},getDrawingBoard:function(){return this.pane.workspace.drawingBoard},renderMenuItem:function(wrapper,label,configKey,callback){var button=wrapper.createChild("div",{"class":"text-item no-select"},label);button.addEventListener("click",function(e){if(this.hasClassName("selected")){this.removeClassName("selected");eval(configKey+" = false")}else{this.addClassName("selected");eval(configKey+" = true")}if(typeof callback=="function"){callback()}},false);if(eval(configKey)){button.addClassName("selected")}},renderCheckBox:function(wrapper,label,configKey,callback){var button=wrapper.createChild("div",{"class":"checkbox-item no-select"},label);var icon=button.createChildNS("svg",{"class":"icon-checkbox",width:24,height:24});var gChecked=icon.createChildNS("g",{"class":"icon-group-checked"});gChecked.createChildNS("path",{fill:"#ffffff",d:"M6.534,9.467l-1.867,1.867l6,6L24,4l-1.865-1.867L10.667,13.6L6.534,9.467z M21.334,21.333H2.667V2.667H16V0H2.667C1.201,0,0,1.2,0,2.667v18.667C0,22.8,1.201,24,2.667,24h18.667C22.801,24,24,22.8,24,21.333V10.667h-2.666V21.333z"});var gNormal=icon.createChildNS("g",{"class":"icon-group-normal"});gNormal.createChildNS("path",{fill:"#010101",d:"M21.333,2.667v18.667H2.667V2.667H21.333 M21.333,0H2.667C1.2,0,0,1.201,0,2.667v18.667C0,22.801,1.2,24,2.667,24h18.667C22.8,24,24,22.801,24,21.334V2.667C24,1.201,22.8,0,21.333,0L21.333,0z"});button.addEventListener("click",function(e){if(this.hasClassName("selected")){this.removeClassName("selected");eval(configKey+" = false")}else{this.addClassName("selected");eval(configKey+" = true")}if(typeof callback=="function"){callback()}},false);if(eval(configKey)){button.addClassName("selected")}return button}};function SlidePane(a){this.workspace=a;this.appMenu=null;this.toolMenu=null;this.fillMenu=null;this.strokeMenu=null;this.settingMenu=null;this.propertyMenu=null;this.wrapper=null;this.menuDoms=[];this.selectedMenuDom=null}SlidePane.prototype={renderIntoWorkspace:function(){var b=this;this.wrapper=this.workspace.getWrapper().createChild("div",{id:"slide-pane",style:"left: {0}px; top: {1}px".format(Config.SlidePane.left,Config.SlidePane.top)});this.appMenu=new AppMenu(this);this.menuDoms.push(this.appMenu.renderInto(this.wrapper));this.toolMenu=new ToolMenu(this);this.menuDoms.push(this.toolMenu.renderInto(this.wrapper));this.fillMenu=new ColorMenu(this,false);this.menuDoms.push(this.fillMenu.renderInto(this.wrapper));this.strokeMenu=new ColorMenu(this,true);this.menuDoms.push(this.strokeMenu.renderInto(this.wrapper));this.settingMenu=new SettingMenu(this);this.menuDoms.push(this.settingMenu.renderInto(this.wrapper));this.propertyMenu=new PropertyMenu(this);this.menuDoms.push(this.propertyMenu.renderInto(this.wrapper));var c=new SampleMenu(this);this.menuDoms.push(c.renderInto(this.wrapper));var a=QStage.supportsTransitions();this.wrapper.style[a.prefixedProperty]="top 0.2s ease-in";this.wrapper.addEventListener(a.prefixedEventName,function(){})},setMargin:function(b,a){this.wrapper.updateStyle("left",Config.SlidePane.left+b+"px");this.wrapper.updateStyle("top",Config.SlidePane.top+a+"px")},reset:function(){this.selectMenuItem(null)},resize:function(c,a){for(var b=0;b<this.menuDoms.length;b++){var d=this.menuDoms[b];if(d.hasClassName("menu-selected")){d.removeClassName("menu-selected")}}this.wrapper.updateStyle("top",Config.SlidePane.top+"px");this.fillMenu.resize(c,a);this.strokeMenu.resize(c,a)},selectMenuItem:function(a){if(this.selectedMenuDom==a){if(this.selectedMenuDom!=null){this.selectedMenuDom.removeClassName("menu-selected");this.selectedMenuDom=null}}else{if(this.selectedMenuDom!=null){this.selectedMenuDom.removeClassName("menu-selected")}if(a!=null){a.addClassName("menu-selected")}this.selectedMenuDom=a}if(this.workspace.isSmallScreen()||Config.General.developerMode){if(this.selectedMenuDom!=null){var b=-this.selectedMenuDom.offsetTop+Config.SlidePane.top+4;this.wrapper.updateStyle("top",b+"px")}else{this.wrapper.updateStyle("top",Config.SlidePane.top+"px")}}},selectToolType:function(a){this.toolMenu.selectToolType(a)},showPropertyMenu:function(a){this.propertyMenu.showProperty(a)},setFill:function(a,b){this.fillMenu.setData(a,b,null)},setStroke:function(a,b,c){this.strokeMenu.setData(a,b,c)},addSeperator:function(c,a){var b=c.createChild("div",{"class":"seperator"});b.createChild("div",{"class":"seperator-line"});b.createChild("div",{"class":"seperator-label"},a)},renderIconButton:function(h,e,g,c,f){var d=this;var a=h.createChild("div",{"class":"icon-item no-select"});var b=a.createChild("div",{"class":"icon"});a.createChild("div",{"class":"label"},e);this.render24pxSvgIcon(b,g);a.addEventListener("click",function(i){if(typeof f=="function"){f()}if(c){d.selectMenuItem(null)}},false)},render24pxSvgIcon:function(f,e){var a=f.createChildNS("svg",{"class":"icon-svg-24px",width:24,height:24});var b=a.createChildNS("g");switch(e){case"ICON24_HOME":b.createChildNS("path",{fill:"#434A4D",stroke:"none",d:"M3.263,22.096c0,0-0.021,0.537,0.503,0.537c0.652,0,6.05-0.008,6.05-0.008l0.009-4.957c0,0-0.085-0.818,0.708-0.818h2.51c0.938,0,0.88,0.818,0.88,0.818l-0.011,4.941c0,0,5.118,0,5.922,0c0.666,0,0.635-0.668,0.635-0.668v-9.139l-8.346-7.425l-8.86,7.425V22.096z"});b.createChildNS("path",{fill:"#434A4D",stroke:"none",d:"M0,12.111c0,0,0.752,1.387,2.393,0l9.804-8.295l9.192,8.243c1.899,1.37,2.61,0,2.61,0L12.197,1.367L0,12.111z"});b.createChildNS("polygon",{fill:"#434A4D",stroke:"none",points:"21.166,3.797 18.803,3.797 18.813,6.664 21.166,8.662"});break;case"ICON24_SAVE":b.createChildNS("path",{fill:"#434A4D",stroke:"none",d:"M19.5,0H18v9.75H6V0H0v24h24V4.5L19.5,0z M21,22.5H3V12h18V22.5z"});b.createChildNS("rect",{fill:"#434A4D",stroke:"none",x:4.5,y:13.5,width:15,height:1.5});b.createChildNS("rect",{fill:"#434A4D",stroke:"none",x:4.5,y:16.5,width:15,height:1.5});b.createChildNS("rect",{fill:"#434A4D",stroke:"none",x:4.5,y:19.5,width:15,height:1.5});b.createChildNS("rect",{fill:"#434A4D",stroke:"none",x:13.5,y:1.5,width:3,height:6.75});break;case"ICON24_PLAY":var c="";c+="M6,2L6,22L20,12z";b.createChildNS("path",{fill:"#434A4D",stroke:"none",d:c});break;case"ICON24_SHARE":var c="";c+="M19.229,16.965c-0.916,0-1.734,0.359-2.359,0.926l-8.593-4.999c0.063-0.277,0.11-0.557,0.11-0.845";c+="s-0.049-0.566-0.11-0.844l8.497-4.951c0.646,0.6,1.504,0.975,2.455,0.975c2.002,0,3.617-1.611,3.617-3.614";c+="C22.846,1.615,21.23,0,19.229,0c-2,0-3.615,1.615-3.615,3.613c0,0.292,0.049,0.566,0.111,0.844L7.228,9.412";c+="C6.579,8.809,5.723,8.435,4.771,8.435c-2.003,0-3.617,1.614-3.617,3.613c0,2,1.614,3.615,3.617,3.615";c+="c0.95,0,1.808-0.375,2.455-0.975l8.578,5.008c-0.059,0.256-0.096,0.521-0.096,0.787c0,1.939,1.58,3.518,3.518,3.518";c+="c1.939,0,3.521-1.578,3.521-3.518C22.748,18.541,21.166,16.965,19.229,16.965z";b.createChildNS("path",{fill:"#434A4D",stroke:"none",d:c});break;case"ICON24_NEW":var c="";c+="M20.294,5.87h-5.229V0.641c0-0.347-0.281-0.628-0.627-0.628H3.665c-0.347,0-0.628,0.282-0.628,0.628";c+="v22.731C3.037,23.718,3.318,24,3.665,24h16.629c0.348,0,0.629-0.282,0.629-0.628V6.498C20.923,6.151,20.642,5.87,20.294,5.87z";b.createChildNS("path",{fill:"#434A4D",stroke:"none",d:c});var c="";c+="M17.144,4.354h3.283c0.219,0,0.412-0.129,0.496-0.33c0.082-0.201,0.037-0.43-0.117-0.583l-3.285-3.285";c+="C17.419,0.056,17.286,0,17.142,0c-0.07,0-0.139,0.013-0.203,0.041c-0.201,0.083-0.332,0.277-0.332,0.494v3.285";c+="C16.606,4.114,16.849,4.354,17.144,4.354z";b.createChildNS("path",{fill:"#434A4D",stroke:"none",d:c});break;case"ICON24_DOWNLOAD":var c="";c+="M19.399,10C18.7,6.6,15.7,4,12,4C9.1,4,6.6,5.6,5.4,8C2.3,8.4,0,10.9,0,14c0,3.301,2.7,6,6,6h13";c+="c2.8,0,5-2.199,5-5C24,12.4,21.9,10.2,19.399,10z M17,13l-5,5l-5-5h3V9h4v4H17z";b.createChildNS("path",{fill:"#434A4D",stroke:"none",d:c});break}return a},render32pxSvgIcon:function(f,c){var v=f.createChildNS("svg",{"class":"icon-svg-32px",width:32,height:32});var t=v.createChildNS("g");switch(c){case"ICON32_MENU_App":var o=32;var m=o*10/300;var p="M{0},{1} H{2} L {3},{4} H {0} Z".format(o/3+m,m,o*2/3,o-m,o/3-m);t.createChildNS("path",{fill:"#22CB20",stroke:"#22CB20","stroke-width":m,"stroke-linejoin":"round",d:p});t.createChildNS("path",{fill:"#06ACD4",stroke:"#06ACD4","stroke-width":m,"stroke-linejoin":"round",d:p,transform:"translate(0,0), rotate({1},{0},{0})".format(o/2,1*90)});t.createChildNS("path",{fill:"#FFCC00",stroke:"#FFCC00","stroke-width":m,"stroke-linejoin":"round",d:p,transform:"translate(0,0), rotate({1},{0},{0})".format(o/2,2*90)});t.createChildNS("path",{fill:"#FA5151",stroke:"#FA5151","stroke-width":m,"stroke-linejoin":"round",d:p,transform:"translate(0,0), rotate({1},{0},{0})".format(o/2,3*90)});break;case"ICON32_MENU_Option":var w="";w+="M17.8,31.7h-3.4c-0.5,0-0.7,0-2.4-4.3l-1.3-0.5c-3.6,1.6-4.1,1.6-4.2,1.6H6.2l-0.2-0.2L3.5,26 ";w+="c-0.4-0.4-0.5-0.5,1.4-4.7L4.4,20C0,18.4,0,18.2,0,17.7v-3.3c0-0.5,0-0.7,4.4-2.4l0.5-1.3c-2-4.2-1.8-4.3-1.4-4.6L6,3.6l0.3,0 ";w+="c0.4,0,1.8,0.5,4.3,1.6l1.3-0.5c1.6-4.3,1.8-4.3,2.3-4.3h3.4c0.5,0,0.7,0,2.4,4.3l1.3,0.5c3.6-1.6,4.1-1.6,4.2-1.6h0.3l0.2,0.2 ";w+="L28.4,6c0.4,0.4,0.5,0.5-1.4,4.7l0.5,1.3c4.4,1.6,4.4,1.7,4.4,2.3v3.3c0,0.5,0,0.7-4.4,2.4l-0.5,1.3c2,4.1,1.8,4.3,1.5,4.6 ";w+="L26,28.4l-0.3,0c-0.4,0-1.8-0.5-4.3-1.6l-1.3,0.5C18.4,31.7,18.3,31.7,17.8,31.7z M14.7,30.3h2.7c0.3-0.6,1-2.3,1.5-3.7 ";w+="l0.1-0.3l2.4-1l0.3,0.1c1.4,0.6,3.1,1.3,3.8,1.5l1.9-1.8c-0.2-0.7-1-2.3-1.6-3.6l-0.1-0.3l1-2.4l0.3-0.1 ";w+="c1.5-0.6,3.1-1.3,3.8-1.6v-2.6c-0.6-0.3-2.3-0.9-3.8-1.5l-0.3-0.1l-1-2.4l0.1-0.3c0.6-1.4,1.3-3,1.5-3.7l-1.9-1.8 ";w+="c-0.6,0.2-2.3,0.9-3.7,1.6l-0.3,0.1l-2.4-1l-0.1-0.3c-0.6-1.4-1.3-3.1-1.6-3.7h-2.7c-0.3,0.6-1,2.3-1.5,3.7L13,5.6l-2.4,1 ";w+="l-0.3-0.1C8.9,5.9,7.2,5.2,6.5,5L4.7,6.8c0.2,0.7,1,2.3,1.6,3.6l0.1,0.3l-1,2.4l-0.3,0.1c-1.5,0.6-3.1,1.2-3.8,1.6v2.6 ";w+="c0.6,0.3,2.3,0.9,3.8,1.5l0.3,0.1l1,2.4l-0.1,0.3c-0.6,1.4-1.3,3-1.5,3.7l1.9,1.8c0.6-0.2,2.3-0.9,3.7-1.6l0.3-0.1l2.4,1 ";w+="l0.1,0.3C13.7,28.1,14.4,29.7,14.7,30.3z M16,21.5c-3.1,0-5.6-2.5-5.6-5.5c0-3,2.5-5.5,5.6-5.5c3.1,0,5.6,2.5,5.6,5.5 ";w+="C21.6,19,19.1,21.5,16,21.5z M16,11.9c-2.3,0-4.2,1.8-4.2,4.1c0,2.3,1.9,4.1,4.2,4.1c2.3,0,4.2-1.9,4.2-4.1 ";w+="C20.2,13.7,18.3,11.9,16,11.9z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"#FFFFFF","stroke-width":1,d:w});break;case"ICON32_MENU_Property":t.createChildNS("circle",{fill:"none",stroke:"#FFFFFF","stroke-width":2,cx:16,cy:16,r:15,});t.createChildNS("circle",{fill:"#FFFFFF",stroke:"none",cx:8,cy:16,r:2,});t.createChildNS("circle",{fill:"#FFFFFF",stroke:"none",cx:16,cy:16,r:2,});t.createChildNS("circle",{fill:"#FFFFFF",stroke:"none",cx:24,cy:16,r:2,});break;case"ICON32_TOOL_Picker":t.createChildNS("polygon",{fill:"none",stroke:"#FFFFFF","stroke-width":2,points:"8.5,2 25,17.9 16.8,17.9 22,30.2 19.5,31.2 14.3,19 8.5,24.7"});break;case"ICON32_TOOL_Move":var w="";w+="M31.917,15.593l-0.229-0.346l-4.267-4.267c-0.416-0.416-1.094-0.416-1.508,0";w+="c-0.416,0.416-0.416,1.092,0,1.508l2.444,2.445H17.066V3.642l2.445,2.445c0.414,0.416,1.092,0.416,1.508,0";w+="c0.414-0.416,0.414-1.092,0-1.508l-4.267-4.267l-0.011-0.006l-0.335-0.222L16,0h-0.004l-0.403,0.083l-0.335,0.222l-0.013,0.006";w+="l-4.267,4.267c-0.416,0.416-0.416,1.092,0,1.508s1.092,0.416,1.508,0l2.447-2.445v11.292H3.642l2.445-2.445";w+="c0.416-0.416,0.416-1.092,0-1.508s-1.092-0.416-1.508,0l-4.267,4.267l-0.006,0.011l-0.222,0.335L0,16v0.004l0.083,0.403";w+="l0.222,0.333l0.006,0.013l4.267,4.266c0.416,0.416,1.092,0.416,1.508,0c0.416-0.414,0.416-1.092,0-1.508l-2.445-2.445h11.292";w+="v11.293l-2.445-2.445c-0.416-0.414-1.092-0.414-1.508,0c-0.416,0.416-0.416,1.094,0,1.508l4.267,4.268l0.346,0.23L15.996,32H16";w+="l0.407-0.082l0.346-0.229l4.267-4.268c0.414-0.416,0.414-1.094,0-1.508c-0.416-0.416-1.094-0.416-1.508,0l-2.445,2.445V17.066";w+="h11.292l-2.444,2.445c-0.414,0.414-0.414,1.092,0,1.508c0.416,0.414,1.094,0.414,1.508,0l4.267-4.266l0.23-0.346L32,16.004V16";w+="L31.917,15.593z";t.createChildNS("path",{fill:"#ffffff",d:w});break;case"ICON32_TOOL_Crop":t.createChildNS("path",{fill:"none",stroke:"#FFFFFF","stroke-width":2,d:"M2,8 V2 H8 M24,2 H30 V8 M30,24 V30 H24 M8,30 H2 V24 M16,12 V20 M12,16 H 20"});break;case"ICON32_TOOL_Rectangle":t.createChildNS("path",{fill:"#ffffff",d:"M0,0v32h32V0H0z M30,30H2L2,2l28,0V30z"});break;case"ICON32_TOOL_Ellipse":t.createChildNS("path",{fill:"#ffffff",d:"M16,0C7.2,0,0,7.2,0,16s7.2,16,16,16c8.8,0,16-7.2,16-16S24.8,0,16,0z M16,30C8.2,30,2,23.8,2,16 S8.2,2,16,2c7.7,0,14,6.3,14,14S23.7,30,16,30z"});break;case"ICON32_TOOL_Line":t.createChildNS("rect",{x:0,y:15,width:32,height:2,fill:"#ffffff"});break;case"ICON32_TOOL_Polygon":var w="";var h=5;var u=16;var b=16;var n=15;var e=2*Math.PI/h;var a=-90/180*Math.PI;for(var s=0;s<h;s++){var l=e*s+a;var k=u+n*Math.cos(l);var j=b+n*Math.sin(l);var q=s==0?"M{0},{1}":" L{0},{1}";w+=q.format(k.toFixed(2),j.toFixed(2))}w+=" Z";t.createChildNS("path",{fill:"none",stroke:"#FFFFFF","stroke-width":2,d:w,"stroke-linecap":"butt","stroke-linejoin":"miter"});break;case"ICON32_TOOL_Pencil":t.createChildNS("path",{fill:"#ffffff",d:"M9.3,1.4L9.3,1.4L0,0l1.3,9.2l0,0l0,0l0,0l0,0L24.1,32l1.5-1.5l6.4-6.4L9.3,1.4z M2.4,2.5l4.4,1.2 L3.7,6.9L2.4,2.5z M4.5,9.5l4.8-4.8l14,14l-4.8,4.8L4.5,9.5z M23.9,28.8l-3.5-3.5l4.8-4.8l3.5,3.5L23.9,28.8z"});break;case"ICON32_TOOL_Pen":var w="";w+="M26.477,15.592l-3.056-8.343c-0.13-0.351-0.531-0.639-0.894-0.639H10.5";w+="c-0.363,0-0.765,0.288-0.894,0.639L6.55,15.592c-0.129,0.351-0.095,0.91,0.075,1.242l6.887,13.971";w+="c0.17,0.332,0.606,0.603,0.968,0.603h0.896c0.363,0,0.649-0.307,0.637-0.681l-0.208-13.733";w+="c-0.013-0.376-0.264-0.862-0.559-1.082c0,0-1.201-0.894-1.201-2.041c0-1.411,1.105-2.555,2.469-2.555";w+="c1.364,0,2.468,1.144,2.468,2.555c0,1.147-1.2,2.041-1.2,2.041c-0.295,0.22-0.547,0.706-0.561,1.082l-0.227,13.749";w+="c-0.013,0.376,0.272,0.684,0.635,0.684h0.926c0.363,0,0.798-0.271,0.969-0.604l6.879-13.989";w+="C26.572,16.502,26.605,15.943,26.477,15.592z";t.createChildNS("path",{fill:"none",stroke:"#FFFFFF","stroke-width":2,d:w});w="";w+="M9.397,5.292h14.231c0.361,0,0.66-0.307,0.66-0.682V1.257c0-0.375-0.299-0.683-0.66-0.683";w+="H9.397c-0.363,0-0.66,0.307-0.66,0.683V4.61C8.738,4.985,9.034,5.292,9.397,5.292z";t.createChildNS("path",{fill:"none",stroke:"#FFFFFF","stroke-width":2,d:w});break;case"ICON32_TOOL_Label":t.createChildNS("polygon",{style:"fill:#FFFFFF;",points:"23.91,10.705 23.91,12.348 30.359,12.348 30.359,21.393 23.91,21.393 23.91,23.033 32,23.033 32,10.705"});t.createChildNS("polygon",{style:"fill:#FFFFFF;",points:"17.599,21.393 1.641,21.393 1.641,12.348 17.599,12.348 17.599,10.705 0,10.705 0,23.033 17.599,23.033"});var w="";w+="M21.942,26.466c-0.067-0.069-0.114-0.147-0.153-0.249V7.854l-0.005-0.125";w+="c0.032-0.16,0.098-0.292,0.204-0.403C22.302,7,22.912,6.93,23.369,6.93h0.854V4.794";w+="h-0.854c-1.096,0-1.979,0.264-2.631,0.784c-0.655-0.556-1.561-0.837-2.689-0.837";w+="h-0.855v2.138h0.855c0.454,0,1.064,0.067,1.379,0.396c0.068,0.069,0.121,0.154,0.155,0.251";w+="v18.403c0,0.012-0.002,0.31-0.223,0.537c-0.316,0.329-0.927,0.4-1.384,0.4h-0.854V29h0.854";w+="c1.121,0,2.02-0.276,2.674-0.819C21.306,28.728,22.202,29,23.32,29h0.857v-2.134H23.32";w+="C22.864,26.864,22.256,26.795,21.942,26.466z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});break;case"ICON32_TOOL_Map":var w="";w+="M10.866,17.107c1.119,0,2.025,0.906,2.025,2.025c0,1.117-0.907,2.025-2.025,2.025S8.84,20.25,8.84,19.133";w+="C8.84,18.014,9.747,17.107,10.866,17.107z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});w="";w+="M30.59,18.734l1.373-10.828l-9.852-3.738L10.295,9.813L0,5.465l1.39,11.551L0.058,28.389l10.938,2.053";w+="l11.158-2.125L32,30.588L30.59,18.734z M22.074,5.315l8.727,3.288l-0.602,4.734l-8.695-2.2L22.074,5.315z M20.92,5.917";w+="l-0.459,4.957l-0.008-0.002l-6.022,0.777l-0.036,0.133c-0.008,0.029-0.706,2.61-1.442,3.784c-0.477-0.28-1.012-0.468-1.585-0.538";w+="l-0.488-4.316L20.92,5.917z M20,16.973l-5.233,0.789c-0.282-0.797-0.799-1.481-1.471-1.971c0.685-1.094,1.304-3.211,1.459-3.77";w+="l5.667-0.731L20,16.973z M9.815,10.764l0.484,4.274c-1.591,0.219-2.896,1.342-3.374,2.835l-4.462-0.691l-0.429-4.139";w+="c1.479-0.098,2.589-0.579,3.3-1.438c0.641-0.773,0.826-1.688,0.861-2.37L9.815,10.764z M1.288,7.163l4.499,1.9";w+="c-0.013,0.627-0.155,1.538-0.769,2.279c-0.641,0.773-1.661,1.206-3.036,1.292L1.288,7.163z M1.23,27.527l1.107-9.289l4.401,0.682";w+="c-0.003,0.07-0.01,0.141-0.01,0.213c0,0.967,0.336,1.857,0.896,2.563l-2.286,1.836l-0.72,4.631L1.23,27.527z M9.853,29.145";w+="l-4.832-0.906l0.698-4.488l2.175-1.746c0.667,0.691,1.57,1.15,2.579,1.246L9.853,29.145z M7.549,19.133";w+="c0-1.83,1.488-3.317,3.316-3.317c1.83,0,3.317,1.487,3.317,3.317c0,1.828-1.488,3.316-3.317,3.316";w+="C9.037,22.449,7.549,20.961,7.549,19.133z M10.995,29.359l-0.093-0.018l0.646-6.133c1.958-0.326,3.457-2.027,3.457-4.076";w+="c0-0.111-0.008-0.221-0.017-0.328l5.116-0.771l0.428,4.363c-2.244,0.104-3.922,0.795-4.979,2.068";w+="c-1.231,1.488-1.289,3.342-1.226,4.26L10.995,29.359z M14.737,28.646c-0.05-0.871,0.022-2.578,1.132-3.918";w+="c0.982-1.186,2.567-1.826,4.702-1.924l0.455,4.643L14.737,28.646z M21.465,11.551l8.684,2.196l-0.52,4.103l-8.574-1.035";w+="L21.465,11.551z M28.447,21.393l-3.951-0.469l0.725,7.008l-3.166-0.68l-0.898-9.377l0.092-0.014l8.289,1.051l1.227,10.301";w+="l-5.129-1.184l-0.678-6.637l3.521,0.408L28.447,21.393z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});break;case"ICON32_TOOL_Poi":var w="";w+="M16.791,0c-5.988,0-10.86,4.872-10.86,10.86c0,2.406,1.417,6.065,4.459,11.517";w+="c2.076,3.72,4.142,6.861,4.229,6.994l1.493,2.264C16.262,31.862,16.518,32,16.791,32s0.528-0.138,0.679-0.365l1.494-2.264";w+="c0.086-0.131,2.137-3.245,4.229-6.994c3.042-5.45,4.459-9.11,4.459-11.517C27.651,4.872,22.779,0,16.791,0z M21.771,21.584";w+="c-2.063,3.696-4.081,6.762-4.166,6.891l-0.814,1.234l-0.814-1.234c-0.085-0.13-2.12-3.223-4.167-6.891";w+="C8.989,16.528,7.558,12.92,7.558,10.86c0-5.091,4.142-9.233,9.233-9.233s9.232,4.142,9.232,9.233";w+="C26.023,12.92,24.593,16.528,21.771,21.584z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});w="";w+="M16.791,4.771c-3.32,0-6.021,2.701-6.021,6.021c0,3.32,2.701,6.021,6.021,6.021s6.021-2.701,6.021-6.021";w+="C22.813,7.472,20.111,4.771,16.791,4.771z M16.791,15.187c-2.423,0-4.394-1.971-4.394-4.394s1.971-4.394,4.394-4.394";w+="s4.394,1.971,4.394,4.394S19.214,15.187,16.791,15.187z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});break;case"ICON32_TOOL_Block":var w="";w+="M28.405,4.527h-9.918C18.218,4.527,18,4.746,18,5.015v1.46c0,0.269,0.218,0.487,0.487,0.487h9.918";w+="c0.641,0,1.161,0.521,1.161,1.162v16.095c0,0.641-0.521,1.16-1.161,1.16h-9.918c-0.27,0-0.487,0.219-0.487,0.488v1.457";w+="c0,0.27,0.218,0.49,0.487,0.49h9.918c1.982,0,3.595-1.615,3.595-3.596V8.124C32,6.141,30.387,4.527,28.405,4.527z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});w="";w+="M3.595,27.813h9.918c0.27,0,0.487-0.218,0.487-0.487v-1.461c0-0.268-0.218-0.486-0.487-0.486H3.595";w+="c-0.641,0-1.161-0.521-1.161-1.162V8.123c0-0.642,0.521-1.16,1.161-1.16h9.918c0.27,0,0.487-0.219,0.487-0.489V5.016";w+="c0-0.27-0.218-0.489-0.487-0.489H3.595C1.612,4.527,0,6.141,0,8.123v16.094C0,26.2,1.613,27.813,3.595,27.813z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:"M15,9h2v14h-2V9z"});break;case"ICON32_TOOL_Eraser":var w="";w+="M28.405,4.527h-9.918C18.218,4.527,18,4.746,18,5.015v1.46c0,0.269,0.218,0.487,0.487,0.487h9.918";w+="c0.641,0,1.161,0.521,1.161,1.162v16.095c0,0.641-0.521,1.16-1.161,1.16h-9.918c-0.27,0-0.487,0.219-0.487,0.488v1.457";w+="c0,0.27,0.218,0.49,0.487,0.49h9.918c1.982,0,3.595-1.615,3.595-3.596V8.124C32,6.141,30.387,4.527,28.405,4.527z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});w="";w+="M3.595,27.813h9.918c0.27,0,0.487-0.218,0.487-0.487v-1.461c0-0.268-0.218-0.486-0.487-0.486H3.595";w+="c-0.641,0-1.161-0.521-1.161-1.162V8.123c0-0.642,0.521-1.16,1.161-1.16h9.918c0.27,0,0.487-0.219,0.487-0.489V5.016";w+="c0-0.27-0.218-0.489-0.487-0.489H3.595C1.612,4.527,0,6.141,0,8.123v16.094C0,26.2,1.613,27.813,3.595,27.813z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});break;default:var w="";w+="M31.732,6.211l0.023-0.058L16.37,0L9.131,2.797l-0.046-0.02L9.064,2.824l-8.78,3.393L0.232,6.197v0.04";w+="L0.23,6.237l0.002,0.006v19.735l15.205,5.998V32h1.127v-0.023l15.205-5.998V6.197L31.732,6.211z M30.643,16.468l-6.395,2.346";w+="v-8.439l6.395-2.523V16.468z M15.438,13.405v8.231l-6.513-2.355v-8.446L15.438,13.405z M9.68,9.924l6.545-2.722l6.093,2.723";w+="L16,12.417L9.68,9.924z M16.564,13.405l6.557-2.586v8.408l-6.557,2.404V13.405L16.564,13.405z M23.785,9.346l-6.129-2.739";w+="l5.984-2.49l6.66,2.659L23.785,9.346z M16.356,1.21l5.788,2.31l-5.902,2.455l-5.661-2.529L16.356,1.21z M9.103,4.019l5.709,2.551";w+="L8.175,9.329L1.84,6.83L9.103,4.019z M7.799,10.392v8.481l-6.439-2.329V7.852L7.799,10.392z M1.359,17.742l6.439,2.33v7.68";w+="l-6.439-2.541V17.742z M8.924,28.195v-7.717l6.513,2.357v7.928L8.924,28.195z M16.564,22.832l6.557-2.404v7.75l-6.557,2.586V22.832";w+="L16.564,22.832z M24.248,27.734v-7.721l6.395-2.346v7.543L24.248,27.734z";t.createChildNS("path",{fill:"#FFFFFF",stroke:"none",d:w});break}return v}};function ToolMenu(a){this.pane=a;this.width=236;this.title="Tools";this.button=null;this.options=[]}ToolMenu.prototype={renderInto:function(h){var c=this;var b=h.createChild("div",{"class":"menu-item tool-menu",title:this.title});this.button=b.createChild("div",{});this.renderToolIcon();var g=b.createChild("div",{"class":"sub-container",style:"width: {0}px;".format(this.width)});var f=g.createChild("div",{"class":"sub-title no-select"},this.title);var a=g.createChild("div",{"class":"sub-body"});var e=a.createChild("div",{"class":"tools"});this.pane.addSeperator(e,"General");this.renderToolOption(e,"Picker","ICON32_TOOL_Picker",ToolTypes.Picker);this.renderToolOption(e,"Move Canvas","ICON32_TOOL_Move",ToolTypes.Move);this.renderToolOption(e,"Drawing Board","ICON32_TOOL_Crop",ToolTypes.Crop);this.pane.addSeperator(e,"Shape");this.renderToolOption(e,"Rectangle","ICON32_TOOL_Rectangle",ToolTypes.Rectangle);this.renderToolOption(e,"Ellipse","ICON32_TOOL_Ellipse",ToolTypes.Ellipse);this.renderToolOption(e,"Line","ICON32_TOOL_Line",ToolTypes.Line);this.renderToolOption(e,"Polygon","ICON32_TOOL_Polygon",ToolTypes.Polygon);this.renderToolOption(e,"Pencil","ICON32_TOOL_Pencil",ToolTypes.Pencil);this.renderToolOption(e,"Pen","ICON32_TOOL_Pen",ToolTypes.Pen);this.renderToolOption(e,"Label","ICON32_TOOL_Label",ToolTypes.Label);var d=e.createChild("div",{id:"hidden_map_tools",style:"display: none"});this.pane.addSeperator(d,"Map");this.renderToolOption(d,"Show Map","ICON32_TOOL_Map",ToolTypes.Map);this.renderToolOption(d,"Point of Interest","ICON32_TOOL_Poi",ToolTypes.Poi);this.renderToolOption(d,"Block","ICON32_TOOL_Block",ToolTypes.Block);this.renderToolOption(d,"Unblock","ICON32_TOOL_Eraser",ToolTypes.Eraser);this.button.addEventListener("click",function(){c.pane.selectMenuItem(this.parentNode)},false);return b},getPainting:function(){return this.pane.workspace.painting},renderToolIcon:function(){var a=null;switch(this.getPainting().toolType){case ToolTypes.None:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_?");break;case ToolTypes.Picker:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Picker");break;case ToolTypes.Move:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Move");break;case ToolTypes.Crop:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Crop");break;case ToolTypes.Line:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Line");break;case ToolTypes.Rectangle:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Rectangle");break;case ToolTypes.Ellipse:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Ellipse");break;case ToolTypes.Polygon:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Polygon");break;case ToolTypes.Pencil:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Pencil");break;case ToolTypes.Pen:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Pen");break;case ToolTypes.Label:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Label");break;case ToolTypes.Map:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Map");break;case ToolTypes.Poi:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Poi");break;case ToolTypes.Block:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Block");break;case ToolTypes.Eraser:a=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Eraser");break}return a},renderToolOption:function(f,d,e,c){var b=this;var a=f.createChild("div",{title:d,"class":"tool-icon-wrapper"+(c==workspace.painting.toolType?" tool-icon-selected":""),"data-toolType":c});this.pane.render32pxSvgIcon(a,e);a.addEventListener("click",function(){var g=parseInt(this.getAttribute("data-toolType"));if(g==workspace.painting.toolType){}else{b.getPainting().selectTool(g)}b.pane.selectMenuItem(null)},false);this.options.push(a);return a},selectToolType:function(a){this.hiddenClickCount=0;this.button.removeChild(this.button.firstChild);this.renderToolIcon();for(var b=0;b<this.options.length;b++){var d=this.options[b];var c=parseInt(d.getAttribute("data-toolType"));if(c==a&&!d.hasClassName("tool-icon-selected")){d.addClassName("tool-icon-selected")}else{if(d.hasClassName("tool-icon-selected")&&c!=a){d.removeClassName("tool-icon-selected")}}}},};function Painting(a){this.workspace=a;this.shapes=[];this.maxShapeId=-1;this.toolType=ToolTypes.Picker;this.modified=false;this.fill={color:Config.DrawingBoard.fillColor,opacity:Config.DrawingBoard.fillOpacity};this.stroke={color:Config.DrawingBoard.strokeColor,opacity:Config.DrawingBoard.strokeOpacity,width:Config.DrawingBoard.strokeWidth};this.selectingShape=null;this.selectedShape=null;this.onToolChanged=null;this.onFillChanged=null;this.onStrokeChanged=null;this.onShapeChanged=null;this.onShapeAppended=null;this.onShapeRemoved=null;this.onShapeSorted=null;this.onSceneChanged=null}Painting.prototype={removeAllShapes:function(){while(this.shapes.length>0){this.shapes[0].remove()}},reset:function(){this.selectTool(ToolTypes.Picker);this.setFill(Config.DrawingBoard.fillColor,Config.DrawingBoard.fillOpacity);this.setStroke(Config.DrawingBoard.strokeColor,Config.DrawingBoard.strokeOpacity,Config.DrawingBoard.strokeWidth);this.removeAllShapes()},getNextId:function(){return ++this.maxShapeId},createShape:function(c,a,d){var b=null;switch(c){case ShapeTypes.Line:b=new Line(a,d,null,null);break;case ShapeTypes.Rectangle:b=new Rectangle(a,d,null,null);break;case ShapeTypes.Ellipse:b=new Ellipse(a,d,null,null);break;case ShapeTypes.Polygon:b=new Polygon(a,d,null,null);break;case ShapeTypes.Freeline:b=new Freeline(a,d,null,null);break;case ShapeTypes.Label:b=new Label(a,d,null,null);break;case ShapeTypes.Polyline:b=new Polyline(a,d,null,null);break}this.appendShape(b);this.selectShape(b);return b},appendShape:function(a){var b=this;this.shapes.push(a);a.onStatusChanged=function(){b.sceneChanged()};if(typeof this.onShapeAppended=="function"){this.onShapeAppended(a)}this.sceneChanged()},searchShape:function(a){for(var b=0;b<this.shapes.length;b++){if(this.shapes[b]==a){return b}}return -1},changeShapePosition:function(a,c){if(c>this.shapes.length-1||c<0){return}var d=this.searchShape(a);if(d<0){return}if(d==c){return}if(d<c){for(var b=d;b<c;b++){this.shapes[b]=this.shapes[b+1]}}else{for(var b=d;b>c;b--){this.shapes[b]=this.shapes[b-1]}}this.shapes[c]=a;if(typeof this.onShapeSorted=="function"){this.onShapeSorted(a,d,c)}},removeShape:function(a){var b=this.searchShape(a);if(b>=0){this.shapes.splice(b,1)}if(typeof this.onShapeRemoved=="function"){this.onShapeRemoved(a,b)}this.sceneChanged()},selectTool:function(b){if(this.toolType==b){return}var a=this.toolType;this.toolType=b;if(typeof this.onToolChanged=="function"){this.onToolChanged(a,b)}},setFill:function(a,b){this.fill.color=a;this.fill.opacity=b;if(typeof this.onFillChanged=="function"){this.onFillChanged(a,b)}},setStroke:function(a,b,c){this.stroke.color=a;this.stroke.opacity=b;this.stroke.width=c;if(typeof this.onStrokeChanged=="function"){this.onStrokeChanged(a,b,c)}},selectShape:function(a){if(this.selectedShape==a){return}else{if(this.selectedShape!=null){this.selectedShape.setSelected(false)}this.selectedShape=a;if(a!=null){a.setSelected(true)}if(typeof this.onShapeChanged=="function"){this.onShapeChanged(a)}}},selectShapeById:function(b){if(b<0){this.selectShape(null)}for(var a=0;a<this.shapes.length;a++){if(this.shapes[a].id==b){this.selectShape(this.shapes[a])}}},isShapeTool:function(){return this.toolType==ToolTypes.Rectangle||this.toolType==ToolTypes.Ellipse||this.toolType==ToolTypes.Line||this.toolType==ToolTypes.Polygon||this.toolType==ToolTypes.Pencil||this.toolType==ToolTypes.Pen||this.toolType==ToolTypes.Label},sceneChanged:function(){this.modified=true;if(typeof this.onSceneChanged=="function"){this.onSceneChanged()}},getCanvas:function(){var a=this.workspace.drawingBoard.canvasFrame.transFrame;return{position:a.getPosition(),boundary:a.getBoundary()}},setCanvas:function(b){var c=this.workspace.drawingBoard.canvasFrame.transFrame;var a=b.position;var d=b.boundary;c.moveTo(a.x,a.y,false);c.transformTo(d.left,d.top,d.right,d.bottom,true)},serialize:function(b){var c={canvas:this.getCanvas(),shapes:[]};for(var a=0;a<this.shapes.length;a++){c.shapes.push(this.shapes[a].toJsonObject())}if(b=="JSON"){return c}else{if(b=="STRING"){return JSON.stringify(c)}else{return null}}},deserialize:function(d,c){this.removeAllShapes();var e=null;if(c=="JSON"){e=d}else{if(c=="STRING"){e=JSON.stringify(e)}else{return false}}this.setCanvas(e.canvas);for(var b=0;b<e.shapes.length;b++){var a=BaseShape.fromJsonObject(e.shapes[b]);this.appendShape(a)}return true}};function DrawingBoard(a){this.workspace=a;this.wrapper=null;this.svg=null;this.underGroup=null;this.shapeGroup=null;this.upperGroup=null;this.canvasFrame=null;this.svgOffset={x:0,y:0};this.svgSize={width:0,height:0};this.onBoardMoved=null;this.onCaptured=null;this.ghostObject=null;this.messageBox=null}DrawingBoard.prototype={renderIntoWorkspace:function(){var b=this;this.wrapper=this.workspace.getWrapper().createChild("div",{id:"drawing-board"});this.svg=this.wrapper.createChildNS("svg",{id:"drawing-svg",width:this.svgSize.width,height:this.svgSize.height,style:"background-color:"+Config.General.canvasBackground});this.underGroup=this.svg.createChildNS("g",{"data-label":"Group of Frame"});this.shapeGroup=this.svg.createChildNS("g",{"data-label":"Group of Shapes"});this.upperGroup=this.svg.createChildNS("g",{"data-label":"Group of Misc"});this.canvasFrame=new CanvasFrame(this.underGroup);var a=workspace.getEventManager(this.wrapper);a.addListener("capture",function(d,c){b.processCapture(d,c)});a.addListener("release",function(d,c){b.processRelease(d,c)});a.addListener("drag",function(d,c){b.processDrag(d,c)})},processCapture:function(h,i){var k=document.elementFromPoint(h.pageX,h.pageY);var d=workspace.painting.selectingShape;var c=workspace.painting.selectedShape;if(workspace.painting.toolType==ToolTypes.Picker){if(d!=null){if(d!=c){workspace.painting.selectShape(d)}workspace.painting.selectingShape=null}else{workspace.painting.selectShape(null)}}if(workspace.painting.toolType==ToolTypes.Pen){var l=this.transformPoint({x:i.current.x,y:i.current.y});if(d!=null&&c!=d){workspace.painting.selectShape(d);workspace.painting.selectingShape=null;d.switchPathEditing(true)}else{if(c!=null&&c.isPathShape()){var j=c.selectingPoint;var g=c.selectedPoint;if(j!=null){if(j.selected){if(j.selectingCtrl!=null){j.selectingCtrl=null}else{c.selectPoint(null)}}else{c.selectPoint(j)}c.selectingPoint=null}else{var p=l.x-c.getOffset().x;var n=l.y-c.getOffset().y;var b=c.transFrame.getOriginalPoint(p,n);var f=null;if(c.selectedPoint==null){}else{if(c.selectedPoint.isLast()||c.anchorPoints.length<2){f=c.addAndRenderPoint(b.x,b.y,true)}else{f=c.insertAndRenderPoint(b.x,b.y,c.selectedPoint)}}c.selectPoint(f)}}else{var m={position:{x:l.x,y:l.y},boundary:{left:0,top:0,right:0,bottom:0},rotation:{cx:0,cy:0,angle:0}};var o=workspace.painting.createShape(ShapeTypes.Polyline,this.shapeGroup,m);o.selectLastPoint()}}}if(typeof this.onCaptured=="function"){this.onCaptured()}},processRelease:function(d,a){if(workspace.painting.toolType==ToolTypes.Picker){}else{if(workspace.painting.toolType==ToolTypes.Pen){var f=workspace.painting.selectedShape;if(f!=null){var c=f.selectedPoint;if(c!=null){var b=c.bezierLastCtrl;if(b!=null&&b.captured){b.setCaptured(false)}}}}else{workspace.painting.selectShape(null);if(!Config.General.lockTool&&workspace.painting.isShapeTool()){workspace.painting.selectTool(ToolTypes.Picker)}}}this.workspace.scaleplate.moveIndicator(-1,-1)},processDrag:function(c,a){var g=this.transformPoint(a.current);var h=workspace.painting.selectedShape;if(h==null){var f={position:this.transformPoint(a.begin),boundary:{left:0,top:0,right:0,bottom:0},rotation:{cx:0,cy:0,angle:0}};switch(workspace.painting.toolType){case ToolTypes.Picker:break;case ToolTypes.Move:this.moveBoard(a.previous.dx,a.previous.dy);break;case ToolTypes.Line:workspace.painting.createShape(ShapeTypes.Line,this.shapeGroup,f);break;case ToolTypes.Rectangle:workspace.painting.createShape(ShapeTypes.Rectangle,this.shapeGroup,f);break;case ToolTypes.Ellipse:workspace.painting.createShape(ShapeTypes.Ellipse,this.shapeGroup,f);break;case ToolTypes.Polygon:workspace.painting.createShape(ShapeTypes.Polygon,this.shapeGroup,f);break;case ToolTypes.Pencil:workspace.painting.createShape(ShapeTypes.Freeline,this.shapeGroup,f);break;case ToolTypes.Label:workspace.painting.createShape(ShapeTypes.Label,this.shapeGroup,f);break}}else{switch(workspace.painting.toolType){case ToolTypes.Picker:break;case ToolTypes.Line:case ToolTypes.Rectangle:case ToolTypes.Ellipse:case ToolTypes.Polygon:case ToolTypes.Label:h.resize(a.begin.dx,a.begin.dy);break;case ToolTypes.Pencil:h.addAndRenderPoint(a.begin.dx,a.begin.dy,true);break;case ToolTypes.Pen:if(a.previous.dx!=0||a.previous.dy!=0){if(h.isPathShape()&&h.selectedPoint!=null){var d=h.transFrame;var b=d.getMappedOffset(a.begin,a.current);h.selectedPoint.prepareBezierCtrl(b)}}break}}this.workspace.scaleplate.moveIndicator(g.x,g.y)},applyViewBox:function(){var a="{0} {1} {2} {3}".format(-this.svgOffset.x,-this.svgOffset.y,this.svgSize.width,this.svgSize.height);this.svg.setAttribute("viewBox",a)},moveBoard:function(b,a){this.svgOffset.x+=b;this.svgOffset.y+=a;this.applyViewBox();if(typeof this.onBoardMoved=="function"){this.onBoardMoved(this.svgOffset.x,this.svgOffset.y)}},reset:function(){this.svgOffset.x=0;this.svgOffset.y=0;this.applyViewBox();this.canvasFrame.reset(this.svgSize.width,this.svgSize.height)},resize:function(b,a){this.wrapper.updateStyle("width",b+"px");this.wrapper.updateStyle("height",a+"px");this.svgSize.width=b;this.svgSize.height=a;this.svg.setAttribute("width",this.svgSize.width);this.svg.setAttribute("height",this.svgSize.height);this.applyViewBox();this.canvasFrame.resize(b,a)},transformPoint:function(a){return{x:a.x-this.wrapper.offsetLeft-this.svgOffset.x,y:a.y-this.wrapper.offsetTop-this.svgOffset.y}},showGhost:function(a){if(this.ghostObject==null){this.ghostObject=this.upperGroup.createChildNS("path",{d:a,fill:"RGBA(0,0,0,0.5)","stroke-width":1,stroke:"RGBA(0,0,0,1)"})}else{this.ghostObject.setAttribute("d",a)}},showMessage:function(h){var e=this;if(this.messageBox!=null){this.hideMessage()}var b=[];if(getType(h)=="Array"){b=h}else{b.push(h)}var g=50;var f=14;var d=f*1.5;var a={x:g,y:this.svgSize.height-g-d*(b.length-1)};this.messageBox=this.workspace.drawingBoard.upperGroup.createChildNS("g",{"class":"no-select"});for(var c=0;c<b.length;c++){this.messageBox.createChildNS("text",{x:a.x,y:a.y+c*d,fill:"#333333","font-size":f+"px"},b[c])}setTimeout(function(){e.hideMessage()},10000)},hideMessage:function(){if(this.messageBox==null){return}this.messageBox.parentNode.removeChild(this.messageBox);this.messageBox=null}};function ObjectManager(a){this.workspace=a;this.wrapper=null;this.left=0;this.top=0;this.showing=Config.General.showObjectManager;this.selectedShapes=[];this.objectListContainer=null;this.objectListDoms=[];this.summaryLabel=null}ObjectManager.prototype={renderIntoWorkspace:function(){var b=this;this.wrapper=this.workspace.getWrapper().createChild("div",{id:"object-manager","class":"floating-panel",style:"width: {0}px; display: {1}".format(Config.ObjectManager.width,this.showing?"block":"none")});var a=this.wrapper.createChild("div",{"class":"title-Bar no-select"});workspace.getEventManager(a).addListener("drag",function(d,c){b.moveWindow(c.previous.dx,c.previous.dy)});this.summaryLabel=a.createChild("div",{"class":"dragable"},"Objects");this.objectListContainer=this.wrapper.createChild("div",{"class":"list"});this.updateSummary()},moveWindow:function(b,a){if(b!=null&&a!=null){this.left+=b;this.top+=a}this.wrapper.updateStyle("left",this.left+"px");this.wrapper.updateStyle("top",this.top+"px")},moveWindowTo:function(b,a){this.left=b;this.top=a;this.moveWindow()},insertItem:function(a){var c=this;var d=this.objectListContainer.createChild("div",{"class":"item","data-id":a.id},"",true);this.objectListDoms.push(d);if(this.isIdSelected(a.id)){d.addClassName("selected")}var b=d.createChild("div",{"class":"item-title"},a.toString(false),"",false);b.addEventListener("click",function(f){var g=this.parentNode.getAttribute("data-id");c.workspace.selectShapeById(g)})},updateList:function(){while(this.objectListDoms.length>0){var d=this.objectListDoms.pop();this.objectListContainer.removeChild(d)}var a=this.workspace.painting.shapes;for(var c=0;c<a.length;c++){var b=a[c];this.insertItem(b)}},updateSummary:function(){var a=this.workspace.painting.shapes;this.summaryLabel.textContent="Objects Number: "+a.length},isIdSelected:function(b){for(var a=0;a<this.selectedShapes.length;a++){if(this.selectedShapes[a].id==b){return true}}return false},appendShape:function(a){if(!this.showing){return}this.insertItem(a);this.updateSummary()},removeShape:function(a,b){if(!this.showing){return}this.objectListContainer.removeChild(this.objectListDoms[b]);this.objectListDoms.splice(b,1);this.updateSummary()},sortShape:function(a,c,b){if(!this.showing){return}this.updateList()},selectShapes:function(a){this.selectedShapes=a;if(!this.showing){return}for(var b=0;b<this.objectListDoms.length;b++){var c=this.objectListDoms[b];var d=c.getAttribute("data-id");if(this.isIdSelected(d)){if(!c.hasClassName("selected")){c.addClassName("selected")}}else{if(c.hasClassName("selected")){c.removeClassName("selected")}}}},show:function(a){this.showing=a;this.updateList();this.updateSummary();if(a){this.wrapper.updateStyle("display","block")}else{this.wrapper.updateStyle("display","none")}}};function PromptDialog(a){this.workspace=a;this.wrapper=null;this.dlgBox=null;this.textBox=null;this.button=null}PromptDialog.prototype={renderIntoWorkspace:function(){var a=this;this.wrapper=this.workspace.getWrapper().createChild("div",{id:"prompt-wrapper",style:"display:none"});this.dlgBox=this.wrapper.createChild("div",{"class":"prompt-dlg"});this.textBox=this.dlgBox.createChild("input",{type:"text","class":"text"});this.button=this.dlgBox.createChild("input",{type:"button","class":"button",value:"OK"});this.button.addEventListener("click",function(){a.setShowing(false)},false)},selectAll:function(){this.textBox.focus();this.textBox.select()},setShowing:function(a){this.wrapper.updateStyle("display",a?null:"none")},setText:function(a){this.textBox.value=a},setEnabled:function(a){if(a){this.textBox.removeAttribute("readonly");this.button.removeAttribute("disabled")}else{this.textBox.setAttribute("readonly","readonly");this.button.setAttribute("disabled","disabled")}},resize:function(b,a){this.wrapper.updateStyle("width",b+"px");this.wrapper.updateStyle("height",a+"px");this.dlgBox.updateStyle("margin-top",a/2-50+"px")}};function TextPanel(a){this.workspace=a;this.wrapper=null;this.contetArea=null;this.buttonArea=null;this.titleBar=null;this.textArea=null}TextPanel.prototype={renderIntoWorkspace:function(){var d=this;this.wrapper=this.workspace.getWrapper().createChild("div",{id:"text-panel",style:"display: none; left: 0px; top: 0px; width: 0px; height: 0px"});this.contetArea=this.wrapper.createChild("div",{"class":"content-area"});this.titleBar=this.contetArea.createChild("div",{"class":"title-bar",});var c=this.titleBar.createChild("div",{"class":"buttons"});this.buttonArea=c.createChild("div",{style:"display: inline"});var e=c.createChild("div",{"class":"button",title:"close"});e.addEventListener("click",function(f){d.hide()});var a=e.createChildNS("svg",{"class":"top-menu-icon",width:16,height:16,});var b=a.createChildNS("g");b.createChildNS("path",{d:"M0 0 L{0} {0} M{0} 0 L0 {0}".format(16),stroke:"#FE5722","stroke-width":2,fill:"none"});this.textArea=this.contetArea.createChild("textarea",{"class":"text-area"})},clearButtons:function(){while(this.buttonArea.hasChildNodes()){this.buttonArea.removeChild(this.buttonArea.firstChild)}},setText:function(a){this.textArea.value=a},show:function(){this.wrapper.updateStyle("display","block")},hide:function(){this.wrapper.updateStyle("display","none")},resize:function(d,a){var f=this.workspace.isSmallScreen()?0:50;var g=42;var b=d-f*2;var e=a-f*2;this.wrapper.updateStyle("width",d+"px");this.wrapper.updateStyle("height",a+"px");this.contetArea.updateStyle("width",b+"px");this.contetArea.updateStyle("height",e+"px");this.contetArea.updateStyle("margin","{0}px 0px 0px {0}px".format(f));this.titleBar.updateStyle("height",g+"px");var c=5;this.textArea.updateStyle("width",b-c*2+"px");this.textArea.updateStyle("height",e-c*2-g+"px");this.textArea.updateStyle("margin","{0}px 0px 0px {0}px".format(c))}};function Scaleplate(a,c,b){this.workspace=a;this.showing=true;this.hRuler=null;this.hCanvas=null;this.hContext=null;this.vRuler=null;this.vCanvas=null;this.vContext=null;this.marginLeft=c;this.marginTop=b;this.barSize=Config.Scaleplate.size;this.width=0;this.height=0;this.offset={x:0,y:0};this.indicator={x:-1,y:-1}}Scaleplate.prototype={renderIntoWorkspace:function(){this.hRuler=this.workspace.getWrapper().createChild("div",{id:"horizontal-ruler","class":"ruler",style:"width: 0px; height: {0}px; margin-left: {0}px".format(this.barSize)});this.hCanvas=this.hRuler.createChild("canvas",{width:0,height:0});this.hContext=this.hCanvas.getContext("2d");this.vRuler=this.workspace.getWrapper().createChild("div",{id:"vertical-ruler","class":"ruler",style:"width: {0}px; height: 0px".format(this.barSize)});this.vCanvas=this.vRuler.createChild("canvas",{width:0,height:0});this.vContext=this.vCanvas.getContext("2d");this.setShowing(Config.General.showScale)},resize:function(b,a){this.width=b;this.height=a;this.hRuler.updateStyle("width",b+"px");this.vRuler.updateStyle("height",a+"px");this.redraw()},setShowing:function(a){this.showing=a;this.hRuler.updateStyle("display",a?"block":"none");this.vRuler.updateStyle("display",a?"block":"none");if(a){this.redraw()}},changeOffset:function(a,b){this.offset.x=a;this.offset.y=b;this.redraw()},moveIndicator:function(a,b){this.indicator.x=a;this.indicator.y=b;this.redraw()},redraw:function(){if(!this.showing){return}this.hCanvas.width=this.width;this.hCanvas.height=this.barSize;this.vCanvas.width=this.barSize;this.vCanvas.height=this.height;var c=10;this.hContext.save();this.hContext.font="{0}px verdana".format(10);this.hContext.textBaseline="top";this.hContext.fillStyle="#666666";this.hContext.strokeStyle="RGBA(0,0,0,0.2)";this.hContext.lineWidth=1;this.hContext.beginPath();for(var a=0;a<this.width;a++){var f=a-this.offset.x;if(f%100==0){this.hContext.antiFuzzyLine(a,0,a,this.barSize);this.hContext.fillText(f,a+2,0)}else{if(f%10==0){this.hContext.antiFuzzyLine(a,this.barSize-4,a,this.barSize)}}}this.hContext.stroke();this.hContext.restore();this.vContext.save();this.vContext.font="{0}px verdana".format(10);this.vContext.textBaseline="top";this.vContext.fillStyle="#666666";this.vContext.strokeStyle="RGBA(0,0,0,0.2)";this.vContext.lineWidth=1;this.vContext.beginPath();for(var g=0;g<this.height;g++){var f=g-this.offset.y;if(f%100==0){this.vContext.antiFuzzyLine(0,g,this.barSize,g);this.vContext.fillTextWithRotate(f,12,g+2,Math.PI/2,"left","top")}else{if(f%10==0){this.vContext.antiFuzzyLine(this.barSize-4,g,this.barSize,g)}}}this.vContext.stroke();this.vContext.restore();var b=Config.Scaleplate.indicatorSize;if(this.indicator.x!=-1){var e=this.indicator.x+this.offset.x;this.hContext.save();this.hContext.beginPath();this.hContext.moveTo(e-b,0);this.hContext.lineTo(e+b,0);this.hContext.lineTo(e+b,this.barSize/2);this.hContext.lineTo(e,this.barSize);this.hContext.lineTo(e-b,this.barSize/2);this.hContext.closePath();this.hContext.fillStyle=Config.Scaleplate.indicatorColor;this.hContext.fill();this.hContext.restore()}if(this.indicator.y!=-1){var d=this.indicator.y+this.offset.y;this.vContext.save();this.vContext.beginPath();this.vContext.moveTo(0,d+b);this.vContext.lineTo(0,d-b);this.vContext.lineTo(this.barSize/2,d-b);this.vContext.lineTo(this.barSize,d);this.vContext.lineTo(this.barSize/2,d+b);this.vContext.closePath();this.vContext.fillStyle=Config.Scaleplate.indicatorColor;this.vContext.fill();this.vContext.restore()}}};var base_shape_prototype={id:null,parent:null,renderred:null,committed:null,svgGroup:null,shapeElement:null,ghostElement:null,transFrame:null,anchorPoints:null,selectingPoint:null,selectedPoint:null,properties:null,propertyDict:null,animation:null,fps:null,fillInterval:null,fillPercentage:null,strokeInterval:null,strokePercentage:null,onCommitted:null,onStatusChanged:null,statusChanged:function(){if(typeof this.onStatusChanged=="function"){this.onStatusChanged()}},init:function(b,e,a,d){var c=this;this.id=workspace.painting.getNextId();this.parent=b;this.renderred=false;this.committed=false;this.svgGroup=this.parent.createChildNS("g",{"data-label":"Group of Shape","data-id":"s_"+this.id,});this.shapeElemgnt=null;this.ghostElement=null;this.transFrame=new TransformableFrame(this.svgGroup,e,true);this.transFrame.addEventListener("boundarychange",function(g){c.statusChanged();if(!c.committed){return}if(c.anchorPoints.length<=0){return}var f=c.transFrame.getPosition();var h=QStage.enhanceBoundary(g.oldBoundary,false);var i=QStage.enhanceBoundary(g.newBoundary,false);c.transformPointsToBoundary(null,f,h,i)});this.transFrame.addEventListener("positionchange",function(f){c.statusChanged()});this.transFrame.addEventListener("rotationchange",function(f){c.statusChanged()});this.anchorPoints=[];this.preparePoints(a);this.selectingPoint=null;this.selectedPoint=null;this.properties={};this.propertyDict=[];this.preparePropDict(d);this.fps=20;this.fillInterval=null;this.fillPercentage=null;this.strokeInterval=null;this.strokePercentage=null;this.onCommitted=null;this.onStatusChanged=null},preparePoints:function(a){if(a!=null){for(var c=0;c<a.length;c++){var e=a[c];if(e.length==4){var d={x:e[2],y:e[3]};var b=this.addPoint(e[0],e[1],d)}else{if(e.length==2){var b=this.addPoint(e[0],e[1],null)}}}}},addPropDictItem:function(e,a){var d=a.value;if(e!=null){for(var c=0;c<e.length;c++){var b=e[c][0];if(b==a.key){d=e[c][1];break}}}this.propertyDict.push({key:a.key,value:d,setter:a.setter,getOptions:a.getOptions})},preparePropDict:function(a){this.addPropDictItem(a,{key:"fill",value:{color:workspace.painting.fill.color,opacity:workspace.painting.fill.opacity},setter:function(b,c){if(b.shapeElement.getAttribute("fill")!="none"){b.shapeElement.setAttribute("fill",QStage.brushToRgba(c))}}});this.addPropDictItem(a,{key:"stroke",value:{color:workspace.painting.stroke.color,opacity:workspace.painting.stroke.opacity,width:workspace.painting.stroke.width},setter:function(b,c){b.shapeElement.setAttribute("stroke",QStage.brushToRgba(c));b.shapeElement.setAttribute("stroke-width",c.width)}});this.addPropDictItem(a,{key:"applyFill",value:true,setter:function(b,c){b.shapeElement.setAttribute("fill",c?QStage.brushToRgba(b.prop("fill")):"none");if(b.ghostElement){b.ghostElement.setAttribute("fill",c?Config.Shape.ghostFill:"none")}}});this.addPropDictItem(a,{key:"closePath",value:false,setter:function(b,c){b.updatePath()}});this.addPropDictItem(a,{key:"strokeLinecap",value:"butt",setter:function(b,c){b.shapeElement.setAttribute("stroke-linecap",c)},getOptions:function(){var b=[];b.push(["butt","Butt"]);b.push(["round","Round"]);b.push(["square","Square"]);return b}});this.addPropDictItem(a,{key:"strokeLinejoin",value:"miter",setter:function(b,c){b.shapeElement.setAttribute("stroke-linejoin",c)},getOptions:function(){var b=[];b.push(["miter","Miter"]);b.push(["round","Round"]);b.push(["bevel","Bevel"]);return b}});this.addPropDictItem(a,{key:"strokeAnimation",value:2,setter:function(b,c){if(c==0){b.stopAnimation("STROKE")}else{b.playAnimation("STROKE",1)}},getOptions:function(){var b=[];b.push(["0","None"]);for(var c=1;c<=10;c++){b.push([c,"{0}s".format(c)])}return b}});this.addPropDictItem(a,{key:"fillAnimation",value:1,setter:function(b,c){if(c==0){b.stopAnimation("FILL")}else{b.playAnimation("FILL",1)}},getOptions:function(){var b=[];b.push(["0","None"]);for(var c=1;c<=4;c++){b.push([c,"{0}s".format(c)])}return b}})},renderComplete:function(){var e=this;this.shapeElement.setAttribute("stroke-linecap",this.prop("strokeLinecap"));this.shapeElement.setAttribute("stroke-linejoin",this.prop("strokeLinejoin"));this.transFrame.render();for(var d=0;d<this.anchorPoints.length;d++){this.anchorPoints[d].render();this.anchorPoints[d].setDisplay(false)}function c(h,g){if(workspace.painting.toolType==ToolTypes.Picker){workspace.painting.selectingShape=e}else{if(workspace.painting.toolType==ToolTypes.Pen&&e.isPathShape()){workspace.painting.selectingShape=e}}}var b=workspace.getEventManager(this.transFrame.svgGroup).addListener("capture",c);var a=this.ghostElement==null?this.shapeElement:this.ghostElement;var f=workspace.getEventManager(a).addListener("capture",c);this.renderred=true},prop:function(b,d){var c=null;for(var a=0;a<this.propertyDict.length;a++){if(this.propertyDict[a].key==b){c=this.propertyDict[a];break}}if(c==null){return}if(d==null){return c.value}else{c.value=clone(d);if(this.renderred){c.setter(this,d)}this.statusChanged()}},getOptions:function(c){if(c=="GENERIC_BOOL"){var a=[];a.push(["1","True"]);a.push(["0","False"]);return a}for(var b=0;b<this.propertyDict.length;b++){if(this.propertyDict[b].key==c){return this.propertyDict[b].getOptions()}}return null},playAnimation:function(c,a){var b=this;if(c=="FILL"){if(!this.prop("applyFill")){return}this.fillPercentage=1;this.startInterval(c,function(){var d=b.prop("fill").opacity*(1-b.fillPercentage);b.shapeElement.setAttribute("fill",QStage.brushToRgba({color:b.prop("fill").color,opacity:d}));if(b.fillPercentage>0){b.fillPercentage-=1/b.fps/b.prop("fillAnimation")}else{b.fillPercentage=1;if(a!=-1){a--;if(a<=0){b.stopAnimation(c)}}}})}else{if(c=="STROKE"){this.strokePercentage=1;this.startInterval(c,function(){var d=b.shapeElement.getTotalLength();b.shapeElement.updateStyle("stroke-dasharray",d);b.shapeElement.updateStyle("stroke-dashoffset",d*b.strokePercentage);if(b.strokePercentage>0){b.strokePercentage-=1/b.fps/b.prop("strokeAnimation")}else{b.strokePercentage=1;if(a!=-1){a--;if(a<=0){b.stopAnimation(c)}}}})}}},stopAnimation:function(a){if(a=="FILL"){if(this.prop("applyFill")){this.shapeElement.setAttribute("fill",QStage.brushToRgba(this.prop("fill")))}else{this.shapeElement.setAttribute("fill","none")}this.stopInterval(a)}else{if(a=="STROKE"){this.shapeElement.updateStyle("stroke-dasharray",null);this.shapeElement.updateStyle("stroke-dashoffset",null);this.stopInterval(a)}}},startInterval:function(a,b){if(a=="FILL"){this.stopInterval("FILL");this.fillInterval=setInterval(b,1000/this.fps)}else{if(a=="STROKE"){this.stopInterval("STROKE");this.strokeInterval=setInterval(b,1000/this.fps)}}},stopInterval:function(a){if(a=="FILL"){if(this.fillInterval!=null){clearInterval(this.fillInterval);this.fillInterval=null}}else{if(a=="STROKE"){if(this.strokeInterval!=null){clearInterval(this.strokeInterval);this.strokeInterval=null}}}},transformPointsToBoundary:function(o,s,q,r){var g=s.x;var e=s.y;var l=q.right-q.left;var k=r.right-r.left;var c=q.bottom-q.top;var m=r.bottom-r.top;var h=k/l;var d=m/c;var n={x:q.left+l/2,y:q.top+c/2};var a={x:(r.left<r.right?r.left:r.right)+Math.abs(k/2),y:(r.top<r.bottom?r.top:r.bottom)+Math.abs(m/2)};var f=(o==null);if(f){o=this.anchorPoints}for(var p=0;p<o.length;p++){var b=o[p];var g=(b.x-n.x)*h+a.x;var e=(b.y-n.y)*d+a.y;if(f){var j=p==o.length-1;o[p].movePointTo(QStage.round(g),QStage.round(e),false,j)}else{o[p].x=QStage.round(g);o[p].y=QStage.round(e)}}},getAbsoluteInfo:function(){var a=this.transFrame.getPosition();var d=QStage.enhanceBoundary(this.transFrame.getBoundary(),true);this.transFrame.validRotationCenter(d);var b=this.transFrame.getRotation();var c={left:a.x+d.left,top:a.y+d.top,width:d.width,height:d.height,cx:d.cx,cy:d.cy,rotation:b.angle%360};return c},resize:function(a,b){this.transFrame.transform(0,0,a,b,true)},getOffset:function(){var a=this.transFrame.getPosition();return{x:a.x,y:a.y}},addPoint:function(a,e,d){var c=this;var b=new AnchorPoint(this,a,e,d);b.onAnchorChanged=function(f){c.anchorsChanged(f)};this.anchorPoints.push(b);return b},addAndRenderPoint:function(a,f,e){var c=this;var b=this.addPoint(a,f,null);if(e){this.anchorsChanged(true);var d=this.getPointBoundary();this.transFrame.transformTo(d.left,d.top,d.right,d.bottom,false)}b.render();return b},insertAndRenderPoint:function(a,g,e){var d=this;var b=new AnchorPoint(this,a,g,null);b.onAnchorChanged=function(h){d.anchorsChanged(h)};for(var c=0;c<this.anchorPoints.length;c++){if(this.anchorPoints[c]==e){this.anchorPoints.splice(c+1,0,b);break}}this.anchorsChanged(true);var f=this.getPointBoundary();this.transFrame.transformTo(f.left,f.top,f.right,f.bottom,false);b.render();return b},selectPoint:function(a){if(this.selectedPoint!=null){this.selectedPoint.setSelected(false)}if(a!=null){a.setSelected(true)}this.selectedPoint=a},deletePoint:function(c){if(this.anchorPoints.length<=2){return}if(this.selectedPoint==c){this.selectPoint(null);this.selectingPoint=null}var a=-1;for(var b=0;b<this.anchorPoints.length;b++){if(this.anchorPoints[b]==c){a=b;break}}if(a>=0){this.anchorPoints.splice(a,1);this.anchorsChanged(true);c.destroy()}},selectLastPoint:function(){this.selectPoint(this.anchorPoints[this.anchorPoints.length-1])},switchPathEditing:function(a){if(a){this.transFrame.setEnabled(false)}},updatePath:function(){this.shapeElement.setAttribute("d",this.getPathData(false));if(this.ghostElement){this.ghostElement.setAttribute("d",this.getPathData(false))}this.statusChanged()},anchorsChanged:function(a){this.updatePath();if(a){var b=this.getPointBoundary();this.transFrame.transformTo(b.left,b.top,b.right,b.bottom,false)}},getPointBoundary:function(e){if(e==null){e=this.anchorPoints}var g=null;var f=null;var d=null;var b=null;for(var c=0;c<e.length;c++){var a=e[c];if(a.x<g||g==null){g=a.x}if(a.x>d||d==null){d=a.x}if(a.y<f||f==null){f=a.y}if(a.y>b||b==null){b=a.y}}return{left:g,top:f,right:d,bottom:b}},getPathCommand:function(e,a,c){var g=e==-1?this.anchorPoints[0]:this.anchorPoints[e];var f=c!=null?g.x+a.x-c.left:g.x;var d=c!=null?g.y+a.y-c.top:g.y;var i="";if(e==0){i+="M{0} {1}".format(f,d)}else{var b=g.getPrevious().getBezierCtrl(false);var h=g.getBezierCtrl(true);if(h!=null){if(b!=null){i+=" C{0} {1}, {2} {3}, {4} {5}".format(b.x,b.y,h.x,h.y,f,d)}else{i+=" Q{0} {1}, {2} {3}".format(h.x,h.y,f,d)}}else{if(b!=null){i+=" Q{0} {1}, {2} {3}".format(b.x,b.y,f,d)}else{i+=" L{0} {1}".format(f,d)}}}return i},getPathData:function(c){var a=c?workspace.getExportRect():null;var e=this.transFrame.getPosition();var d="";for(var b=0;b<this.anchorPoints.length;b++){d+=this.getPathCommand(b,e,a)}if(this.prop("closePath")){d+=this.getPathCommand(-1,e,a);d+=" Z"}return d},setSelected:function(b){if(!this.committed){if(b){if(this.getType()!=ShapeTypes.Line&&this.getType()!=ShapeTypes.Freeline&&this.getType()!=ShapeTypes.Polyline&&this.getType()!=ShapeTypes.Rectangle){this.transFrame.setEnabled(b)}}else{this.committed=true;if(typeof this.onCommitted=="function"){this.onCommitted()}}}if(this.committed){if(this.getType()!=ShapeTypes.Line){this.transFrame.setEnabled(b)}for(var a=0;a<this.anchorPoints.length;a++){this.anchorPoints[a].setDisplay(b)}if(!b&&this.selectedPoint!=null){this.selectedPoint.setSelected(false);this.selectedPoint=null}}},canBringFront:function(){var a=workspace.painting.searchShape(this);if(a>=0){return a<workspace.painting.shapes.length-1}else{return false}},canSendBack:function(){var a=workspace.painting.searchShape(this);if(a>=0){return a>0}else{return false}},remove:function(){this.svgGroup.parentNode.removeChild(this.svgGroup);this.svgGroup=null;this.stopInterval();workspace.painting.selectShape(null);workspace.painting.removeShape(this);delete this},bringToFront:function(){if(this.svgGroup.parentNode.childNodes.length>1){this.svgGroup.parentNode.appendChild(this.svgGroup)}workspace.painting.changeShapePosition(this,workspace.painting.shapes.length-1)},sendToBack:function(){if(this.svgGroup.parentNode.childNodes.length>1){this.svgGroup.parentNode.insertBefore(this.svgGroup,this.svgGroup.parentNode.firstChild)}workspace.painting.changeShapePosition(this,0)},toString:function(b){var a="Unknown";switch(this.getType()){case ShapeTypes.Line:a="Line";break;case ShapeTypes.Rectangle:a="Rectangle";break;case ShapeTypes.Ellipse:a="Ellipse";break;case ShapeTypes.Polygon:a="Polygon";break;case ShapeTypes.Polyline:a="Polyline";break;case ShapeTypes.Freeline:a="Freeline";break;case ShapeTypes.Label:a="Label";break}if(b){return a}else{return"{0} [#{1}]".format(a,this.id)}},toJsonObject:function(){var e={id:this.id,type:this.getType(),position:this.transFrame.getPosition(),boundary:this.transFrame.getBoundary(),rotation:this.transFrame.getRotation(),points:[],properties:[]};for(var c=0;c<this.anchorPoints.length;c++){var a=this.anchorPoints[c];var b=a.bezierFirstCtrl;if(b==null){e.points.push([a.x,a.y])}else{e.points.push([a.x,a.y,b.x,b.y])}}for(var c=0;c<this.propertyDict.length;c++){var d=this.propertyDict[c];e.properties.push([d.key,d.value])}return e},isPathShape:function(){return this.getType()==ShapeTypes.Polyline||this.getType()==ShapeTypes.Polygon}};var BaseShape=Class.extend(base_shape_prototype);BaseShape.fromJsonObject=function(d){var f=null;var a=workspace.drawingBoard.shapeGroup;var b=d.id;var h=d.type;var j=d.points;var g=d.properties;var e=d.position;var c=d.boundary;var k=d.rotation;var i={position:d.position,boundary:d.boundary,rotation:d.rotation};switch(h){case ShapeTypes.Line:f=new Line(a,i,j,g);break;case ShapeTypes.Rectangle:f=new Rectangle(a,i,j,g);break;case ShapeTypes.Ellipse:f=new Ellipse(a,i,j,g);break;case ShapeTypes.Polygon:f=new Polygon(a,i,j,g);break;case ShapeTypes.Polyline:f=new Polyline(a,i,j,g);break;case ShapeTypes.Freeline:f=new Freeline(a,i,j,g);break;case ShapeTypes.Label:f=new Label(a,i,j,g);break;default:break}f.committed=true;return f};var ellipse_prototpye={getType:function(){return ShapeTypes.Ellipse},init:function(b,e,a,d){var c=this;this._super(b,e,a,d);this.render();this.transFrame.addEventListener("boundarychange",function(f){c.shapeElement.setAttribute("d",c.getPath())})},getPath:function(){var i=QStage.enhanceBoundary(this.transFrame.getBoundary(),true);var a=i.cx;var h=i.cy;var f=i.rx;var e=i.ry;var c=0.5*f;var b=0.6*e;var g="";g+=QStage.buildPathCommand("M",[0+a,e+h]);g+=QStage.buildPathCommand("C",[c+a,e+h,f+a,b+h,f+a,0+h]);g+=QStage.buildPathCommand("C",[f+a,-b+h,c+a,-e+h,0+a,-e+h]);g+=QStage.buildPathCommand("C",[-c+a,-e+h,-f+a,-b+h,-f+a,0+h]);g+=QStage.buildPathCommand("C",[-f+a,b+h,-c+a,e+h,0+a,e+h]);g+=QStage.buildPathCommand("Z");return g},render:function(){var a=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape",fill:QStage.brushToRgba(this.prop("fill")),stroke:QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width,d:this.getPath()});this.renderComplete()}};var Ellipse=BaseShape.extend(ellipse_prototpye);var freeline_prototype={getType:function(){return ShapeTypes.Freeline},init:function(b,e,a,d){var c=this;this._super(b,e,a,d);this.prop("applyFill",false);if(a==null){this.addPoint(e.boundary.left,e.boundary.top,null);this.addPoint(e.boundary.right,e.boundary.bottom,null)}this.render()},render:function(){var a=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape",d:this.getPathData(false),fill:this.prop("applyFill")?QStage.brushToRgba(this.prop("fill")):"none",stroke:QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width});this.ghostElement=this.svgGroup.createChildNS("path",{"data-label":"Ghost",d:this.getPathData(false),fill:this.prop("applyFill")?Config.Shape.ghostFill:"none",stroke:Config.Shape.ghostStroke,"stroke-width":Config.Shape.ghostWidth});this.renderComplete()}};var Freeline=BaseShape.extend(freeline_prototype);var label_prototype={getType:function(){return ShapeTypes.Label},init:function(b,e,a,d){var c=this;this._super(b,e,a,d);this.prepareExtPropDict(d);this.render();this.transFrame.addEventListener("boundarychange",function(f){var g=QStage.enhanceBoundary(f.newBoundary,true);c.shapeElement.setAttribute("x",g.left);c.shapeElement.setAttribute("y",g.bottom);c.shapeElement.setAttribute("font-size",g.height);c.shapeElement.setAttribute("textLength",g.width)})},prepareExtPropDict:function(a){this.addPropDictItem(a,{key:"text",value:"ABC",setter:function(b,c){b.shapeElement.textContent=c}});this.addPropDictItem(a,{key:"lengthAdjust",value:"spacingAndGlyphs",setter:function(b,c){b.shapeElement.setAttribute("lengthAdjust",c)},getOptions:function(){var b=[];b.push(["spacing","Spacing"]);b.push(["spacingAndGlyphs","SpacingAndGlyphs"]);return b}})},render:function(){var a=QStage.enhanceBoundary(this.transFrame.getBoundary(),true);this.shapeElement=this.svgGroup.createChildNS("text",{"data-label":"Label",fill:QStage.brushToRgba(this.prop("fill")),"class":"no-select",x:a.left,y:a.bottom,"font-size":a.height,textLength:a.width,lengthAdjust:this.prop("lengthAdjust")},this.prop("text"));this.renderComplete()}};var Label=BaseShape.extend(label_prototype);var line_prototype={getType:function(){return ShapeTypes.Line},init:function(b,e,a,d){var c=this;this._super(b,e,a,d);if(a==null){this.addPoint(e.boundary.left,e.boundary.top,null);this.addPoint(e.boundary.right,e.boundary.bottom,null)}this.render();this.transFrame.addEventListener("boundarychange",function(f){if(c.committed){return}var g=c.transFrame.getBoundary();c.anchorPoints[0].movePointTo(g.left,g.top,false,false);c.anchorPoints[1].movePointTo(g.right,g.bottom,false,true)})},render:function(){var a=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape",d:this.getPathData(false),fill:"none",stroke:QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width});this.ghostElement=this.svgGroup.createChildNS("path",{"data-label":"Ghost",d:this.getPathData(false),fill:"none",stroke:Config.Shape.ghostStroke,"stroke-width":Config.Shape.ghostWidth});var b=workspace.getEventManager(this.ghostElement).addListener("capture",function(d,c){if(workspace.painting.toolType==ToolTypes.Picker){a.transFrame.saveStatus()}}).addListener("drag",function(d,c){if(workspace.painting.toolType==ToolTypes.Picker){a.transFrame.move(c.begin.dx,c.begin.dy)}});this.renderComplete();this.transFrame.setProperty("nilWidthAccepted",true);this.transFrame.setProperty("nilHeightAccepted",true)}};var Line=BaseShape.extend(line_prototype);var polygon_prototype={getType:function(){return ShapeTypes.Polygon},init:function(b,e,a,d){var c=this;this._super(b,e,a,d);this.prepareExtPropDict(d);this.prop("closePath",true);if(a==null){this.addPoint(0,0,null);this.addPoint(0,0,null);this.addPoint(0,0,null);this.addPoint(0,0,null);this.addPoint(0,0,null)}this.render();this.transFrame.addEventListener("boundarychange",function(f){if(c.committed){return}c.alignPointsToBoundary(f.newBoundary)})},prepareExtPropDict:function(a){this.addPropDictItem(a,{key:"vertexNumber",value:5,setter:function(b,c){b.setVertexNumber(c)},getOptions:function(){var b=[];for(var c=3;c<=20;c++){b.push([c,c])}return b}})},setVertexNumber:function(d){if(this.anchorPoints.length==d){return}var c=Math.abs(d-this.anchorPoints.length);for(var b=0;b<c;b++){if(this.anchorPoints.length<d){this.addAndRenderPoint(0,0,false)}else{var a=this.anchorPoints.pop();a.svgGroup.parentNode.removeChild(a.svgGroup);a=null;delete a}}this.alignPointsToBoundary(this.transFrame.getBoundary())},render:function(){var a=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape",d:this.getPathData(false),fill:QStage.brushToRgba(this.prop("fill")),stroke:QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width});this.renderComplete()},alignPointsToBoundary:function(f){var e=QStage.enhanceBoundary(f,false);var c=this.getPointsOnBoundary(e,this.anchorPoints.length);for(var b=0;b<c.length;b++){var d=b==c.length-1;var a=c[b];this.anchorPoints[b].movePointTo(a.x,a.y,false,d)}},getPointOnCircle:function(c,k,b,a,f,j){var d=2*Math.PI/f;var e=-90/180*Math.PI;var h=d*j+e;var i=c+b*Math.cos(h);var g=k+a*Math.sin(h);return{x:i,y:g}},getPointsOnBoundary:function(a,g){var j=[];for(var f=0;f<g;f++){var e=a.cx;var d=a.cy;var c=a.rx;var b=a.ry;j.push(this.getPointOnCircle(e,d,c,b,g,f))}var h=QStage.enhanceBoundary(this.getPointBoundary(j));this.transformPointsToBoundary(j,this.transFrame.getPosition(),h,a);return j}};var Polygon=BaseShape.extend(polygon_prototype);var polyline_prototype={getType:function(){return ShapeTypes.Polyline},init:function(b,e,a,d){var c=this;this._super(b,e,a,d);if(d==null){this.prop("applyFill",false)}this.render()},render:function(){var a=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape",d:this.getPathData(false),fill:this.prop("applyFill")?QStage.brushToRgba(this.prop("fill")):"none",stroke:QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width});this.ghostElement=this.svgGroup.createChildNS("path",{"data-label":"Ghost",d:this.getPathData(false),fill:this.prop("applyFill")?Config.Shape.ghostFill:"none",stroke:Config.Shape.ghostStroke,"stroke-width":Config.Shape.ghostWidth});this.renderComplete();if(this.anchorPoints.length<=0){this.addAndRenderPoint(0,0,false)}}};var Polyline=BaseShape.extend(polyline_prototype);var rectangle_prototype={getType:function(){return ShapeTypes.Rectangle},init:function(b,e,a,d){var c=this;this._super(b,e,a,d);this.render();this.transFrame.addEventListener("boundarychange",function(f){c.shapeElement.setAttribute("d",c.getPath())})},getPath:function(){var b=QStage.enhanceBoundary(this.transFrame.getBoundary(),true);var a="";a+=QStage.buildPathCommand("M",[b.left,b.top]);a+=QStage.buildPathCommand("H",[b.right]);a+=QStage.buildPathCommand("V",[b.bottom]);a+=QStage.buildPathCommand("H",[b.left]);a+=QStage.buildPathCommand("Z");return a},render:function(){var a=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape",fill:QStage.brushToRgba(this.prop("fill")),stroke:QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width,d:this.getPath()});this.renderComplete()}};var Rectangle=BaseShape.extend(rectangle_prototype);function StartPage(a){this.workspace=a;this.wrapper=null;this.width=0;this.height=0}StartPage.prototype={renderInto:function(a,b,i){var e=this;this.wrapper=a;this.resize(b,i);var g=QStage.supportsTransitions();this.wrapper.style[g.prefixedProperty]="left 0.5s ease-in";this.wrapper.addEventListener(g.prefixedEventName,function(){});var h=this.wrapper.createChild("div",{"class":"title"});var c=h.createChild("div",{id:"app-icon"});this.renderAppIcon(c);var f=h.createChild("div",{id:"app-name"},"Stage On-The-Go");var d=this.wrapper.createChild("div",{"class":"menu"});this.renderMenuItem(d,0);this.renderMenuItem(d,1);this.renderMenuItem(d,2);this.renderMenuItem(d,3);this.wrapper.createChild("div",{"class":"footer"},"By QLike.com");return this.wrapper},resize:function(b,a){this.width=b;this.height=a;this.wrapper.updateStyle("width",b+"px");this.wrapper.updateStyle("height",a+"px")},setDisplay:function(c){this.wrapper.updateStyle("left",c?"0px":"-{0}px".format(this.width));this.workspace.stageWrapper.updateStyle("left",c?"{0}px".format(this.width):"0px");if(c){var b=document.querySelectorAll(".item-selected");for(var a=0;a<b.length;a++){b[a].removeClassName("item-selected")}}},openScene:function(b){var a=this;if(QStage.isValidId(b)){this.workspace.reset();QStage.setUrlHash("id",b);this.workspace.loadScene(b,function(c){a.setDisplay(false)})}else{this.workspace.reset();QStage.setUrlHash("id",b);this.setDisplay(false)}},renderMenuItem:function(d,b){var g=this;var k="";var h="";switch(b){case 0:k="New";h="New Scene";break;case 1:k="Retrieve";h="Retrieve from Server";break;case 2:k="Upload";h="Upload Scene File";break;case 3:k="Recent";h="Recent Scenes on Server";break}var l=d.createChild("div",{"class":"item","data-id":b});var j=l.createChild("div",{"class":"label no-select"},k);j.addEventListener("click",function(){var p=this.parentNode;var n=p.parentNode.childNodes;for(var o=0;o<n.length;o++){if(n[o].nodeType!=1){continue}if(n[o].hasClassName("item-selected")){n[o].removeClassName("item-selected")}else{if(n[o]==p){n[o].addClassName("item-selected")}}}if(p.getAttribute("data-id")=="3"){g.refreshSeceneList()}},false);var a=l.createChild("div",{"class":"sub"});a.createChild("div",{"class":"sub-label"},h);var f=a.createChild("div",{"class":"sub-content"});switch(b){case 0:var m=f.createChild("div",{"class":"sub-item",});m.createChild("div",{"class":"link"},"Create a new scene from scratch").addEventListener("click",function(){g.openScene("N")},false);break;case 1:var m=f.createChild("div",{"class":"sub-item",});var e=m.createChild("form",{action:QStage.getAppUrl()});var c=e.createChild("input",{type:"text","class":"text",placeholder:"Scene ID",name:"id"});var i=e.createChild("input",{type:"button","class":"button",value:"Retrieve"});i.addEventListener("click",function(){if(QStage.isValidId(c.value)){g.openScene(c.value)}},false);break;case 2:var m=f.createChild("form",{"class":"sub-item",action:"http://stage.qlike.com/repository/upload.php",method:"post",enctype:"multipart/form-data"});m.createChild("input",{type:"file","class":"file",name:"fileToUpload",id:"fileToUpload",placeholder:"Scene ID"});m.createChild("input",{type:"submit","class":"button",value:"Upload",name:"submit"});break;case 3:var m=f.createChild("div",{id:"secene-list",});break}},refreshSeceneList:function(){var c=this;var a=QStage.$("secene-list");while(a.childNodes.length>0){a.removeChild(a.firstChild)}a.createChild("div",{"class":"sub-item",},"Loading the list...");var b="http://stage.qlike.com/repository/?action=pull";QStage.sendPostRequest(b,null,function(g){try{while(a.childNodes.length>0){a.removeChild(a.firstChild)}var h=JSON.parse(g);for(var e=0;e<h.payload.length;e++){var d=a.createChild("div",{"class":"sub-item",});d.createChild("div",{"class":"link",title:h.payload[e].id,"data-id":h.payload[e].id},h.payload[e].id).addEventListener("click",function(){c.openScene(this.getAttribute("data-id"))},false)}if(h.payload.length<=0){a.createChild("div",{"class":"sub-item",},"No record")}}catch(f){console.log(f)}},function(d){console.log(d)})},renderAppIcon:function(f){var b=f.createChildNS("svg",{width:32,height:32});var c=b.createChildNS("g");var a=32;var e=a*10/300;var d="M{0},{1} H{2} L {3},{4} H {0} Z".format(a/3+e,e,a*2/3,a-e,a/3-e);c.createChildNS("path",{fill:"#22CB20",stroke:"#22CB20","stroke-width":e,"stroke-linejoin":"round",d:d});c.createChildNS("path",{fill:"#06ACD4",stroke:"#06ACD4","stroke-width":e,"stroke-linejoin":"round",d:d,transform:"translate(0,0), rotate({1},{0},{0})".format(a/2,1*90)});c.createChildNS("path",{fill:"#FFCC00",stroke:"#FFCC00","stroke-width":e,"stroke-linejoin":"round",d:d,transform:"translate(0,0), rotate({1},{0},{0})".format(a/2,2*90)});c.createChildNS("path",{fill:"#FA5151",stroke:"#FA5151","stroke-width":e,"stroke-linejoin":"round",d:d,transform:"translate(0,0), rotate({1},{0},{0})".format(a/2,3*90)});return b}};var transformable_frame_prototype={svgParent:null,position:null,boundary:null,rotation:null,renderred:null,enabled:null,savedStatus:null,properties:null,moveParent:null,handleCount:null,svgGroup:null,borderElement:null,handleElements:null,handleGhosts:null,eventHandlers:null,init:function(b,c,a){this.svgParent=b;this.position={x:QStage.alignToGrid(c.position.x),y:QStage.alignToGrid(c.position.y)};this.boundary={left:QStage.alignToGrid(c.boundary.left),top:QStage.alignToGrid(c.boundary.top),right:QStage.alignToGrid(c.boundary.right),bottom:QStage.alignToGrid(c.boundary.bottom)};this.rotation={cx:c.rotation.cx,cy:c.rotation.cy,angle:QStage.alignToGrid(c.rotation.angle)};this.moveParent=a;this.renderred=false;this.enabled=false;this.savedStatus={position:clone(this.position),boundary:clone(this.boundary),rotation:clone(this.rotation)};this.properties={movable:true,resizable:true,rotatable:true,borderColor:Config.FrameHandle.stroke,fillColor:"none",borderDashArray:Config.FrameHandle.borderDashArray,handleBorderColor:Config.FrameHandle.stroke,nilWidthAccepted:false,nilHeightAccepted:false};this.handleCount=9;this.svgGroup=null;this.borderElement=null;this.handleElements=[];this.handleGhosts=[];this.eventHandlers=[]},getBoundary:function(){return this.boundary},getPosition:function(){return this.position},getRotation:function(){return this.rotation},saveStatus:function(){var a=this.getPosition();var c=this.getBoundary();var b=this.getRotation();this.savedStatus={position:{x:a.x,y:a.y},boundary:{left:c.left,top:c.top,right:c.right,bottom:c.bottom},rotation:{cx:b.cx,cy:b.cy,angle:b.angle}}},addEventListener:function(a,b){this.eventHandlers.push({eventName:a,eventHandler:b})},triggerEvent:function(a,b){for(var c=0;c<this.eventHandlers.length;c++){var d=this.eventHandlers[c];if(d.eventName==a&&typeof d.eventHandler=="function"){d.eventHandler(b)}}},render:function(){var h=this;this.svgGroup=this.svgParent.createChildNS("g",{"data-label":"transformable-frame",display:"none"});var r=this.properties.fillColor;var b=this.properties.borderDashArray;var d=this.properties.borderColor;var e=this.properties.handleBorderColor;this.borderElement=this.svgGroup.createChildNS("path",{d:"",fill:r,"stroke-width":1,"stroke-dasharray":b,stroke:d});for(var f=0;f<=this.handleCount;f++){var j=parseInt(f/4);var o=f-j*4;var n=this.svgGroup.createChildNS("path",{d:"",fill:Config.FrameHandle.fill,"stroke-width":Config.FrameHandle.borderSize,stroke:e,"stroke-linecap":"butt","stroke-linejoin":"miter"});var g=this.svgGroup.createChildNS("path",{d:"",fill:Config.FrameHandle.ghostFill,"stroke-width":Config.FrameHandle.borderSize,stroke:Config.FrameHandle.ghostStroke,"data-type":j,"data-posIndex":o});workspace.getEventManager(g).addListener("capture",function(u,s){var t=parseInt(s.sender.getAttribute("data-type"));var i=parseInt(s.sender.getAttribute("data-posIndex"));h.captureHandle(t,i,true)}).addListener("release",function(u,s){var t=parseInt(s.sender.getAttribute("data-type"));var i=parseInt(s.sender.getAttribute("data-posIndex"));h.captureHandle(t,i,false)}).addListener("drag",function(s,i){h.processHandleDragging(s,i)});this.handleElements.push(n);this.handleGhosts.push(g)}var m=this.position.x;var l=this.position.y;this.position={x:null,y:null};this.moveTo(m,l,true);var c=this.boundary.left;var k=this.boundary.top;var q=this.boundary.right;var a=this.boundary.bottom;this.boundary={left:null,top:null,right:null,bottom:null};this.transformTo(c,k,q,a,true);this.renderred=true;for(var p in this.properties){this.setProperty(p,this.properties[p])}},captureHandle:function(b,a,c){if(c){this.saveStatus();this.selectHandle(b,a,true)}else{this.selectHandle(b,a,false)}},processHandleDragging:function(z,b){var j=this;var g=parseInt(b.sender.getAttribute("data-type"));var C=parseInt(b.sender.getAttribute("data-posIndex"));j.updateCursor(g,C);if(g==0||g==1){var d=0;var s=0;var k=0;var i=0;var B=j.getMappedOffset(b.begin,b.current);if(g==0){switch(C){case 0:d+=B.x;s+=B.y;break;case 1:s+=B.y;k+=B.x;break;case 2:k+=B.x;i+=B.y;break;case 3:d+=B.x;i+=B.y;break}}else{if(g==1){switch(C){case 0:s+=B.y;break;case 1:k+=B.x;break;case 2:i+=B.y;break;case 3:d+=B.x;break}}}var h=QStage.alignToGrid(j.savedStatus.boundary.left+d);var q=QStage.alignToGrid(j.savedStatus.boundary.top+s);var A=QStage.alignToGrid(j.savedStatus.boundary.right+k);var l=QStage.alignToGrid(j.savedStatus.boundary.bottom+i);j.transformTo(h,q,A,l,true)}else{switch(C){case 0:var p=QStage.alignToGrid(j.savedStatus.position.x+b.begin.dx);var n=QStage.alignToGrid(j.savedStatus.position.y+b.begin.dy);j.moveTo(p,n,true);break;case 1:var m=QStage.enhanceBoundary(j.boundary,false);j.validRotationCenter(m);var D=j.getPosition();var w=m.cx;var f=m.cy;var o=workspace.transformPoint({x:b.previous.x,y:b.previous.y});var u=m.cx;var c=m.top;var t=o.x-D.x;var a=o.y-D.y;var v=j.getDeltaAngle({x:w,y:f},{x:u,y:c},{x:t,y:a});var r=QStage.alignToGrid(v/Math.PI*180);j.rotateTo(r,w,f);break}}},validRotationCenter:function(b){if(this.rotation.angle%360!=0){if(this.rotation.cx!=b.cx||this.rotation.cy!=b.cy){if(b==null){b=QStage.enhanceBoundary(this.boundary)}var a={x:b.cx,y:b.cy};var d={x:this.rotation.cx,y:this.rotation.cy};var c=this.getRotationOffset(d.x,d.y,a.x,a.y,this.rotation.angle);this.rotation.cx=a.x;this.rotation.cy=a.y;this.move(c.x,c.y,false)}}},getMappedOffset:function(g,e){var h={x:e.x-g.x,y:e.y-g.y};var f=this.rotation.angle;if(f%360!=0){var d=Math.atan2(h.y,h.x)-(f/180*Math.PI);var a=Math.sqrt(Math.pow(h.y,2)+Math.pow(h.x,2));var c=a*Math.cos(d);var b=a*Math.sin(d);h={x:QStage.round(c),y:QStage.round(b)}}return h},getOriginalPoint:function(k,j){var g=this.rotation.angle;if(g%360==0){return{x:k,y:j}}var e={x:this.rotation.cx,y:this.rotation.cy};var a={x:k,y:j};g=g%360;var h=g/180*Math.PI;var i=h>Math.PI?-Math.cos(h):Math.cos(h);var f=Math.sqrt(Math.pow(a.x-e.x,2)+Math.pow(a.y-e.y,2));var b=0;if(a.y-e.y>0){b=Math.acos(i)+Math.atan((a.x-e.x)/(a.y-e.y))}else{if(a.y-e.y<0){b=Math.acos(i)+Math.atan((a.x-e.x)/(a.y-e.y))-Math.PI}else{return{x:QStage.round(e.x+Math.abs(a.x-e.x)*Math.cos(h)),y:QStage.round(e.y-Math.abs(a.x-e.x)*Math.sin(h))}}}if(h<Math.PI){return{x:QStage.round(e.x+f*Math.sin(b)),y:QStage.round(e.y+f*Math.cos(b))}}else{return{x:QStage.round(e.x-f*Math.sin(b)),y:QStage.round(e.y-f*Math.cos(b))}}},getDeltaAngle:function(e,d,c){var b=Math.atan2(d.x-e.x,d.y-e.y);var a=Math.atan2(c.x-e.x,c.y-e.y);return b-a},getRotationOffset:function(l,v,k,s,n){var o=n/180*Math.PI;var e=Math.cos(o);var j=k-l;var i=s-v;var m=Math.sqrt(Math.pow(j,2)+Math.pow(i,2));var w=Math.pow(m,2);var u,q,t,p,g,f;if(l==k){u=-2*Math.pow(m,2)*(l*e-k*e+k);q=-Math.pow(m*(v-s),2)+Math.pow(m,4)*Math.pow(e,2)+2*Math.pow(m,2)*e*(l-k)*k+Math.pow(m*k,2);t=(-u+Math.sqrt(Math.pow(u,2)-4*w*q))/(2*w);p=(-u-Math.sqrt(Math.pow(u,2)-4*w*q))/(2*w);g=(Math.pow(m,2)*e+(l-k)*(k-t))/(v-s)+s;f=(Math.pow(m,2)*e+(l-k)*(k-p))/(v-s)+s}else{u=-2*Math.pow(m,2)*(v*e-s*e+s);q=-Math.pow(m*(l-k),2)+Math.pow(m,4)*Math.pow(e,2)+2*Math.pow(m,2)*e*(v-s)*s+Math.pow(m*s,2);g=(-u+Math.sqrt(Math.pow(u,2)-4*w*q))/(2*w);f=(-u-Math.sqrt(Math.pow(u,2)-4*w*q))/(2*w);t=(Math.pow(m,2)*e+(v-s)*(s-g))/(l-k)+k;p=(Math.pow(m,2)*e+(v-s)*(s-f))/(l-k)+k}var x=this.getDeltaAngle({x:k,y:s},{x:l,y:v},{x:t,y:g})*Math.sin(o);var h=null;if(x>0){h={x:QStage.round(l-t),y:QStage.round(v-g)}}else{h={x:QStage.round(l-p),y:QStage.round(v-f)}}return h},getBorderPath:function(){var b=this.getBoundary();var c=b.left;var i=b.top;var j=b.right;var a=b.bottom;var h=c<j?0.5:-0.5;var e=i<a?0.5:-0.5;c=Math.round(c)-h;i=Math.round(i)-e;j=Math.round(j)+h;a=Math.round(a)+e;var g="";var f=(j-c)/2+c;g+="M {0},{1} ".format(f,i);g+="V {0} ".format(i);g+="H {0} ".format(j);g+="V {0} ".format(a);g+="H {0} ".format(c);g+="V {0} ".format(i);g+="H {0} ".format(f);if(this.properties.rotatable){g+="V {0} ".format(i-2*(a-i>0?Config.FrameHandle.length:-Config.FrameHandle.length))}return g},getHandlePath:function(g,C,s){var x=QStage.enhanceBoundary(this.boundary,false);var i=x.left;var o=x.top;var A=x.right;var k=x.bottom;var t=x.width;var p=x.height;var u,y,c,f;if(Config.FrameHandle.length*2>Math.abs(t)){u=Math.abs(t)/2;c=Config.FrameHandle.weight}else{if(s){u=Config.FrameHandle.length*2;c=Config.FrameHandle.weight*4}else{u=Config.FrameHandle.length;c=Config.FrameHandle.weight}}if(Config.FrameHandle.length*2>Math.abs(p)){y=Math.abs(p)/2;f=Config.FrameHandle.weight}else{if(s){y=Config.FrameHandle.length*2;f=Config.FrameHandle.weight*4}else{y=Config.FrameHandle.length;f=Config.FrameHandle.weight}}var B=t>0?u:-u;var m=p>0?y:-y;var j=t>0?c:-c;var z=p>0?f:-f;var w={l:[i-j/2,i+j/2,i+B/2+j/2],m:[(i+A)/2-B/2,(i+A)/2-j/2,(i+A)/2+j/2,(i+A)/2+B/2],r:[A-j/2-B/2,A-j/2,A+j/2]};var l={t:[o-z/2,o+z/2,o+m/2+z/2],m:[(o+k)/2-m/2,(o+k)/2-z/2,(o+k)/2+z/2,(o+k)/2+m/2],b:[k-z/2-m/2,k-z/2,k+z/2]};var b=t>0?0.5:-0.5;var a=p>0?0.5:-0.5;w.l[0]=Math.round(w.l[0])-b;w.l[1]=Math.round(w.l[1])-b;w.l[2]=Math.round(w.l[2])-b;w.m[0]=Math.round(w.m[0])-b;w.m[1]=Math.round(w.m[1])-b;w.m[2]=Math.round(w.m[2])+b;w.m[3]=Math.round(w.m[3])+b;w.r[0]=Math.round(w.r[0])+b;w.r[1]=Math.round(w.r[1])+b;w.r[2]=Math.round(w.r[2])+b;l.t[0]=Math.round(l.t[0])-a;l.t[1]=Math.round(l.t[1])-a;l.t[2]=Math.round(l.t[2])-a;l.m[0]=Math.round(l.m[0])-a;l.m[1]=Math.round(l.m[1])-a;l.m[2]=Math.round(l.m[2])+a;l.m[3]=Math.round(l.m[3])+a;l.b[0]=Math.round(l.b[0])+a;l.b[1]=Math.round(l.b[1])+a;l.b[2]=Math.round(l.b[2])+a;var q="";if(g==0){switch(C){case 0:q+=this.buildPathPattern("Mh0,v0 Hh2 Vv1 Hh1 Vv2 Hh0 Vv0 Z",w.l,l.t);break;case 1:q+=this.buildPathPattern("Mh2,v0 Vv2 Hh1 Vv1 Hh0 Vv0 Hh2 Z",w.r,l.t);break;case 2:q+=this.buildPathPattern("Mh2,v2 Hh0 Vv1 Hh1 Vv0 Hh2 Vv2 Z",w.r,l.b);break;case 3:q+=this.buildPathPattern("Mh0,v2 Vv0 Hh1 Vv1 Hh2 Vv2 Hh0 Z",w.l,l.b);break}}else{if(g==1){switch(C){case 0:q+=this.buildPathPattern("Mh0,v0 Hh3 Vv1 Hh0 Vv0 Z",w.m,l.t);break;case 1:q+=this.buildPathPattern("Mh2,v0 Vv3 Hh1 Vv0 Hh2 Z",w.r,l.m);break;case 2:q+=this.buildPathPattern("Mh3,v2 Hh0 Vv1 Hh3 Vv2 Z",w.m,l.b);break;case 3:q+=this.buildPathPattern("Mh0,v3 Vv0 Hh1 Vv3 Hh0 Z",w.l,l.m);break}}else{switch(C){case 0:q+=this.buildPathPattern("Mh1,v0 Hh2 Vv1 Hh3 Vv2 Hh2 Vv3 Hh1 Vv2 Hh0 Vv1 Hh1 Vv0 Z",w.m,l.m);break;case 1:var e=(i+A)/2;var d=o-2*(k>o?Config.FrameHandle.length:-Config.FrameHandle.length);var n=Config.FrameHandle.weight;if(s){n*=4}q+="M{0},{1} m-{2},0 a{2},{2} 0 1,0 {3},0 a{2},{2} 0 1,0 -{3},0".format(e,d,n,2*n);break}}}return q},buildPathPattern:function(b,a,d){var c=b;c=c.replace(/h0/g,a[0]);c=c.replace(/h1/g,a[1]);c=c.replace(/h2/g,a[2]);if(a.length>3){c=c.replace(/h3/g,a[3])}c=c.replace(/v0/g,d[0]);c=c.replace(/v1/g,d[1]);c=c.replace(/v2/g,d[2]);if(d.length>3){c=c.replace(/v3/g,d[3])}return c},transform:function(i,f,d,e,b){var c=QStage.alignToGrid(this.savedStatus.boundary.left+i);var g=QStage.alignToGrid(this.savedStatus.boundary.top+f);var h=QStage.alignToGrid(this.savedStatus.boundary.right+d);var a=QStage.alignToGrid(this.savedStatus.boundary.bottom+e);this.transformTo(c,g,h,a,b)},transformTo:function(c,g,j,b,a){if(c==j&&!this.properties.nilWidthAccepted){j++}if(g==b&&!this.properties.nilHeightAccepted){b++}if(this.boundary.left==c&&this.boundary.top==g&&this.boundary.right==j&&this.boundary.bottom==b){return}var e={left:this.boundary.left,top:this.boundary.top,right:this.boundary.right,bottom:this.boundary.bottom};this.boundary.left=c;this.boundary.top=g;this.boundary.right=j;this.boundary.bottom=b;if(a){this.triggerEvent("boundarychange",{oldBoundary:e,newBoundary:{left:c,top:g,right:j,bottom:b}})}this.borderElement.setAttribute("d",this.getBorderPath());for(var d=0;d<=this.handleCount;d++){var f=parseInt(d/4);var h=d-f*4;this.handleElements[d].setAttribute("d",this.getHandlePath(f,h,false));this.handleGhosts[d].setAttribute("d",this.getHandlePath(f,h,true))}},move:function(c,b,d){var a=QStage.alignToGrid(this.savedStatus.position.x+c);var e=QStage.alignToGrid(this.savedStatus.position.y+b);this.moveTo(a,e,d)},moveTo:function(a,d,c){if(this.position.x==a&&this.position.y==d){return}var b={x:this.position.x,y:this.position.y};this.position.x=a;this.position.y=d;if(c){this.triggerEvent("positionchange",{oldPosition:b,newPosition:{x:a,y:d}})}this.updateSvgTransform()},rotateTo:function(c,a,d){if(this.rotation.angle==c&&this.rotation.cx==a&&this.rotation.cy==d){return}var b={cx:this.rotation.cx,cy:this.rotation.cy,angle:this.rotation.angle};this.rotation={cx:a,cy:d,angle:c};this.triggerEvent("rotationchange",{oldRotation:b,newRotation:{cx:a,cy:d,angle:c}});this.updateSvgTransform()},updateSvgTransform:function(){var a="";a+=" translate({0}, {1})".format(this.position.x,this.position.y);if(this.rotation%360!=0){a+=" rotate({0}, {1}, {2})".format(this.rotation.angle,this.rotation.cx,this.rotation.cy)}if(this.moveParent){this.svgParent.setAttribute("transform",a)}else{this.svgGroup.setAttribute("transform",a)}},setProperty:function(c,e){this.properties[c]=e;if(this.renderred){switch(c){case"movable":var d=2;var a=0;this.setHandleShowing(d,a,e);break;case"resizable":for(var d=0;d<=1;d++){for(var a=0;a<=4;a++){this.setHandleShowing(d,a,e)}}break;case"rotatable":var d=2;var a=1;this.setHandleShowing(d,a,e);this.borderElement.setAttribute("d",this.getBorderPath());break;case"borderColor":this.borderElement.setAttribute("stroke",this.properties[c]);break;case"borderDashArray":this.borderElement.setAttribute("borderDashArray",this.properties[c]);break;case"handleBorderColor":for(var b=0;b<=this.handleCount;b++){this.handleElements[b].setAttribute("stroke",this.properties[c])}break}}},setEnabled:function(a){if(!this.renderred){return}this.enabled=a;this.svgGroup.updateStyle("display",a?"block":"none")},setHandlesShowing:function(a){if(!this.renderred){return}for(var c=0;c<=1;c++){for(var b=0;b<=4;b++){this.setHandleShowing(c,b,value)}}this.setHandleShowing(2,0,value);this.setHandleShowing(2,1,value)},setHandleShowing:function(d,c,a){if(!this.renderred){return}var b=d*4+c;this.handleElements[b].updateStyle("display",a?"block":"none");this.handleGhosts[b].updateStyle("display",a?"block":"none")},setBorderShowing:function(a){if(!this.renderred){return}this.borderElement.updateStyle("display",a?"block":"none")},selectHandle:function(e,b,d){var a=e*4+b;for(var c=0;c<=this.handleCount;c++){var f=this.handleElements[c];var g=this.handleGhosts[c];if(c==a){f.setAttribute("fill",d?Config.FrameHandle.capturedFill:Config.FrameHandle.fill);f.setAttribute("stroke",d?Config.FrameHandle.capturedStroke:Config.FrameHandle.stroke);if(d){this.updateCursor(e,b)}else{g.updateStyle("cursor","default")}}else{f.setAttribute("fill",d?Config.FrameHandle.highlightedFill:Config.FrameHandle.fill);f.setAttribute("stroke",d?Config.FrameHandle.highlightedStroke:Config.FrameHandle.stroke)}}},updateCursor:function(d,b){return;var f=this.handleGhosts[d*4+b];var e=f.getStyle("cursor");var c=this.boundary.width;var a=this.boundary.height;var g="default";if(d==0){switch(b){case 0:case 2:g=c*a>0?"se-resize":"ne-resize";break;case 1:case 3:g="ne-resize";break}}else{if(d==1){switch(b){case 0:case 2:g="s-resize";break;case 1:case 3:g="w-resize";break}}else{g="move"}}if(e!=g){f.updateStyle("cursor",g)}}};var TransformableFrame=Class.extend(transformable_frame_prototype);function Workspace(){this.painting=null;this.eventManager=null;this.drawingBoard=null;this.scaleplate=null;this.slidePane=null;this.objectManager=null;this.textPanel=null;this.promptDialog=null;this.startPage=null;this.width=0;this.height=0;this.stageWrapper=null;this.startWrapper=null;this.scrimWrapper=null;this.autoSaveInterval=null;this.init()}Workspace.prototype={init:function(){this.painting=new Painting(this);this.eventManager=new EventManager(this);this.drawingBoard=new DrawingBoard(this);this.scaleplate=new Scaleplate(this,0,0);this.slidePane=new SlidePane(this);this.objectManager=new ObjectManager(this);this.textPanel=new TextPanel(this);this.promptDialog=new PromptDialog(this)},reset:function(){this.drawingBoard.reset();this.slidePane.reset();this.painting.reset()},showStartPage:function(a){if(a){if(this.startPage==null){this.startPage=new StartPage(this);this.startPage.renderInto(this.startWrapper,this.width,this.height);this.stageWrapper.updateStyle("left","{0}px".format(this.width))}else{this.startPage.setDisplay(true)}}else{if(this.startPage!=null){this.startPage.setDisplay(false)}}},render:function(){var f=this;this.width=document.documentElement.clientWidth-2*Config.Workspace.margin;this.height=document.documentElement.clientHeight-2*Config.Workspace.margin;var a=document.body;this.stageWrapper=a.createChild("div",{id:"workspace"});this.startWrapper=a.createChild("div",{id:"start-page"});this.scrimWrapper=a.createChild("div",{"class":"scrim",style:"display: none"});var i=QStage.supportsTransitions();this.stageWrapper.style[i.prefixedProperty]="left 0.5s ease-in";this.stageWrapper.addEventListener(i.prefixedEventName,function(){});this.slidePane.renderIntoWorkspace();this.scaleplate.renderIntoWorkspace();this.drawingBoard.renderIntoWorkspace();this.objectManager.renderIntoWorkspace();this.textPanel.renderIntoWorkspace();this.promptDialog.renderIntoWorkspace();this.sizeChanged();this.painting.onShapeChanged=function(k){if(k!=null&&k.committed){f.slidePane.showPropertyMenu(k);f.painting.setFill(k.prop("fill").color,k.prop("fill").opacity);f.painting.setStroke(k.prop("stroke").color,k.prop("stroke").opacity,k.prop("stroke").width)}else{f.slidePane.showPropertyMenu(null)}if(k!=null){f.objectManager.selectShapes([k])}else{f.objectManager.selectShapes([])}};this.painting.onFillChanged=function(k,l){f.slidePane.setFill(k,l)};this.painting.onStrokeChanged=function(k,l,m){f.slidePane.setStroke(k,l,m)};this.painting.onShapeAppended=function(k){f.objectManager.appendShape(k)};this.painting.onShapeRemoved=function(k,l){f.objectManager.removeShape(k,l)};this.painting.onShapeSorted=function(k,m,l){f.objectManager.sortShape(k,m,l)};this.painting.onToolChanged=function(k,l){f.slidePane.selectToolType(l);if(l==ToolTypes.Pen&&f.painting.selectedShape!=null&&f.painting.selectedShape.isPathShape()){f.painting.selectedShape.switchPathEditing(true);f.slidePane.showPropertyMenu(null)}else{this.selectShape(null)}if(k==ToolTypes.Crop){f.drawingBoard.canvasFrame.setEnabled(false)}if(l==ToolTypes.Crop){f.drawingBoard.canvasFrame.setEnabled(true)}};this.painting.onSceneChanged=function(){f.autoSave()};this.drawingBoard.onBoardMoved=function(k,l){f.scaleplate.changeOffset(k,l)};this.drawingBoard.onCaptured=function(){f.slidePane.selectMenuItem(null)};this.slidePane.fillMenu.onColorChanged=function(l,m,n){var k=f.painting.selectedShape;if(k!=null){k.prop("fill",{color:l,opacity:m})}f.painting.setFill(l,m)};this.slidePane.strokeMenu.onColorChanged=function(l,m,n){var k=f.painting.selectedShape;if(k!=null){k.prop("stroke",{color:l,opacity:m,width:n})}f.painting.setStroke(l,m,n)};function b(){var l=document.documentElement.clientWidth-2*Config.Workspace.margin;var k=document.documentElement.clientHeight-2*Config.Workspace.margin;if(l!=f.width||k!=f.height){f.width=l;f.height=k;f.sizeChanged()}}setInterval(b,200);var c=QStage.getQueryStringByName("animation");if(c!=null&&c>0){if(c>10){c=10}var e=this.drawingBoard.underGroup;var j=this.drawingBoard.svgSize.width;var d=this.drawingBoard.svgSize.height;function h(){g.addIcon();if(g.icons.length<c){setTimeout(h,1000)}}var g=new Stage(e,j,d);h();this.slidePane.wrapper.updateStyle("display","none")}this.autoLoad()},saveToCache:function(){var b=this.painting.serialize("JSON");var a=QCache.set(Config.LocalStorage.autoSaveKey,b);this.clearAutoSaveInterval();return a},clearAutoSaveInterval:function(){if(this.autoSaveInterval!=null){clearInterval(this.autoSaveInterval);this.autoSaveInterval=null}},getWrapper:function(){return this.stageWrapper},isSmallScreen:function(){return this.width<=480||this.height<=480},isLandscape:function(){return this.width>this.height},switchDeveloperMode:function(b){if(Config.General.developerMode==b){return}Config.General.developerMode=b;var a=b?null:"none";QStage.$("hidden_map_tools").updateStyle("display",a);QStage.$("hidden_sample_menu").updateStyle("display",a)},sizeChanged:function(){this.stageWrapper.updateStyle("width",this.width);this.stageWrapper.updateStyle("height",this.height);this.stageWrapper.updateStyle("margin","{0}px 0px 0px {0}px".format(Config.Workspace.margin));if(this.startPage!=null){this.startPage.resize(this.width,this.height)}this.textPanel.resize(this.width,this.height);this.promptDialog.resize(this.width,this.height);var a=this.width-Config.ObjectManager.marginRight-Config.ObjectManager.width;this.objectManager.moveWindowTo(a,Config.ObjectManager.marginTop);this.resizeDrawingBoard(this.width,this.height);this.scaleplate.resize(this.width,this.height);this.slidePane.resize(this.width,this.height);if(this.scrimWrapper!=null){this.scrimWrapper.updateStyle("width",this.width+"px");this.scrimWrapper.updateStyle("height",this.height+"px");this.scrimWrapper.updateStyle("padding-top",this.height/2+"px")}},resizeDrawingBoard:function(d,e){var a=Config.General.showScale?Config.Scaleplate.size:0;var b=d-a;var c=e-a;this.drawingBoard.resize(b,c)},transformPoint:function(a){return this.drawingBoard.transformPoint(a)},showGhost:function(a){return this.drawingBoard.showGhost(a)},getEventManager:function(a){return this.eventManager.getRegistration(a)},selectShapeById:function(a){this.painting.selectShapeById(a)},showScalePlate:function(a){this.scaleplate.setShowing(a);this.resizeDrawingBoard(this.width,this.height);var b=Config.General.showScale?Config.Scaleplate.size:0;this.slidePane.setMargin(b,b)},showScrim:function(a,b){this.scrimWrapper.updateStyle("display",a?null:"none");if(b!=null){this.scrimWrapper.textContent=b}else{this.scrimWrapper.textContent=""}},autoSave:function(){var b=new Date().getTime();return;var a=this;this.clearAutoSaveInterval();this.autoSaveInterval=setInterval(function(){console.log("Auto saved by interval("+a.autoSaveInterval+") at ",(new Date()).Format("hh:mm:ss.S"));a.saveToCache()},1000)},loadScene:function(c,b){var a=this;this.showScrim(true,"Loading... Please Wait...");this.loadFromServer(c,function(d){if(d!=null){console.log("loaded from server");a.painting.deserialize(d,"JSON");if(typeof b=="function"){b(true)}}else{console.log("nothing loaded from server");if(typeof b=="function"){b(false)}}a.showScrim(false)})},autoLoad:function(d){var b=this;var a=QStage.getUrlHash("id");if(QStage.isValidId(a)){this.loadScene(a)}return;var a=QStage.getQueryStringByName("id");b.painting.sceneId=a;var c=QCache.get(Config.LocalStorage.autoSaveKey);if(c!=null&&c.sceneId==a){this.painting.deserialize(c,"JSON")}else{if(QStage.isValidId(a)){this.showScrim(true,"Loading... Please Wait...");this.loadFromServer(a,function(e){b.painting.sceneId=a;if(e!=null){console.log("loaded from server");b.painting.deserialize(e,"JSON")}else{console.log("nothing loaded from server")}b.showScrim(false)})}}return},loadFromServer:function(f,e){var c=this;var b=new XMLHttpRequest();var a="http://stage.qlike.com/repository/?action=pull";var d="id="+f;b.onreadystatechange=function(){if(b.readyState==4){if(typeof e=="function"){if(b.status==200){try{var i=JSON.parse(b.responseText);if(i.payload.length>0){var h=i.payload[0].json_string;e(JSON.parse(h))}else{e(null)}}catch(g){console.log(b.responseText);e(null)}}else{e(null)}}}};b.open("POST",a,true);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send(d)},sendToServer:function(g){var d=this;this.showScrim(true,"Sending to server...");var b=new XMLHttpRequest();var a="http://stage.qlike.com/repository/";var c=QStage.getUrlHash("id");if(QStage.isValidId(c)){a+="?action=push&id="+c}else{a+="?action=push"}var f="payload="+this.painting.serialize("STRING");function e(h){if(h!=null&&h.id&&h.rows>0){if(typeof g=="function"){g(h.id)}}else{g(null)}d.showScrim(false);d.painting.modified=false}b.onreadystatechange=function(){if(b.readyState==4){if(b.status==200){var h=JSON.parse(b.responseText);e(h)}else{e(null)}}};b.open("POST",a,true);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send(f)},needToBeSaved:function(){var a=QStage.getUrlHash("id");return !QStage.isValidId(a)||this.painting.modified}};var workspace=null;addEventListener("load",function(){workspace=new Workspace();workspace.render();var a=QStage.getUrlHash("id");if(a==null){workspace.showStartPage(true)}});